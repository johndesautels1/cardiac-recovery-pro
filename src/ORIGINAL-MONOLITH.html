<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0e1a">
    <meta name="description" content="Professional cardiac recovery tracking system with real-time monitoring, progress analytics, and evidence-based exercise protocols">
    <title>Cardiac Recovery Pro - Complete System</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNhcmRpYWMgUmVjb3ZlcnkgUHJvIC0gQ29tcGxldGUgU3lzdGVtIiwKICAic2hvcnRfbmFtZSI6ICJDYXJKAWFJIFBYBYISCIAGINN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBhMGUxYSIsCiAgInRoZW1lX2NvbG9yIjogIiMwYTBlMWEiLAogICJvcmllbnRhdGlvbiI6ICJhbnkiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBeE5UWWdNVFUySWo0OGNtVmpkQ0IzYVdSMGFEMGlNVFUySWlCb1pXbG5hSFE5SWpFMU5pSWdabWxzYkQwaUl6QXdPRFppWkNJdlBqeDBaWGgwSUhnOUlqYzRJaUI1UFNJNE1DSWdabWxzYkQwaUkzWnBiR1YwSWlCbWIyNTBMWE5wZW1VOUlqWXdJaUIwWlhoMExXRnVZMmh2Y2owaWJXbGtaR3hsSWo0OGRITndZVzQrUUVaV1IwSTJPakB4UEhOMFlXZGxJSEJ2YVc1MGN6MGlNQ3d3SURBc01DQXdMREFpSUdacGJHdzlJaU13TUdJMlpHUWlMejQ4TDNOMllqNGksCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQTFNVElnTlRFeUlqNDhjbVZqZENCM2FXUjBhRDBpTlRFeUlpQm9aV2xuYUhROUlqVXhNaUlnWm1sc2JEMGlJekF3T0RaaVpDSXZQangwWlhoMElIZzlJakkxTmlJZ2VUMGlNalUySWlCbWFXeHNQU0lqZG1sc1pYUWlJR1p2Ym5RdGMybDZaVDBpTVRBd0lpQjBaWGgwTFdGdVkyaHZjajBpYldsa1pHeGxJajQ4ZEhOd1lXNCtRRVpXUjBJMk9qQThMM1J6Y0dGdVBqd3ZkR1Y0ZEQ0OGMzUmhaMlVnY0c5cGJuUnpQU0l3TERBZ01Dd3dJREFzTUNJZ1ptbHNiRDBpSXpBd1lqWmtaQ0l2UGp3dmMzWm5QZz09IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0KfQ==">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0a0e1a;
            --card: #111827;
            --card-light: #1a2332;
            --ink: #e5e7eb;
            --muted: #9ca3af;
            --accent: #60a5fa;
            --good: #22c55e;
            --warn: #f59e0b;
            --bad: #ef4444;
            --purple: #a78bfa;
            --cyan: #06b6d4;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--ink);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--card), var(--card-light));
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            border: 2px solid rgba(96,165,250,0.2);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--purple), var(--cyan));
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 900;
            text-align: center;
            background: linear-gradient(135deg, var(--cyan), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            color: var(--cyan);
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            margin-top: 10px;
        }

        /* CALENDAR NAVIGATION */
        .calendar-nav {
            background: var(--card-light);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid rgba(96,165,250,0.2);
        }

        .calendar-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .date-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--cyan);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(96,165,250,0.4);
        }

        .recovery-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(6,182,212,0.1);
            border-radius: 8px;
            border-left: 4px solid var(--cyan);
        }

        /* BASELINE SETUP */
        .baseline-section {
            background: linear-gradient(135deg, rgba(167,139,250,0.1), rgba(96,165,250,0.1));
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 3px solid var(--purple);
        }

        .baseline-section h2 {
            color: var(--purple);
            font-size: 1.8rem;
            margin-bottom: 20px;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-button {
            padding: 16px 28px;
            font-size: 1.1rem;
            font-weight: 700;
            background: var(--card);
            color: var(--ink);
            border: 2px solid var(--accent);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .tab-button:hover {
            background: var(--accent);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(96,165,250,0.4);
        }

        .tab-button.active {
            background: linear-gradient(135deg, var(--accent), var(--purple));
            color: white;
            border-color: var(--purple);
            box-shadow: 0 8px 25px rgba(96,165,250,0.5);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--card-light), var(--card));
            border-radius: 16px;
            padding: 30px;
            border: 2px solid rgba(96,165,250,0.2);
            transition: all 0.3s ease;
            text-align: center;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(96,165,250,0.3);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--cyan), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--muted);
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-trend {
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stat-trend.up {
            color: var(--good);
        }

        .stat-trend.down {
            color: var(--bad);
        }

        /* SECTIONS */
        .section {
            background: var(--card);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            border: 2px solid rgba(96,165,250,0.15);
        }

        .section:hover {
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(96,165,250,0.3);
            transform: translateY(-4px);
        }

        .section h2 {
            font-size: 1.8rem;
            color: var(--cyan);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--cyan);
            font-weight: 800;
        }

        /* METRIC ENTRY */
        .metric-entry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-field {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(96,165,250,0.2);
        }

        .metric-field label {
            display: block;
            color: var(--accent);
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-help {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 8px;
            font-style: italic;
        }

        .metric-field input, .metric-field select, .metric-field textarea {
            width: 100%;
            padding: 14px 16px;
            background: #ffffff;
            border: 3px solid var(--accent);
            color: #1a1a1a;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            min-height: 50px;
        }

        .metric-field input:focus {
            outline: none;
            border-color: var(--cyan);
            box-shadow: 0 0 0 4px rgba(6,182,212,0.3);
        }

        .metric-field input.warning {
            border-color: var(--warn) !important;
            background: rgba(245,158,11,0.1) !important;
        }

        .metric-field input.error {
            border-color: var(--bad) !important;
            background: rgba(239,68,68,0.1) !important;
        }

        .metric-warning {
            display: none;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(245,158,11,0.1);
            border-left: 4px solid var(--warn);
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--warn);
            font-weight: 600;
        }

        .metric-warning.show {
            display: block;
        }

        .metric-error {
            display: none;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(239,68,68,0.1);
            border-left: 4px solid var(--bad);
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--bad);
            font-weight: 700;
        }

        .metric-error.show {
            display: block;
        }

        .metric-reference {
            margin-top: 8px;
            padding: 8px;
            background: rgba(34,197,94,0.1);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--good);
        }

        /* CHARTS */
        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid rgba(96,165,250,0.2);
        }

        .chart-container canvas {
            max-height: 500px;
        }

        /* COMPARISON GRID */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .comparison-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            border: 2px solid rgba(96,165,250,0.2);
        }

        .comparison-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--cyan);
            margin-bottom: 15px;
            text-align: center;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(96,165,250,0.08);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .metric-name {
            font-weight: 600;
            color: var(--ink);
        }

        .metric-value {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .metric-value.good {
            color: var(--good);
        }

        /* LEGEND */
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding: 15px;
            background: rgba(96,165,250,0.05);
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* VIDEO LIBRARY */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .video-card {
            background: var(--card-light);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(96,165,250,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .video-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(96,165,250,0.3);
        }

        .video-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #1a1a2e;
        }

        .video-thumbnail::before,
        .video-thumbnail::after {
            content: '';
            position: absolute;
            border-radius: 50%;
        }

        /* Week 1: Chair - Seated Exercise */
        .thumb-chair {
            background: linear-gradient(135deg, #2d3561 0%, #1a1a2e 100%);
        }
        .thumb-chair::before {
            width: 80px;
            height: 100px;
            background: #60a5fa;
            border-radius: 8px 8px 0 0;
            top: 50px;
        }
        .thumb-chair::after {
            width: 120px;
            height: 60px;
            background: #3b82f6;
            border-radius: 8px;
            top: 100px;
            box-shadow: 0 -20px 0 #60a5fa;
        }

        /* Week 2: Chair - Beginner */
        .thumb-chair-2 {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f1e3a 100%);
        }
        .thumb-chair-2::before {
            width: 90px;
            height: 110px;
            background: linear-gradient(180deg, #93c5fd 0%, #60a5fa 100%);
            border-radius: 12px 12px 4px 4px;
            top: 45px;
            box-shadow: 0 8px 20px rgba(96, 165, 250, 0.4);
        }
        .thumb-chair-2::after {
            width: 110px;
            height: 50px;
            background: #3b82f6;
            border-radius: 6px;
            bottom: 45px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.5);
        }

        /* Week 3: Walking */
        .thumb-walk {
            background: linear-gradient(135deg, #1a3a1a 0%, #0d1f0d 100%);
        }
        .thumb-walk::before {
            width: 70px;
            height: 120px;
            background: linear-gradient(180deg, #86efac 0%, #22c55e 100%);
            border-radius: 35px 35px 10px 10px;
            top: 40px;
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.5);
        }
        .thumb-walk::after {
            width: 25px;
            height: 50px;
            background: #16a34a;
            border-radius: 15px;
            bottom: 30px;
            left: calc(50% - 35px);
            box-shadow: 35px 0 0 #16a34a;
        }

        /* Week 4: Heart Rate / Cardio */
        .thumb-cardio {
            background: linear-gradient(135deg, #3d1a1a 0%, #2d0d0d 100%);
        }
        .thumb-cardio::before {
            width: 100px;
            height: 90px;
            background: #fca5a5;
            clip-path: polygon(50% 20%, 85% 0%, 100% 25%, 100% 60%, 50% 100%, 0% 60%, 0% 25%, 15% 0%);
            top: 55px;
            animation: heartbeat 1.5s ease-in-out infinite;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.6);
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1); }
        }

        /* Week 5: Standing Exercise */
        .thumb-walk-2 {
            background: linear-gradient(135deg, #1f3d1f 0%, #0f1e0f 100%);
        }
        .thumb-walk-2::before {
            width: 60px;
            height: 130px;
            background: linear-gradient(180deg, #a7f3d0 0%, #34d399 100%);
            border-radius: 30px 30px 8px 8px;
            top: 35px;
            box-shadow: 0 10px 30px rgba(52, 211, 153, 0.5);
        }
        .thumb-walk-2::after {
            width: 80px;
            height: 8px;
            background: #10b981;
            border-radius: 4px;
            bottom: 35px;
            box-shadow: 0 -5px 0 #059669;
        }

        /* Week 6: Treadmill */
        .thumb-treadmill {
            background: linear-gradient(135deg, #3d2a1a 0%, #2d1a0d 100%);
        }
        .thumb-treadmill::before {
            width: 140px;
            height: 100px;
            background: linear-gradient(135deg, #fcd34d 0%, #f59e0b 100%);
            border-radius: 15px;
            top: 50px;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5);
        }
        .thumb-treadmill::after {
            width: 120px;
            height: 15px;
            background: #d97706;
            border-radius: 8px;
            bottom: 35px;
            box-shadow: 0 -3px 0 #b45309, 0 -6px 0 #92400e;
        }

        /* Week 7: Strength Training */
        .thumb-strength {
            background: linear-gradient(135deg, #3d2616 0%, #2d1a0d 100%);
        }
        .thumb-strength::before {
            width: 30px;
            height: 80px;
            background: linear-gradient(180deg, #fdba74 0%, #f97316 100%);
            border-radius: 15px;
            top: 60px;
            box-shadow: 90px 0 0 #f97316, 0 8px 20px rgba(249, 115, 22, 0.5), 90px 8px 20px rgba(249, 115, 22, 0.5);
        }
        .thumb-strength::after {
            width: 120px;
            height: 25px;
            background: #ea580c;
            border-radius: 12px;
            top: 93px;
            box-shadow: 0 5px 15px rgba(234, 88, 12, 0.6);
        }

        /* Week 8: Cycling */
        .thumb-bike {
            background: linear-gradient(135deg, #2d1f3d 0%, #1a0f2d 100%);
        }
        .thumb-bike::before {
            width: 70px;
            height: 70px;
            background: transparent;
            border: 12px solid #a78bfa;
            top: 65px;
            left: calc(50% - 90px);
            box-shadow: 90px 0 0 0 #a78bfa, 0 0 20px rgba(167, 139, 250, 0.5), 90px 0 20px rgba(167, 139, 250, 0.5);
        }
        .thumb-bike::after {
            width: 80px;
            height: 15px;
            background: #8b5cf6;
            border-radius: 8px;
            top: 85px;
            transform: rotate(-15deg);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.5);
        }

        /* Week 9: Advanced Strength */
        .thumb-strength-2 {
            background: linear-gradient(135deg, #3d1f16 0%, #2d120d 100%);
        }
        .thumb-strength-2::before {
            width: 35px;
            height: 90px;
            background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 17px;
            top: 55px;
            box-shadow: 100px 0 0 #f59e0b, 0 10px 25px rgba(245, 158, 11, 0.6), 100px 10px 25px rgba(245, 158, 11, 0.6);
        }
        .thumb-strength-2::after {
            width: 130px;
            height: 30px;
            background: #d97706;
            border-radius: 15px;
            top: 93px;
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.7);
        }

        /* Week 10: Elliptical / Circuit */
        .thumb-elliptical {
            background: linear-gradient(135deg, #2a1f3d 0%, #1a0f2d 100%);
        }
        .thumb-elliptical::before {
            width: 110px;
            height: 90px;
            background: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 100%);
            border-radius: 55px 55px 20px 20px;
            top: 55px;
            box-shadow: 0 10px 30px rgba(167, 139, 250, 0.6);
        }
        .thumb-elliptical::after {
            width: 70px;
            height: 70px;
            background: transparent;
            border: 10px solid #8b5cf6;
            border-radius: 50%;
            bottom: 40px;
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.5);
        }

        /* Week 11: Advanced Cardio */
        .thumb-advanced {
            background: linear-gradient(135deg, #3d1a2d 0%, #2d0d1a 100%);
        }
        .thumb-advanced::before {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #fda4af 0%, #f43f5e 50%, #be123c 100%);
            clip-path: polygon(50% 0%, 70% 30%, 100% 35%, 75% 60%, 80% 100%, 50% 75%, 20% 100%, 25% 60%, 0% 35%, 30% 30%);
            top: 50px;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(244, 63, 94, 0.8);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.9; }
        }

        /* Week 12: Recovery Complete */
        .thumb-recovery {
            background: linear-gradient(135deg, #1a3d2a 0%, #0d2d1a 100%);
        }
        .thumb-recovery::before {
            width: 120px;
            height: 120px;
            background: transparent;
            border: 15px solid #34d399;
            border-radius: 50%;
            top: 40px;
            box-shadow: 0 0 30px rgba(52, 211, 153, 0.6), inset 0 0 30px rgba(52, 211, 153, 0.3);
        }
        .thumb-recovery::after {
            width: 50px;
            height: 30px;
            background: transparent;
            border-left: 12px solid #10b981;
            border-bottom: 12px solid #10b981;
            top: 85px;
            transform: rotate(-45deg);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.7);
        }

        .video-info {
            padding: 20px;
        }

        .video-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--ink);
            margin-bottom: 8px;
        }

        .video-meta {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .video-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .video-badge.week {
            background: var(--accent);
            color: white;
        }

        .video-badge.difficulty {
            background: var(--purple);
            color: white;
        }

        /* BUTTONS */
        button, .btn {
            background: linear-gradient(135deg, var(--accent), var(--purple));
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 52px;
        }

        button:hover, .btn:hover {
            background: linear-gradient(135deg, var(--cyan), var(--purple));
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(6,182,212,0.4);
        }

        .btn-good {
            background: linear-gradient(135deg, var(--good), #16a34a);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--bad), #dc2626);
        }

        /* DATA TABLE */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(96,165,250,0.2);
        }

        .data-table th {
            background: rgba(96,165,250,0.1);
            font-weight: 700;
            color: var(--accent);
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .data-table th:first-child,
        .data-table td:first-child {
            position: sticky;
            left: 0;
            background: var(--card);
            z-index: 5;
        }

        .data-table th:first-child {
            z-index: 15;
            background: rgba(96,165,250,0.1);
        }

        .data-table td {
            white-space: nowrap;
        }

        .data-table tr:hover {
            background: rgba(96,165,250,0.05);
        }

        .data-table tr:hover td:first-child {
            background: rgba(96,165,250,0.1);
        }

        .delete-entry-btn {
            padding: 6px 12px;
            background: var(--bad);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 600;
        }

        /* AUTOCOMPLETE */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 3px solid var(--accent);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-suggestions.show {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 20px;
            color: #1a1a1a;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .autocomplete-item:hover {
            background: var(--accent);
            color: white;
        }

        /* NOTIFICATION */
        /* ACCESSIBILITY */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Skip to main content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 100000;
            border-radius: 0 0 8px 0;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Focus visible styles for keyboard navigation */
        *:focus-visible {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 30px;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--good);
        }

        .notification.error {
            background: var(--bad);
        }

        /* CLINICAL ALERT MODAL */
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }

        .alert-modal.show {
            display: flex;
        }

        .alert-modal-content {
            background: linear-gradient(135deg, #1a1a1a, #2a1a1a);
            border: 4px solid var(--bad);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            box-shadow: 0 30px 90px rgba(239,68,68,0.6);
            animation: alertPulse 0.5s ease-in-out;
        }

        @keyframes alertPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .alert-icon {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 20px;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        .alert-title {
            font-size: 2rem;
            font-weight: 900;
            color: var(--bad);
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .alert-message {
            font-size: 1.2rem;
            color: var(--ink);
            margin-bottom: 30px;
            line-height: 1.8;
            text-align: center;
        }

        .alert-details {
            background: rgba(239,68,68,0.1);
            border-left: 4px solid var(--bad);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .alert-detail-item {
            font-size: 1rem;
            color: var(--bad);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .alert-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .alert-btn-danger {
            background: linear-gradient(135deg, var(--bad), #dc2626);
            color: white;
            padding: 16px 40px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alert-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(239,68,68,0.5);
        }

        .alert-btn-secondary {
            background: var(--card-light);
            color: var(--ink);
            padding: 16px 40px;
            border: 2px solid var(--accent);
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alert-btn-secondary:hover {
            background: var(--accent);
            color: white;
        }

        /* RESPONSIVE */
        /* MOBILE & TOUCH OPTIMIZATIONS */
        @media (max-width: 768px) {
            /* Typography - larger on mobile for readability */
            .header h1 { font-size: 2rem; }
            body { font-size: 16px; }

            /* Welcome message - stack on mobile */
            #welcomeMessage {
                font-size: 0.9rem !important;
                text-align: center !important;
                margin-top: 8px;
            }

            .header > div:first-child {
                flex-direction: column !important;
            }

            .header > div:first-child > div {
                flex: none !important;
            }

            /* Layout - single column on mobile */
            .stats-grid { grid-template-columns: 1fr; }
            .comparison-grid { grid-template-columns: 1fr; }
            .metric-grid { grid-template-columns: 1fr; }

            /* Touch targets - minimum 44x44px (Apple HIG) */
            button, .btn {
                min-height: 54px;
                min-width: 54px;
                padding: 18px 36px;
                font-size: 1.15rem;
                margin: 8px 0;
            }

            /* Tab buttons - easier to tap */
            .tab-button {
                min-height: 54px;
                padding: 16px 20px;
                font-size: 1rem;
            }

            /* Input fields - larger touch targets */
            .metric-field input,
            .metric-field select,
            .metric-field textarea {
                min-height: 54px;
                padding: 18px 20px;
                font-size: 1.15rem;
            }

            /* Delete button in table - larger for touch */
            .delete-entry-btn {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 16px;
                font-size: 1rem;
            }

            /* Date navigation - larger touch area */
            .date-nav button {
                min-height: 54px;
                min-width: 54px;
                padding: 16px;
                font-size: 1.3rem;
            }

            /* Spacing - more room between elements */
            .section {
                padding: 24px 16px;
                margin-bottom: 24px;
            }

            .metric-field {
                margin-bottom: 24px;
            }

            /* Charts - responsive sizing */
            canvas {
                max-height: 300px;
            }

            /* Tables - scrollable on mobile */
            .data-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .data-table td,
            .data-table th {
                padding: 14px 10px;
                font-size: 0.95rem;
            }

            /* Video cards - larger touch areas */
            .video-card {
                min-height: 100px;
            }

            /* Container padding */
            .container {
                padding: 12px;
            }

            /* Alert modal - full width on mobile */
            .alert-modal-content {
                width: 95%;
                margin: 20px auto;
            }

            /* Alert buttons - stack vertically */
            .alert-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .alert-btn-danger,
            .alert-btn-secondary {
                width: 100%;
                min-height: 54px;
            }
        }

        /* Touch-specific enhancements (all devices) */
        @media (hover: none) and (pointer: coarse) {
            /* Active states for touch feedback */
            button:active, .btn:active {
                transform: scale(0.97);
                opacity: 0.9;
            }

            .tab-button:active {
                transform: scale(0.98);
            }

            .video-card:active {
                transform: scale(0.99);
                opacity: 0.95;
            }

            /* Remove hover effects on touch devices */
            button:hover, .btn:hover {
                transform: none;
                box-shadow: none;
            }

            .tab-button:hover {
                transform: none;
            }
        }

        /* Prevent text selection on buttons */
        button, .btn, .tab-button, .delete-entry-btn {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation; /* Prevents double-tap zoom */
        }

        /* TABLET-SPECIFIC LAYOUTS (768px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 900px;
                padding: 20px;
            }

            /* Two-column layouts for tablets */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            .comparison-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .metric-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Tab navigation - two rows on tablet */
            .tabs {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }

            .tab-button {
                font-size: 0.95rem;
                padding: 14px 16px;
            }

            /* Calendar controls - optimized spacing */
            .calendar-controls {
                gap: 15px;
            }

            /* Video cards - 2 columns */
            .video-section {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            /* Charts - medium size */
            canvas {
                max-height: 400px;
            }

            /* Buttons - tablet-friendly size */
            button, .btn {
                min-height: 48px;
                padding: 14px 28px;
                font-size: 1.05rem;
            }
        }

        /* LANDSCAPE ORIENTATION OPTIMIZATIONS */
        @media (max-width: 768px) and (orientation: landscape) {
            /* Reduce vertical padding in landscape */
            .header {
                padding: 20px 30px;
                margin-bottom: 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .header .subtitle {
                font-size: 1rem;
                margin-top: 5px;
            }

            /* Calendar navigation - more compact */
            .calendar-nav {
                padding: 15px 20px;
                margin-bottom: 15px;
            }

            .date-display {
                font-size: 1.2rem;
            }

            /* Tabs - horizontal scroll with smaller buttons */
            .tabs {
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 5px;
            }

            .tab-button {
                display: inline-block;
                min-height: 44px;
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            /* Sections - reduced padding */
            .section {
                padding: 15px 12px;
                margin-bottom: 15px;
            }

            /* Make better use of horizontal space */
            .stats-grid,
            .comparison-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .metric-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            /* Input fields - smaller in landscape */
            .metric-field input,
            .metric-field select,
            .metric-field textarea {
                min-height: 44px;
                padding: 12px 14px;
                font-size: 1rem;
            }

            /* Buttons - more compact */
            button, .btn {
                min-height: 44px;
                padding: 12px 24px;
                font-size: 1rem;
            }

            /* Container - use full width */
            .container {
                padding: 10px;
            }

            /* Charts - smaller in landscape */
            canvas {
                max-height: 220px;
            }

            /* Video embeds - 16:9 aspect ratio maintained */
            .video-card iframe {
                height: 180px;
            }

            /* Weekly milestones - side scrolling */
            .milestone-week {
                min-width: 280px;
            }
        }

        /* INSTALL PROMPT BANNER */
        .install-prompt {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            color: white;
            padding: 16px 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .install-prompt-content {
            flex: 1;
        }

        .install-prompt-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .install-prompt-text {
            font-size: 0.9rem;
            opacity: 0.95;
        }

        .install-prompt-buttons {
            display: flex;
            gap: 10px;
        }

        .install-btn {
            background: white;
            color: var(--accent);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .install-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
        }

        .dismiss-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
        }

        @media (max-width: 480px) {
            .install-prompt {
                flex-direction: column;
                padding: 12px 16px;
            }

            .install-prompt-buttons {
                width: 100%;
                flex-direction: column;
            }

            .install-btn,
            .dismiss-btn {
                width: 100%;
            }
        }

        /* STICKY HEADER ON SCROLL */
        .header.sticky {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            margin: 0;
            border-radius: 0 0 20px 20px;
            animation: slideDown 0.3s ease-out;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }

        body.sticky-header-active {
            padding-top: 140px;
        }

        @media (max-width: 768px) {
            body.sticky-header-active {
                padding-top: 100px;
            }
        }

        /* BOTTOM NAVIGATION BAR (Mobile Only) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(17, 24, 39, 0.95), rgba(17, 24, 39, 0.98));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 2px solid rgba(96, 165, 250, 0.3);
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            display: none;
            z-index: 999;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
        }

        @media (max-width: 768px) {
            .bottom-nav {
                display: flex;
                justify-content: space-around;
                align-items: center;
            }

            body {
                padding-bottom: calc(70px + env(safe-area-inset-bottom));
            }

            /* Hide regular tabs on mobile when bottom nav is active */
            .tabs {
                display: none;
            }
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            max-width: 80px;
            text-decoration: none;
            color: var(--muted);
        }

        .bottom-nav-item:active {
            transform: scale(0.95);
        }

        .bottom-nav-item.active {
            background: rgba(96, 165, 250, 0.15);
            color: var(--accent);
        }

        .bottom-nav-icon {
            font-size: 1.4rem;
            line-height: 1;
        }

        .bottom-nav-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }

        /* DARK MODE TOGGLE */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 50px;
            padding: 10px 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: var(--ink);
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(96, 165, 250, 0.4);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .theme-toggle {
                top: 10px;
                right: 10px;
                padding: 8px 14px;
                font-size: 0.85rem;
            }
        }

        /* Light Mode Styles */
        body.light-mode {
            --bg: #f5f7fa;
            --card: #ffffff;
            --card-light: #f0f2f5;
            --ink: #1f2937;
            --muted: #6b7280;
            --accent: #3b82f6;
            --good: #16a34a;
            --warn: #d97706;
            --bad: #dc2626;
            --purple: #8b5cf6;
            --cyan: #0891b2;
        }

        /* PULL-TO-REFRESH INDICATOR */
        .pull-to-refresh {
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: top 0.3s ease-out;
            z-index: 10002;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .pull-to-refresh.pulling {
            top: 20px;
        }

        .pull-to-refresh.refreshing {
            top: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: translateX(-50%) rotate(0deg);
            }
            to {
                transform: translateX(-50%) rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- Skip to main content for keyboard users -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- THEME TOGGLE BUTTON -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark/light mode">
        <span id="themeIcon">🌙</span>
        <span id="themeText">Dark</span>
    </button>

    <!-- PULL-TO-REFRESH INDICATOR -->
    <div id="pullToRefresh" class="pull-to-refresh">
        <span id="refreshIcon">↓</span>
    </div>

    <div class="container">
        <header class="header" role="banner">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="flex: 1;"></div>
                <h1 style="flex: 2; text-align: center; margin: 0;">💓 CARDIAC RECOVERY PRO</h1>
                <div style="flex: 1; text-align: right;">
                    <div id="welcomeMessage" style="font-size: 1.1rem; font-weight: 600; color: var(--accent); opacity: 0.9;"></div>
                </div>
            </div>
            <p class="subtitle">Complete Recovery Tracking & Analytics System</p>
            <p style="text-align: center; font-size: 0.75rem; color: var(--muted); margin-top: 8px; font-weight: 400; letter-spacing: 0.5px;">
                Powered by our exclusive <span style="color: var(--accent); font-weight: 600;">PULSE</span> Technology<br>
                <span style="font-size: 0.7rem; opacity: 0.8;">Personal Universal Life Support Engine</span>
            </p>
        </header>

        <!-- CALENDAR NAVIGATION -->
        <nav aria-label="Date navigation" class="calendar-nav">
            <div class="calendar-controls">
                <div class="nav-buttons">
                    <button class="nav-btn" onclick="navigateDate(-7)" aria-label="Go back one week" title="Go back one week">⏪ -1 Week</button>
                    <button class="nav-btn" onclick="navigateDate(-1)" aria-label="Go back one day" title="Go back one day">◀ -1 Day</button>
                </div>
                <div>
                    <div class="date-display" id="currentDate" role="status" aria-live="polite" aria-atomic="true"></div>
                    <label for="datePicker" class="sr-only">Select date for data entry</label>
                    <input type="date" id="datePicker" aria-label="Select date" style="margin-top: 10px; padding: 10px; border-radius: 8px; border: 2px solid var(--accent);">
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn" onclick="navigateDate(1)" aria-label="Go forward one day" title="Go forward one day">+1 Day ▶</button>
                    <button class="nav-btn" onclick="navigateDate(7)" aria-label="Go forward one week" title="Go forward one week">+1 Week ⏩</button>
                </div>
            </div>
            <div class="recovery-info" id="recoveryInfo">
                <strong>Recovery Day:</strong> <span id="recoveryDay">Not Set</span> |
                <strong>Weeks Post-Op:</strong> <span id="weeksPostOp">0</span> |
                <strong>Phase:</strong> <span id="recoveryPhase">Not Started</span>
            </div>
        </div>

        <!-- BASELINE SETUP -->
        <section class="baseline-section" aria-labelledby="baseline-heading">
            <h2 id="baseline-heading">🎯 Patient Information & Recovery Day 1</h2>

            <!-- Patient Name and Surgery Date Row -->
            <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="patientName" style="color: var(--cyan); font-weight: 700; margin-bottom: 8px; display: block;">Patient Name:</label>
                    <input type="text" id="patientName" placeholder="Enter patient name" aria-label="Patient name" onchange="savePatientName()" style="padding: 14px; border-radius: 8px; border: 3px solid var(--cyan); font-size: 1.1rem; font-weight: 600; background: white; color: #1a1a1a; width: 100%;">
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label for="surgeryDate" style="color: var(--purple); font-weight: 700; margin-bottom: 8px; display: block;">Surgery Date:</label>
                    <input type="date" id="surgeryDate" aria-label="Surgery date" aria-describedby="baseline-heading" style="padding: 14px; border-radius: 8px; border: 3px solid var(--purple); font-size: 1.1rem; font-weight: 600; background: white; color: #1a1a1a; width: 100%;">
                </div>
                <button class="btn-good" onclick="setRecoveryDay1()" aria-label="Set surgery date as recovery day 1">✓ Set as Day 1</button>
            </div>

            <!-- Patient Demographics for CRPS Calculation -->
            <div style="background: rgba(96,165,250,0.05); border: 2px solid rgba(96,165,250,0.2); border-radius: 12px; padding: 20px; margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <h3 style="color: var(--accent); font-size: 1.1rem; margin: 0;">📊 Demographics for Recovery Score</h3>
                    <span id="demographicsSource" style="font-size: 0.75rem; color: var(--muted); padding: 4px 8px; background: rgba(0,0,0,0.2); border-radius: 4px; display: none;">
                        🔗 Auto-filled from Heartbeat App
                    </span>
                </div>
                <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 15px;">
                    Used for age-adjusted CRPS (Cardiac Recovery Probability Score) calculations
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <!-- Age -->
                    <div>
                        <label for="patientAge" style="color: var(--accent); font-weight: 600; margin-bottom: 6px; display: block; font-size: 0.9rem;">Age (years)</label>
                        <input type="number" id="patientAge" placeholder="e.g., 50" min="18" max="120" onchange="savePatientDemographics()" style="padding: 12px; border-radius: 8px; border: 2px solid var(--accent); font-size: 1rem; font-weight: 600; background: white; color: #1a1a1a; width: 100%;">
                        <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">For age-adjusted METs calculation</div>
                    </div>

                    <!-- Sex -->
                    <div>
                        <label for="patientSex" style="color: var(--accent); font-weight: 600; margin-bottom: 6px; display: block; font-size: 0.9rem;">Sex</label>
                        <select id="patientSex" onchange="savePatientDemographics()" style="padding: 12px; border-radius: 8px; border: 2px solid var(--accent); font-size: 1rem; font-weight: 600; background: white; color: #1a1a1a; width: 100%; cursor: pointer;">
                            <option value="">Select...</option>
                            <option value="female">Female</option>
                            <option value="male">Male</option>
                        </select>
                        <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">For 6MWT prediction equation</div>
                    </div>

                    <!-- Height -->
                    <div>
                        <label for="patientHeight" style="color: var(--accent); font-weight: 600; margin-bottom: 6px; display: block; font-size: 0.9rem;">Height (cm)</label>
                        <input type="number" id="patientHeight" placeholder="e.g., 170" min="100" max="250" onchange="savePatientDemographics()" style="padding: 12px; border-radius: 8px; border: 2px solid var(--accent); font-size: 1rem; font-weight: 600; background: white; color: #1a1a1a; width: 100%;">
                        <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">For 6MWT prediction equation</div>
                    </div>

                    <!-- Default Weight -->
                    <div>
                        <label for="patientWeight" style="color: var(--accent); font-weight: 600; margin-bottom: 6px; display: block; font-size: 0.9rem;">Weight (kg)</label>
                        <input type="number" id="patientWeight" placeholder="e.g., 70" min="30" max="300" step="0.1" onchange="savePatientDemographics()" style="padding: 12px; border-radius: 8px; border: 2px solid var(--accent); font-size: 1rem; font-weight: 600; background: white; color: #1a1a1a; width: 100%;">
                        <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">For 6MWT prediction (if not entered daily)</div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: rgba(6,182,212,0.1); border-radius: 6px; font-size: 0.85rem; color: var(--cyan); line-height: 1.5;">
                    <strong>💡 Note:</strong> These values improve CRPS accuracy. If connected to the main Heartbeat app, they'll auto-fill from your profile.
                </div>
            </div>
        </section>

        <!-- TABS -->
        <nav class="tabs" role="tablist" aria-label="Main navigation">
            <button class="tab-button active" onclick="switchTab('dashboard')" role="tab" aria-selected="true" aria-controls="dashboard" id="tab-dashboard">Dashboard</button>
            <button class="tab-button" onclick="switchTab('entry')" role="tab" aria-selected="false" aria-controls="entry" id="tab-entry">Data Entry</button>
            <button class="tab-button" onclick="switchTab('sessions')" role="tab" aria-selected="false" aria-controls="sessions" id="tab-sessions">Sessions</button>
            <button class="tab-button" onclick="switchTab('analytics')" role="tab" aria-selected="false" aria-controls="analytics" id="tab-analytics">Analytics</button>
            <button class="tab-button" onclick="switchTab('videos')" role="tab" aria-selected="false" aria-controls="videos" id="tab-videos">Videos</button>
            <button class="tab-button" onclick="switchTab('history')" role="tab" aria-selected="false" aria-controls="history" id="tab-history">History</button>
            <button class="tab-button" onclick="switchTab('hrmonitor')" role="tab" aria-selected="false" aria-controls="hrmonitor" id="tab-hrmonitor">Heart Rate Monitor</button>
            <button class="tab-button" onclick="switchTab('education')" role="tab" aria-selected="false" aria-controls="education" id="tab-education">Learn More</button>
        </nav>

        <!-- MAIN CONTENT -->
        <main id="main-content">
        <!-- DASHBOARD TAB -->
        <div class="tab-content active" id="dashboard" role="tabpanel" aria-labelledby="tab-dashboard">

            <!-- WEEKLY MILESTONES SECTION -->
            <div class="section">
                <h2 id="milestonesTitle">🎯 Weekly Milestones</h2>
                <div class="comparison-grid">
                    <div class="comparison-card">
                        <div class="comparison-title" id="currentWeekTitle">Current Week Achievements</div>
                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(96, 165, 250, 0.1); border-radius: 6px;">
                            <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 8px; font-weight: 600;">🏆 Top 3 Milestones This Week</div>
                            <div id="topMilestones" style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="color: var(--muted); font-size: 0.9rem;">Enter data to see your progress...</div>
                            </div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--muted); font-style: italic; margin-top: 10px;">
                            * Improvements shown vs. previous week average
                        </div>
                    </div>
                    <div class="comparison-card">
                        <div class="comparison-title" id="nextWeekTitle">
                            Next Week Goals
                            <button onclick="toggleEditGoals()" style="margin-left: 10px; padding: 4px 12px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">✏️ Edit</button>
                        </div>
                        <div id="goalsDisplay" style="display: block;">
                            <div class="metric-row" id="goal1Row">
                                <span class="metric-name" id="goal1Name">VO2 Max:</span>
                                <span class="metric-value" id="goal1Value">Improve 5%</span>
                            </div>
                            <div class="metric-row" id="goal2Row">
                                <span class="metric-name" id="goal2Name">Resting HR:</span>
                                <span class="metric-value" id="goal2Value">Reduce 2-3 bpm</span>
                            </div>
                            <div class="metric-row" id="goal3Row">
                                <span class="metric-name" id="goal3Name">6MWD:</span>
                                <span class="metric-value" id="goal3Value">Increase 20m</span>
                            </div>
                        </div>
                        <div id="goalsEdit" style="display: none;">
                            <div style="margin-bottom: 10px;">
                                <input type="text" id="editGoal1Name" placeholder="Goal 1 metric" style="width: 48%; margin-right: 2%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg);">
                                <input type="text" id="editGoal1Value" placeholder="Target" style="width: 48%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg);">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <input type="text" id="editGoal2Name" placeholder="Goal 2 metric" style="width: 48%; margin-right: 2%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg);">
                                <input type="text" id="editGoal2Value" placeholder="Target" style="width: 48%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg);">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <input type="text" id="editGoal3Name" placeholder="Goal 3 metric" style="width: 48%; margin-right: 2%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg);">
                                <input type="text" id="editGoal3Value" placeholder="Target" style="width: 48%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg);">
                            </div>
                            <button onclick="saveCustomGoals()" style="padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">💾 Save Goals</button>
                            <button onclick="cancelEditGoals()" style="padding: 8px 16px; background: var(--muted); color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">Weeks Post-Op</div>
                    <div class="stat-value" id="statsWeeks">0</div>
                    <div class="stat-trend up">↑ On Track</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">VO2 Max (ml/kg/min)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsVO2" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsVO2Avg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsVO2Trend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsVO2Date">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Resting HR (bpm)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsHR" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsHRAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsHRTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsHRDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">SDNN (ms)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsSDNN" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsSDNNAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsSDNNTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsSDNNDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Blood Pressure (mmHg)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsBP" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsBPAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsBPTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsBPDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max HR (bpm)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsMaxHR" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsMaxHRAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsMaxHRTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsMaxHRDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">HR Recovery (bpm drop)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsHRRecovery" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsHRRecoveryAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsHRRecoveryTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsHRRecoveryDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">RMSSD (ms)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsRMSSD" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsRMSSDAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsRMSSDTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsRMSSDDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">pNN50 (%)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsPNN50" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsPNN50Avg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsPNN50Trend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsPNN50Date">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">6-Min Walk (m)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="stats6MWD" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="stats6MWDAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="stats6MWDTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="stats6MWDDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">METs</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsMETs" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsMETsAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsMETsTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsMETsDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ejection Fraction (%)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsEF" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsEFAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsEFTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsEFDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Oxygen Saturation (%)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsSpO2" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsSpO2Avg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsSpO2Trend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsSpO2Date">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Respiratory Rate (/min)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsRespRate" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsRespRateAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsRespRateTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsRespRateDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Weight (kg)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsWeight" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsWeightAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsWeightTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsWeightDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Dyspnea Score (0-10)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsDyspnea" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsDyspneaAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsDyspneaTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsDyspneaDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Chest Pain (0-10)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsChestPain" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsChestPainAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsChestPainTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsChestPainDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Fatigue Score (0-10)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsFatigue" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsFatigueAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsFatigueTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsFatigueDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Edema Score (0-4)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsEdema" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsEdemaAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsEdemaTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsEdemaDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Quality of Life (0-100)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsQOL" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsQOLAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsQOLTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsQOLDate">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sleep Quality (0-10)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--accent); font-weight: 600;">Current:</span>
                            <span class="stat-value" id="statsSleep" style="color: var(--accent); font-weight: 700;">--</span>
                        </div>
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 0.85rem; color: var(--purple); font-weight: 600;">Average:</span>
                            <span class="stat-value-avg" id="statsSleepAvg" style="color: var(--purple); font-weight: 600; font-size: 1.3rem;">--</span>
                        </div>
                    </div>
                    <div class="stat-trend up" id="statsSleepTrend">No data yet</div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 5px;" id="statsSleepDate">--</div>
                </div>
            </div>

            <!-- CRPS RECOVERY PROBABILITY SCORE DISPLAY -->
            <div class="section" style="margin-top: 30px;">
                <div id="dashboardCRPSCard" style="background: linear-gradient(135deg, rgba(96,165,250,0.1), rgba(96,165,250,0.05)); border: 3px solid var(--accent); border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); letter-spacing: 1px; margin-bottom: 10px;">
                        📊 RECOVERY PROBABILITY SCORE
                    </div>

                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0;">
                        <div>
                            <div style="font-size: 5rem; font-weight: 900; line-height: 1;" id="dashboardCRPSScore">--</div>
                            <div style="font-size: 1rem; color: var(--muted); margin-top: 5px;">out of 100</div>
                        </div>

                        <div style="text-align: left; max-width: 400px;">
                            <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 8px;" id="dashboardCRPSInterpretation">
                                No data yet
                            </div>
                            <div style="font-size: 0.95rem; color: var(--muted); line-height: 1.5;" id="dashboardCRPSProbability">
                                Enter metrics to calculate your recovery probability score
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: var(--accent); margin-bottom: 15px;">
                            SCORE BREAKDOWN BY CATEGORY
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr; gap: 12px; text-align: left;">
                            <!-- Functional Capacity -->
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem;">
                                    <span style="font-weight: 600;">Functional Capacity</span>
                                    <span id="crpsfunctionalCapacityScore" style="color: var(--accent); font-weight: 700;">--/35</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="crpsfunctionalCapacityBar" style="height: 100%; width: 0%; background: var(--accent); transition: width 0.5s ease;"></div>
                                </div>
                            </div>

                            <!-- Cardiovascular Health -->
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem;">
                                    <span style="font-weight: 600;">Cardiovascular Health</span>
                                    <span id="crpscardiovascularHealthScore" style="color: var(--accent); font-weight: 700;">--/25</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="crpscardiovascularHealthBar" style="height: 100%; width: 0%; background: var(--accent); transition: width 0.5s ease;"></div>
                                </div>
                            </div>

                            <!-- Symptom Burden -->
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem;">
                                    <span style="font-weight: 600;">Symptom Burden</span>
                                    <span id="crpssymptomBurdenScore" style="color: var(--accent); font-weight: 700;">--/20</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="crpssymptomBurdenBar" style="height: 100%; width: 0%; background: var(--accent); transition: width 0.5s ease;"></div>
                                </div>
                            </div>

                            <!-- Quality of Life -->
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem;">
                                    <span style="font-weight: 600;">Quality of Life</span>
                                    <span id="crpsqualityOfLifeScore" style="color: var(--accent); font-weight: 700;">--/15</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="crpsqualityOfLifeBar" style="height: 100%; width: 0%; background: var(--accent); transition: width 0.5s ease;"></div>
                                </div>
                            </div>

                            <!-- Risk Modifiers -->
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem;">
                                    <span style="font-weight: 600;">Risk Modifiers</span>
                                    <span id="crpsriskModifiersScore" style="color: var(--accent); font-weight: 700;">--/5</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="crpsriskModifiersBar" style="height: 100%; width: 0%; background: var(--accent); transition: width 0.5s ease;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: rgba(96,165,250,0.1); border-radius: 8px; font-size: 0.75rem; color: var(--muted); text-align: center; line-height: 1.6;">
                            <strong style="color: var(--accent);">📚 Evidence-Based Scoring</strong><br>
                            Based on: STS Database (8.3M+ surgeries), 6MWT post-cardiac norms, METs age-adjusted equations, HRV cardiac surgery research, AHA/ACC 2024 Guidelines
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA ENTRY TAB (21 metrics - keeping from full version) -->
        <div class="tab-content" id="entry" role="tabpanel" aria-labelledby="tab-entry">
            <div class="section">
                <h2>📝 Enter Metrics for <span id="entryDate"></span></h2>

                <!-- HISTORICAL DATA ENTRY MODE -->
                <div style="margin: 20px 0; padding: 20px; background: rgba(167,139,250,0.1); border-left: 4px solid var(--purple); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 1.1rem; font-weight: 700; color: var(--purple);">
                            <input type="checkbox" id="historicalModeToggle" onchange="toggleHistoricalMode()" style="width: 20px; height: 20px; cursor: pointer;">
                            📅 Enter Historical Data
                        </label>
                    </div>

                    <div id="historicalDatePicker" style="display: none;">
                        <div style="margin-bottom: 10px; color: var(--muted); font-size: 0.95rem;">
                            <strong>Historical Mode:</strong> Enter data for a past date. This data will appear in charts and analytics but will NOT update the dashboard's current metrics.
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <label for="historicalDate" style="font-weight: 600; color: var(--purple);">Select Date:</label>
                            <input type="date" id="historicalDate" onchange="updateHistoricalDate()" style="padding: 10px; border-radius: 6px; border: 2px solid var(--purple); font-size: 1rem; font-weight: 600; min-width: 180px;">
                        </div>
                        <div style="margin-top: 12px; padding: 12px; background: rgba(96,165,250,0.1); border-radius: 6px;">
                            <div style="font-size: 0.9rem; color: var(--cyan);">
                                💡 <strong>Tip:</strong> Use this to enter baseline measurements from before your cardiac event, or to fill in missing historical data for complete trend analysis.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="metric-entry-grid">
                    <!-- All 21 metric fields here -->
                    <div class="metric-field">
                        <label>Resting Heart Rate (bpm)</label>
                        <div class="metric-help">Measured after 5 min rest</div>
                        <input type="number" id="restingHR" placeholder="e.g., 62">
                        <div class="metric-reference">Optimal: 50-70 bpm | Average: 70-80 bpm</div>
                    </div>
                    <div class="metric-field">
                        <label>Blood Pressure Systolic</label>
                        <div class="metric-help">Top number (mmHg)</div>
                        <input type="number" id="bpSystolic" placeholder="e.g., 120">
                        <div class="metric-reference">Optimal: <120 | Average: 120-129</div>
                    </div>
                    <div class="metric-field">
                        <label>Blood Pressure Diastolic</label>
                        <div class="metric-help">Bottom number (mmHg)</div>
                        <input type="number" id="bpDiastolic" placeholder="e.g., 80">
                        <div class="metric-reference">Optimal: <80 | Average: 80-84</div>
                    </div>
                    <div class="metric-field">
                        <label>VO2 Max (ml/kg/min)</label>
                        <div class="metric-help">Cardiopulmonary exercise test</div>
                        <input type="number" step="0.1" id="vo2Max" placeholder="e.g., 24.5">
                        <div class="metric-reference">Optimal: >28 | Good: 24-28</div>
                    </div>
                    <div class="metric-field">
                        <label>Max HR During Exercise (bpm)</label>
                        <div class="metric-help">Peak heart rate achieved</div>
                        <input type="number" id="maxHR" placeholder="e.g., 145">
                        <div class="metric-reference">Target: 220 - age</div>
                    </div>
                    <div class="metric-field">
                        <label>HR Recovery (1 min drop)</label>
                        <div class="metric-help">HR decrease after 1 min rest</div>
                        <input type="number" id="hrRecovery" placeholder="e.g., 25">
                        <div class="metric-reference">Excellent: >25 | Good: 20-25</div>
                    </div>
                    <div class="metric-field">
                        <label>SDNN (ms)</label>
                        <div class="metric-help">HRV - Standard deviation</div>
                        <input type="number" step="0.1" id="sdnn" placeholder="e.g., 35.2">
                        <div class="metric-reference">Excellent: >50 | Good: 35-50</div>
                    </div>
                    <div class="metric-field">
                        <label>RMSSD (ms)</label>
                        <div class="metric-help">HRV - Successive differences</div>
                        <input type="number" step="0.1" id="rmssd" placeholder="e.g., 28.5">
                        <div class="metric-reference">Excellent: >40 | Good: 30-40</div>
                    </div>
                    <div class="metric-field">
                        <label>pNN50 (%)</label>
                        <div class="metric-help">HRV - Interval variance</div>
                        <input type="number" step="0.1" id="pnn50" placeholder="e.g., 18.2">
                        <div class="metric-reference">Excellent: >20% | Good: 10-20%</div>
                    </div>

                    <!-- SAMSUNG WATCH ECG FIELDS -->
                    <div style="grid-column: 1 / -1; padding: 15px; background: rgba(167,139,250,0.1); border-left: 4px solid var(--purple); border-radius: 8px; margin: 10px 0;">
                        <h3 style="color: var(--purple); margin: 0; font-size: 1.2rem; font-weight: 700;">⌚ Samsung Galaxy Watch ECG Data</h3>
                        <p style="color: var(--muted); margin: 5px 0 0 0; font-size: 0.9rem;">Additional metrics from Samsung Watch ECG monitoring</p>
                    </div>

                    <div class="metric-field">
                        <label>ECG Rhythm</label>
                        <div class="metric-help">Heart rhythm classification</div>
                        <select id="ecgRhythmInput" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 1rem;">
                            <option value="">Select rhythm...</option>
                            <option value="Normal Sinus">Normal Sinus</option>
                            <option value="Tachycardia">Tachycardia</option>
                            <option value="Bradycardia">Bradycardia</option>
                            <option value="Irregular">Irregular</option>
                        </select>
                        <div class="metric-reference">Normal Sinus = Healthy rhythm</div>
                    </div>

                    <div class="metric-field">
                        <label>QRS Duration (ms)</label>
                        <div class="metric-help">Ventricular depolarization time</div>
                        <input type="number" id="qrsDuration" placeholder="e.g., 90">
                        <div class="metric-reference">Normal: 80-100ms</div>
                    </div>

                    <div class="metric-field">
                        <label>R-R Interval (ms)</label>
                        <div class="metric-help">Time between heartbeats</div>
                        <input type="number" id="rrInterval" placeholder="e.g., 850">
                        <div class="metric-reference">Varies with HR | Higher = Better HRV</div>
                    </div>

                    <div class="metric-field">
                        <label>Stress Level</label>
                        <div class="metric-help">Watch-detected stress</div>
                        <select id="stressLevel" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 1rem;">
                            <option value="">Select stress level...</option>
                            <option value="Low">Low</option>
                            <option value="Moderate">Moderate</option>
                            <option value="High">High</option>
                        </select>
                        <div class="metric-reference">Low = Optimal | High = Rest needed</div>
                    </div>

                    <div class="metric-field">
                        <label>6-Minute Walk Distance (m)</label>
                        <div class="metric-help">Distance walked in 6 min</div>
                        <input type="number" id="walkDistance" placeholder="e.g., 450">
                        <div class="metric-reference">Excellent: >500m | Good: 400-500m</div>
                    </div>
                    <div class="metric-field">
                        <label>Exercise Capacity (METs)</label>
                        <div class="metric-help">Metabolic equivalents</div>
                        <input type="number" step="0.1" id="mets" placeholder="e.g., 7.5">
                        <div class="metric-reference">Excellent: >10 | Good: 7-10</div>
                    </div>
                    <div class="metric-field">
                        <label>Ejection Fraction (%)</label>
                        <div class="metric-help">Blood pumped per beat</div>
                        <input type="number" id="ejectionFraction" placeholder="e.g., 55">
                        <div class="metric-reference">Normal: 50-70% | Reduced: 40-49%</div>
                    </div>
                    <div class="metric-field">
                        <label>Oxygen Saturation / SpO2 (%) ⌚</label>
                        <div class="metric-help">Blood oxygen level | Samsung Watch Compatible</div>
                        <input type="number" id="spo2" placeholder="e.g., 98">
                        <div class="metric-reference">Normal: 95-100%</div>
                    </div>
                    <div class="metric-field">
                        <label>Respiratory Rate (breaths/min) ⌚</label>
                        <div class="metric-help">Breaths per minute | Samsung Watch Compatible</div>
                        <input type="number" id="respRate" placeholder="e.g., 14">
                        <div class="metric-reference">Normal: 12-20</div>
                    </div>
                    <div class="metric-field">
                        <label>Weight (kg)</label>
                        <div class="metric-help">Body weight</div>
                        <input type="number" step="0.1" id="weight" placeholder="e.g., 75.5">
                        <div class="metric-reference">Monitor for fluid retention</div>
                    </div>
                    <div class="metric-field">
                        <label>Dyspnea Score (0-10)</label>
                        <div class="metric-help">Shortness of breath</div>
                        <input type="number" min="0" max="10" id="dyspnea" placeholder="e.g., 2">
                        <div class="metric-reference">0=None | 10=Severe</div>
                    </div>
                    <div class="metric-field">
                        <label>Chest Pain Score (0-10)</label>
                        <div class="metric-help">Angina/discomfort</div>
                        <input type="number" min="0" max="10" id="chestPain" placeholder="e.g., 0">
                        <div class="metric-reference">0=None | >3=Contact MD</div>
                    </div>
                    <div class="metric-field">
                        <label>Fatigue Score (0-10)</label>
                        <div class="metric-help">Overall fatigue</div>
                        <input type="number" min="0" max="10" id="fatigue" placeholder="e.g., 3">
                        <div class="metric-reference">0=None | 10=Extreme</div>
                    </div>
                    <div class="metric-field">
                        <label>Edema Score (0-4)</label>
                        <div class="metric-help">Swelling severity</div>
                        <input type="number" min="0" max="4" id="edema" placeholder="e.g., 0">
                        <div class="metric-reference">0=None | 4=Severe</div>
                    </div>
                    <div class="metric-field">
                        <label>Quality of Life (0-100)</label>
                        <div class="metric-help">Overall well-being</div>
                        <input type="number" min="0" max="100" id="qualityOfLife" placeholder="e.g., 75">
                        <div class="metric-reference">Excellent: >80 | Good: 60-80</div>
                    </div>
                    <div class="metric-field">
                        <label>Sleep Quality (0-10)</label>
                        <div class="metric-help">Last night's sleep</div>
                        <input type="number" min="0" max="10" id="sleepQuality" placeholder="e.g., 7">
                        <div class="metric-reference">Excellent: 8-10 | Poor: <6</div>
                    </div>
                </div>

                <!-- DAILY NOTES & SYMPTOM JOURNAL -->
                <div style="margin-top: 40px; padding-top: 40px; border-top: 2px solid rgba(96,165,250,0.2);">
                    <h3 style="color: var(--cyan); font-size: 1.5rem; margin-bottom: 20px; font-weight: 700;">📝 Daily Notes & Symptom Journal</h3>
                    <div class="metric-field">
                        <label>How are you feeling today?</label>
                        <div class="metric-help">Document symptoms, activities, mood, medications, or anything notable</div>
                        <textarea
                            id="dailyNotes"
                            placeholder="Example: Felt slightly dizzy after morning walk. Took extra beta blocker as prescribed. Energy improved by afternoon. Noticed less shortness of breath today compared to yesterday."
                            rows="6"
                            style="resize: vertical; font-family: inherit; line-height: 1.6;"
                        ></textarea>
                        <div class="metric-reference">💡 Tip: Include activities, medications, symptoms, mood, sleep quality details</div>
                    </div>
                </div>

                <div style="display: flex; gap: 20px; margin-top: 30px;">
                    <button class="btn-good" onclick="saveMetrics()">💾 Save All Metrics & Notes</button>
                    <button class="btn-danger" onclick="clearForm()">🗑️ Clear Form</button>
                </div>
            </div>
        </div>

        <!-- SESSIONS TAB -->
        <div class="tab-content" id="sessions" role="tabpanel" aria-labelledby="tab-sessions">
            <div class="section">
                <h2>🏥 Record Therapy Session</h2>
                <div class="metric-entry-grid">
                    <!-- Session Details -->
                    <div class="metric-field">
                        <label for="sessionDate">Session Date</label>
                        <div class="metric-help">Date of therapy session</div>
                        <input type="date" id="sessionDate" aria-label="Session date">
                    </div>
                    <div class="metric-field">
                        <label for="sessionTime">Session Time</label>
                        <div class="metric-help">Start time</div>
                        <input type="time" id="sessionTime" aria-label="Session time">
                    </div>
                    <div class="metric-field">
                        <label for="sessionDuration">Duration (minutes)</label>
                        <div class="metric-help">Length of session</div>
                        <input type="number" id="sessionDuration" placeholder="45" min="1">
                    </div>

                    <!-- Therapist Information -->
                    <div class="metric-field">
                        <label for="therapistName">Therapist Name</label>
                        <div class="metric-help">Physical therapist or clinician</div>
                        <input type="text" id="therapistName" placeholder="e.g., Dr. Smith">
                    </div>
                    <div class="metric-field">
                        <label for="therapyCompany">Therapy Company/Facility</label>
                        <div class="metric-help">Healthcare facility name</div>
                        <input type="text" id="therapyCompany" placeholder="e.g., ABC Cardiac Rehab">
                    </div>
                    <div class="metric-field">
                        <label for="therapistCredentials">Credentials</label>
                        <div class="metric-help">PT, DPT, MD, etc.</div>
                        <input type="text" id="therapistCredentials" placeholder="e.g., DPT, CCS">
                    </div>

                    <!-- Exercise Details -->
                    <div class="metric-field autocomplete-container">
                        <label for="exerciseType">Primary Exercise Type</label>
                        <div class="metric-help">Main activity performed</div>
                        <input type="text" id="exerciseType" placeholder="Start typing..." onkeyup="showExerciseSuggestions(this.value)">
                        <div class="autocomplete-suggestions" id="exerciseSuggestions"></div>
                    </div>
                    <div class="metric-field">
                        <label for="exerciseIntensity">Exercise Intensity</label>
                        <div class="metric-help">RPE scale</div>
                        <select id="exerciseIntensity">
                            <option value="">Select intensity</option>
                            <option>Light (RPE 3-4)</option>
                            <option>Moderate (RPE 5-6)</option>
                            <option>Vigorous (RPE 7-8)</option>
                        </select>
                    </div>
                    <div class="metric-field">
                        <label for="targetHeartRate">Target HR Achieved</label>
                        <div class="metric-help">Peak heart rate (bpm)</div>
                        <input type="number" id="targetHeartRate" placeholder="e.g., 125">
                    </div>

                    <!-- Treatment Goals -->
                    <div class="metric-field" style="grid-column: 1 / -1;">
                        <label for="treatmentGoal">Primary Treatment Goal</label>
                        <div class="metric-help">Main objective for this session</div>
                        <textarea id="treatmentGoal" rows="3" placeholder="e.g., Increase walking tolerance, improve cardiovascular endurance, reduce dyspnea during activity..." style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: white; color: #1a1a1a; font-size: 1rem;"></textarea>
                    </div>

                    <!-- Therapist Session Notes -->
                    <div class="metric-field" style="grid-column: 1 / -1;">
                        <label for="therapistNotes">Therapist Session Notes</label>
                        <div class="metric-help">Clinical observations, patient performance, vitals, progress</div>
                        <textarea id="therapistNotes" rows="5" placeholder="Document patient performance, vital signs during exercise, tolerance levels, any symptoms noted, modifications made, objective measurements..." style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: white; color: #1a1a1a; font-size: 1rem;"></textarea>
                    </div>

                    <!-- Red Flags / Care Team Alerts -->
                    <div class="metric-field" style="grid-column: 1 / -1;">
                        <label for="redFlags" style="color: var(--bad); font-weight: 700;">⚠️ Red Flags / Care Team Alerts</label>
                        <div class="metric-help" style="color: var(--bad);">URGENT: Concerning symptoms or observations requiring care team notification</div>
                        <textarea id="redFlags" rows="4" placeholder="Report any concerning vital signs, abnormal symptoms (chest pain, severe dyspnea, dizziness), significant exercise intolerance, patient concerns requiring physician review..." style="width: 100%; padding: 12px; border-radius: 8px; border: 3px solid var(--bad); background: #fff5f5; color: #1a1a1a; font-size: 1rem;"></textarea>
                        <div style="margin-top: 8px; padding: 10px; background: rgba(239,68,68,0.1); border-left: 4px solid var(--bad); border-radius: 4px;">
                            <strong style="color: var(--bad);">Note:</strong> Any entries here will trigger immediate notification to the patient's care team
                        </div>
                    </div>

                    <!-- At-Home Work Instructions -->
                    <div class="metric-field" style="grid-column: 1 / -1;">
                        <label for="homeExerciseInstructions" style="color: var(--good);">📝 At-Home Exercise Plan (For Patient)</label>
                        <div class="metric-help">Instructions for patient to follow until next session</div>
                        <textarea id="homeExerciseInstructions" rows="5" placeholder="Provide specific exercises, frequency, duration, intensity guidelines, precautions, and goals for the patient to work on at home this week..." style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--good); background: white; color: #1a1a1a; font-size: 1rem;"></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn-good" onclick="saveTherapySession()" style="flex: 1;">💾 Save Session</button>
                    <button class="btn" onclick="clearSessionForm()" style="flex: 1; background: var(--muted);">🔄 Clear Form</button>
                </div>
            </div>

            <div class="section">
                <h2>📋 Session History</h2>
                <div style="overflow-x: auto; overflow-y: auto; max-height: 600px; border: 2px solid rgba(96,165,250,0.2); border-radius: 12px;">
                    <table class="data-table" id="sessionsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Therapist</th>
                                <th>Company</th>
                                <th>Duration</th>
                                <th>Exercise</th>
                                <th>Red Flags</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsBody">
                            <tr><td colspan="8" style="text-align: center; color: var(--muted);">No sessions recorded yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div class="tab-content" id="analytics" role="tabpanel" aria-labelledby="tab-analytics">
            <div class="section">
                <h2>📊 Population Comparison</h2>
                <div class="comparison-grid" id="populationComparison">
                    <div class="comparison-card">
                        <div class="comparison-title">Your Metrics</div>
                        <div class="metric-row">
                            <span class="metric-name">VO2 Max:</span>
                            <span class="metric-value good" id="yourVO2">--</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Percentile:</span>
                            <span class="metric-value good" id="yourPercentile">--</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Risk Level:</span>
                            <span class="metric-value good" id="yourRiskLevel">--</span>
                        </div>
                    </div>
                    <div class="comparison-card">
                        <div class="comparison-title">Age/Gender Baseline</div>
                        <div class="metric-row">
                            <span class="metric-name">Average VO2:</span>
                            <span class="metric-value" id="avgVO2">20.0 ml/kg/min</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Good Threshold:</span>
                            <span class="metric-value" id="goodThreshold">24.0 ml/kg/min</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Your Position:</span>
                            <span class="metric-value" id="yourPosition">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRPS RECOVERY PROBABILITY SCORE - ANALYTICS VIEW -->
            <div class="section">
                <h2>🎯 Recovery Probability Score (CRPS)</h2>

                <!-- Compact Score Display -->
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 30px;">
                    <!-- Score Card -->
                    <div style="background: linear-gradient(135deg, rgba(96,165,250,0.15), rgba(96,165,250,0.05)); border: 3px solid var(--accent); border-radius: 16px; padding: 30px; text-align: center;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: var(--muted); letter-spacing: 1px; margin-bottom: 10px;">
                            CURRENT SCORE
                        </div>
                        <div style="font-size: 4rem; font-weight: 900; line-height: 1;" id="analyticsCRPSScore">--</div>
                        <div style="font-size: 0.9rem; color: var(--muted); margin-top: 5px;">out of 100</div>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 5px;" id="analyticsCRPSInterpretation">No data yet</div>
                        </div>
                    </div>

                    <!-- Quick Summary -->
                    <div style="background: var(--card); border: 2px solid rgba(96,165,250,0.2); border-radius: 16px; padding: 30px;">
                        <h3 style="font-size: 1.1rem; color: var(--accent); margin-bottom: 15px;">📈 Score Interpretation</h3>
                        <div style="display: grid; gap: 10px; font-size: 0.9rem;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; background: #22c55e; border-radius: 4px;"></div>
                                <span><strong>90-100:</strong> Superior Recovery (95-100% probability)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; background: #22c55e; border-radius: 4px;"></div>
                                <span><strong>80-89:</strong> Excellent Recovery (85-94% probability)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; background: #3b82f6; border-radius: 4px;"></div>
                                <span><strong>70-79:</strong> Very Good Recovery (75-84% probability)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; background: #3b82f6; border-radius: 4px;"></div>
                                <span><strong>60-69:</strong> Good Recovery (65-74% probability)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; background: #fbbf24; border-radius: 4px;"></div>
                                <span><strong>50-59:</strong> Fair Recovery (50-64% probability)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; background: #f97316; border-radius: 4px;"></div>
                                <span><strong>40-49:</strong> Below Average (35-49% probability)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; background: #ef4444; border-radius: 4px;"></div>
                                <span><strong>30-39:</strong> Poor Recovery (20-34% probability)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; background: #ef4444; border-radius: 4px;"></div>
                                <span><strong>&lt;30:</strong> High Risk (0-19% probability)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CRPS 90-Day Trend Chart -->
                <div style="background: var(--card); border: 2px solid rgba(96,165,250,0.2); border-radius: 16px; padding: 30px;">
                    <h3 style="font-size: 1.2rem; color: var(--accent); margin-bottom: 20px;">📈 Recovery Score Trend (90 Days)</h3>
                    <div class="chart-container">
                        <canvas id="crpsTrendChart"></canvas>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(96,165,250,0.05); border-radius: 8px; font-size: 0.85rem; color: var(--muted); text-align: center;">
                        <strong style="color: var(--accent);">Color Legend:</strong>
                        <span style="color: #22c55e;">■</span> Excellent (80+) |
                        <span style="color: #3b82f6;">■</span> Better than Average (60-79) |
                        <span style="color: #fbbf24;">■</span> Average (50-59) |
                        <span style="color: #f97316;">■</span> Below Average (40-49) |
                        <span style="color: #ef4444;">■</span> Poor (&lt;40)
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>📊 HRV Analysis</h2>
                <div class="chart-container">
                    <canvas id="hrvChart"></canvas>
                </div>

                <div style="margin-top: 20px; padding: 20px; background: rgba(96,165,250,0.05); border-left: 4px solid var(--cyan); border-radius: 8px;">
                    <h3 style="color: var(--cyan); font-size: 1.1rem; margin-bottom: 12px; font-weight: 700;">💡 What is HRV (Heart Rate Variability)?</h3>
                    <p style="color: var(--muted); line-height: 1.6; margin-bottom: 12px;">
                        <strong>Heart Rate Variability (HRV)</strong> measures the variation in time between each heartbeat. Unlike a steady metronome, a healthy heart has natural variations in beat-to-beat intervals, controlled by your autonomic nervous system.
                    </p>
                    <p style="color: var(--muted); line-height: 1.6; margin-bottom: 12px;">
                        <strong>Why it matters for cardiac recovery:</strong> Higher HRV generally indicates better cardiovascular fitness and recovery capacity. After cardiac events, monitoring HRV helps track your heart's improving ability to adapt to stress and recover from exercise.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="padding: 12px; background: rgba(6,182,212,0.1); border-radius: 6px;">
                            <div style="font-weight: 700; color: #06b6d4; margin-bottom: 5px;">SDNN</div>
                            <div style="font-size: 0.9rem; color: var(--muted);">Standard Deviation - Overall HRV over time. Higher is better.</div>
                        </div>
                        <div style="padding: 12px; background: rgba(167,139,250,0.1); border-radius: 6px;">
                            <div style="font-weight: 700; color: #a78bfa; margin-bottom: 5px;">RMSSD</div>
                            <div style="font-size: 0.9rem; color: var(--muted);">Short-term variability - Indicates parasympathetic (rest & recovery) activity.</div>
                        </div>
                        <div style="padding: 12px; background: rgba(34,197,94,0.1); border-radius: 6px;">
                            <div style="font-weight: 700; color: #22c55e; margin-bottom: 5px;">pNN50</div>
                            <div style="font-size: 0.9rem; color: var(--muted);">Percentage of intervals >50ms different - Reflects heart health resilience.</div>
                        </div>
                    </div>
                    <p style="color: var(--muted); line-height: 1.6; margin-top: 15px; font-size: 0.95rem;">
                        <strong>📈 Tracking Improvement:</strong> As you recover, you should see these HRV metrics gradually increase, indicating your heart's improved ability to regulate itself and respond to daily activities.
                    </p>
                </div>
            </div>

            <div class="section">
                <h2>🕸️ Multi-Metric Analysis</h2>
                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>

                <div style="margin-top: 20px; padding: 20px; background: rgba(96,165,250,0.05); border-left: 4px solid var(--cyan); border-radius: 8px;">
                    <h3 style="color: var(--cyan); font-size: 1.1rem; margin-bottom: 15px; font-weight: 700;">📊 Understanding Your Metrics</h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">VO2 Max</div>
                            <div style="font-size: 0.9rem; color: var(--muted);">Maximum oxygen uptake - Key indicator of cardiovascular fitness</div>
                        </div>
                        <div style="padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">HR Recovery</div>
                            <div style="font-size: 0.9rem; color: var(--muted);">Heart rate drop after exercise - Measures cardiac efficiency</div>
                        </div>
                        <div style="padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">Resting HR</div>
                            <div style="font-size: 0.9rem; color: var(--muted);">Baseline heart rate - Lower values indicate better fitness</div>
                        </div>
                        <div style="padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">HRV (SDNN)</div>
                            <div style="font-size: 0.9rem; color: var(--muted);">Heart Rate Variability - Reflects autonomic nervous system health</div>
                        </div>
                        <div style="padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">Exercise Capacity</div>
                            <div style="font-size: 0.9rem; color: var(--muted);">METs (Metabolic Equivalents) - Energy expenditure during activity</div>
                        </div>
                        <div style="padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px;">Recovery Speed</div>
                            <div style="font-size: 0.9rem; color: var(--muted);">Rate of improvement since surgery - Tracks rehabilitation progress</div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="font-weight: 700; color: var(--cyan); margin-bottom: 10px;">🎨 Color Scale Guide:</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #ef4444; border-radius: 4px;"></div>
                                <span style="font-size: 0.9rem; color: var(--muted);"><strong>Red:</strong> Poor</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #f59e0b; border-radius: 4px;"></div>
                                <span style="font-size: 0.9rem; color: var(--muted);"><strong>Orange:</strong> Fair</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #3b82f6; border-radius: 4px;"></div>
                                <span style="font-size: 0.9rem; color: var(--muted);"><strong>Blue:</strong> Good</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #22c55e; border-radius: 4px;"></div>
                                <span style="font-size: 0.9rem; color: var(--muted);"><strong>Green:</strong> Excellent</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>📈 Cardiovascular Risk Stratification</h2>
                <p style="color: var(--muted); margin-bottom: 15px;">Your overall cardiovascular health risk level based on multiple clinical indicators</p>
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>

                <div style="margin-top: 20px; padding: 20px; background: rgba(96,165,250,0.05); border-left: 4px solid var(--cyan); border-radius: 8px;">
                    <h3 style="color: var(--cyan); font-size: 1.1rem; margin-bottom: 12px; font-weight: 700;">📊 Understanding Risk Stratification</h3>
                    <p style="color: var(--muted); line-height: 1.6; margin-bottom: 12px;">
                        <strong>Risk Stratification</strong> is a medical assessment that evaluates your overall cardiovascular health risk by combining multiple clinical factors. This helps your care team determine appropriate exercise intensity, monitoring frequency, and intervention strategies during recovery.
                    </p>
                    <p style="color: var(--muted); line-height: 1.6; margin-bottom: 15px;">
                        <strong>Risk factors assessed include:</strong> VO2 Max (aerobic capacity), heart rate recovery, ejection fraction (pumping efficiency), resting heart rate, exercise tolerance, and symptom severity.
                    </p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;">
                        <div style="padding: 12px; background: rgba(34,197,94,0.15); border: 2px solid #22c55e; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 700; color: #22c55e; font-size: 1.1rem;">Low Risk</div>
                            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">Excellent recovery</div>
                        </div>
                        <div style="padding: 12px; background: rgba(132,204,22,0.15); border: 2px solid #84cc16; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 700; color: #84cc16; font-size: 1.1rem;">Below Average</div>
                            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">Good progress</div>
                        </div>
                        <div style="padding: 12px; background: rgba(245,158,11,0.15); border: 2px solid #f59e0b; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 700; color: #f59e0b; font-size: 1.1rem;">Average</div>
                            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">Standard monitoring</div>
                        </div>
                        <div style="padding: 12px; background: rgba(249,115,22,0.15); border: 2px solid #f97316; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 700; color: #f97316; font-size: 1.1rem;">Above Average</div>
                            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">Closer supervision</div>
                        </div>
                        <div style="padding: 12px; background: rgba(239,68,68,0.15); border: 2px solid #ef4444; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 700; color: #ef4444; font-size: 1.1rem;">High Risk</div>
                            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">Intensive care needed</div>
                        </div>
                    </div>

                    <p style="color: var(--muted); line-height: 1.6; margin-top: 15px; font-size: 0.95rem;">
                        <strong>🎯 Goal:</strong> As you progress through cardiac rehabilitation, your risk level should gradually decrease from high/above average toward low risk, indicating improved cardiovascular health and reduced likelihood of adverse events.
                    </p>
                </div>
            </div>

            <div class="section">
                <h2>📈 Recovery Progress - Complete History</h2>
                <p style="color: var(--muted); margin-bottom: 15px;">Track all your metrics over time. Click legend items to toggle individual metrics, or use Select All to view everything.</p>

                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <button id="selectAllMetricsBtn" onclick="toggleAllMetrics()" style="padding: 12px 30px; background: var(--good); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(96,165,250,0.3); transition: all 0.2s;">
                        ✓ Select All Metrics
                    </button>
                </div>

                <div class="chart-container">
                    <canvas id="recoveryProgressChart"></canvas>
                </div>
            </div>
        </div>

        <!-- VIDEOS TAB -->
        <div class="tab-content" id="videos" role="tabpanel" aria-labelledby="tab-videos">
            <div class="section">
                <h2>🎥 Exercise Video Library - 12 Week Program</h2>
                <p style="color: var(--muted); margin-bottom: 30px;">Evidence-based exercises for cardiac recovery</p>

                <div class="video-grid">
                    <!-- WEEK 1: Hospital Phase - Phase 1 Cardiac Rehab -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=J3nhlVfodGU', '_blank')" aria-label="Week 1: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-chair"></div>
                        <div class="video-info">
                            <div class="video-title">Week 1: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 1</span>
                                <span class="video-badge difficulty">Beginner</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 2: Early Mobility - Chair-Based Exercises -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=-JsuNKbAAkU', '_blank')" aria-label="Week 2: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-chair-2"></div>
                        <div class="video-info">
                            <div class="video-title">Week 2: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 2</span>
                                <span class="video-badge difficulty">Beginner</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 3: Early Walking Program -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=jzReP325QUg', '_blank')" aria-label="Week 3: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-walk"></div>
                        <div class="video-info">
                            <div class="video-title">Week 3: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 3</span>
                                <span class="video-badge difficulty">Beginner</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 4: Stretching & Balance -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=UPO73VMYeSE', '_blank')" aria-label="Week 4: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-cardio"></div>
                        <div class="video-info">
                            <div class="video-title">Week 4: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 4</span>
                                <span class="video-badge difficulty">Beginner</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 5: Standing Exercises -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=VHbY-zdSbQM', '_blank')" aria-label="Week 5: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-walk-2"></div>
                        <div class="video-info">
                            <div class="video-title">Week 5: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 5</span>
                                <span class="video-badge difficulty">Intermediate</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 6: Interval Walking -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=GHEeocYzdTI', '_blank')" aria-label="Week 6: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-treadmill"></div>
                        <div class="video-info">
                            <div class="video-title">Week 6: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 6</span>
                                <span class="video-badge difficulty">Intermediate</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 7: Light Resistance Training -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=09-J4TUKoBM', '_blank')" aria-label="Week 7: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-strength"></div>
                        <div class="video-info">
                            <div class="video-title">Week 7: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 7</span>
                                <span class="video-badge difficulty">Intermediate</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 8: Stationary Cycling -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=GHEeocYzdTI&t=194s', '_blank')" aria-label="Week 8: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-bike"></div>
                        <div class="video-info">
                            <div class="video-title">Week 8: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 8</span>
                                <span class="video-badge difficulty">Intermediate</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 9: Strength Training with Weights -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=LMXU8TQtyFc', '_blank')" aria-label="Week 9: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-strength-2"></div>
                        <div class="video-info">
                            <div class="video-title">Week 9: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 9</span>
                                <span class="video-badge difficulty">Advanced</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 10: Circuit Training -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=e-2dVXEHubI', '_blank')" aria-label="Week 10: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-elliptical"></div>
                        <div class="video-info">
                            <div class="video-title">Week 10: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 10</span>
                                <span class="video-badge difficulty">Advanced</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 11: Advanced Cardio -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/shorts/BkELFiAHhvE', '_blank')" aria-label="Week 11: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-advanced"></div>
                        <div class="video-info">
                            <div class="video-title">Week 11: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 11</span>
                                <span class="video-badge difficulty">Advanced</span>
                            </div>
                        </div>
                    </div>

                    <!-- WEEK 12: Return to Function -->
                    <div class="video-card" onclick="window.open('https://www.youtube.com/watch?v=JIXkf_i3kG0', '_blank')" aria-label="Week 12: Cardiac rehab exercise">
                        <div class="video-thumbnail thumb-recovery"></div>
                        <div class="video-info">
                            <div class="video-title">Week 12: Cardiac Rehab Exercise</div>
                            <div class="video-meta">
                                <span class="video-badge week">Week 12</span>
                                <span class="video-badge difficulty">Advanced</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div class="tab-content" id="history" role="tabpanel" aria-labelledby="tab-history">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">📋 All Recorded Data</h2>
                    <button onclick="clearAllPatientData()" style="padding: 12px 24px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(239,68,68,0.3); transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                        <span style="font-size: 1.2rem;">🗑️</span>
                        <span>Clear All Patient Data</span>
                    </button>
                </div>
                <div style="overflow-x: auto; overflow-y: auto; max-height: 600px; border: 2px solid rgba(96,165,250,0.2); border-radius: 12px;">
                    <table class="data-table" id="historyTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Resting HR</th>
                                <th>BP Sys</th>
                                <th>BP Dia</th>
                                <th>VO2 Max</th>
                                <th>Max HR</th>
                                <th>HR Recov</th>
                                <th>SDNN</th>
                                <th>RMSSD</th>
                                <th>pNN50</th>
                                <th>6MWD</th>
                                <th>METs</th>
                                <th>EF %</th>
                                <th>SpO2</th>
                                <th>Resp Rate</th>
                                <th>Weight</th>
                                <th>Dyspnea</th>
                                <th>Chest Pain</th>
                                <th>Fatigue</th>
                                <th>Edema</th>
                                <th>QOL</th>
                                <th>Sleep</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr><td colspan="24" style="text-align: center; color: var(--muted);">No data recorded yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- HEART RATE MONITOR TAB -->
        <div class="tab-content" id="hrmonitor" role="tabpanel" aria-labelledby="tab-hrmonitor">
            <div class="section">
                <h2 style="color: var(--accent); text-align: center; font-size: 2rem; margin-bottom: 10px;">❤️ Heart Rate Monitor</h2>
                <p style="text-align: center; color: var(--muted); font-size: 1.1rem; margin-bottom: 30px;">Real-time heart rate tracking and analysis</p>

                <!-- CURRENT HEART RATE DISPLAY -->
                <div style="display: flex; justify-content: center; margin-bottom: 40px;">
                    <div style="background: linear-gradient(135deg, rgba(96,165,250,0.15) 0%, rgba(167,139,250,0.15) 100%); border: 3px solid var(--accent); border-radius: 20px; padding: 40px 60px; box-shadow: 0 8px 24px rgba(96,165,250,0.2); text-align: center; min-width: 300px;">
                        <div style="font-size: 1.2rem; color: var(--muted); margin-bottom: 10px; font-weight: 600;">Current Heart Rate</div>
                        <div id="currentHR" style="font-size: 5rem; font-weight: 800; color: var(--accent); margin: 20px 0; font-family: 'Segoe UI', system-ui, sans-serif; text-shadow: 0 2px 10px rgba(96,165,250,0.3);">--</div>
                        <div style="font-size: 1.5rem; color: var(--muted); font-weight: 600;">BPM</div>
                        <div id="hrStatus" style="margin-top: 20px; padding: 10px 20px; background: rgba(96,165,250,0.2); border-radius: 8px; font-weight: 600; color: var(--cyan);">No sensor connected</div>
                    </div>
                </div>

                <!-- DEVICE SELECTION -->
                <div style="background: rgba(96,165,250,0.05); border: 2px solid rgba(96,165,250,0.2); border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: var(--cyan); font-size: 1.3rem; margin-bottom: 20px; font-weight: 700; text-align: center;">📱 Connect Your Device</h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <!-- Polar H10 Card -->
                        <div style="background: white; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(239,68,68,0.15); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(239,68,68,0.25)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(239,68,68,0.15)'">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <div style="font-size: 2rem;">❤️</div>
                                <div>
                                    <div style="font-weight: 700; font-size: 1.1rem; color: #1f2937;">Polar H10</div>
                                    <div style="font-size: 0.85rem; color: #6b7280;">Chest Strap Monitor</div>
                                </div>
                            </div>
                            <div id="polarStatus" style="padding: 8px 12px; background: rgba(156,163,175,0.1); border-radius: 6px; font-size: 0.9rem; color: #6b7280; margin-bottom: 12px; font-weight: 600;">
                                🔴 Not Connected
                            </div>
                            <button id="polarConnectBtn" onclick="connectPolarH10()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                Connect Polar H10
                            </button>
                        </div>

                        <!-- Samsung Galaxy Watch Card -->
                        <div style="background: white; border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(59,130,246,0.15); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(59,130,246,0.25)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <div style="font-size: 2rem;">⌚</div>
                                <div>
                                    <div style="font-weight: 700; font-size: 1.1rem; color: #1f2937;">Samsung Watch</div>
                                    <div style="font-size: 0.85rem; color: #6b7280;">Galaxy Watch w/ ECG</div>
                                </div>
                            </div>
                            <div id="samsungStatus" style="padding: 8px 12px; background: rgba(156,163,175,0.1); border-radius: 6px; font-size: 0.9rem; color: #6b7280; margin-bottom: 12px; font-weight: 600;">
                                🔴 Not Connected
                            </div>
                            <button id="samsungConnectBtn" onclick="connectSamsungWatch()" style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                Connect Samsung Watch
                            </button>
                        </div>
                    </div>

                    <!-- Connected Device Info -->
                    <div id="deviceInfo" style="display: none; padding: 15px; background: rgba(34,197,94,0.1); border-left: 4px solid #22c55e; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 700; color: #22c55e; margin-bottom: 5px;">✓ Connected to <span id="connectedDeviceName"></span></div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Battery: <span id="deviceBattery">--</span>% | Signal: <span id="deviceSignal">Strong</span></div>
                            </div>
                            <button onclick="disconnectDevice()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">
                                Disconnect
                            </button>
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div style="display: flex; justify-content: center; gap: 20px;">
                        <button id="startHRBtn" onclick="startHRMonitoring()" disabled style="padding: 15px 40px; background: var(--good); color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(34,197,94,0.3); transition: all 0.2s; display: flex; align-items: center; gap: 10px; opacity: 0.5;">
                            <span>▶️</span>
                            <span>Start Monitoring</span>
                        </button>
                        <button id="stopHRBtn" onclick="stopHRMonitoring()" disabled style="padding: 15px 40px; background: var(--bad); color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(239,68,68,0.3); transition: all 0.2s; display: flex; align-items: center; gap: 10px; opacity: 0.5;">
                            <span>⏹️</span>
                            <span>Stop</span>
                        </button>
                    </div>
                </div>

                <!-- HEART RATE HISTORY CHART -->
                <div style="background: var(--card-bg); border: 2px solid rgba(96,165,250,0.2); border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: var(--cyan); font-size: 1.3rem; margin-bottom: 20px; font-weight: 700;">📈 Heart Rate History</h3>
                    <div class="chart-container">
                        <canvas id="hrMonitorChart"></canvas>
                    </div>
                </div>

                <!-- STATISTICS -->
                <div class="comparison-grid">
                    <div class="comparison-card">
                        <div class="comparison-title">Session Statistics</div>
                        <div class="metric-row">
                            <span class="metric-name">Average HR:</span>
                            <span class="metric-value" id="hrAverage">-- bpm</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Min HR:</span>
                            <span class="metric-value" id="hrMin">-- bpm</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Max HR:</span>
                            <span class="metric-value" id="hrMax">-- bpm</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-name">Duration:</span>
                            <span class="metric-value" id="hrDuration">0:00</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="comparison-title">Heart Rate Zones</div>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: rgba(34,197,94,0.1); border-radius: 6px;">
                                <span style="font-weight: 600; color: #22c55e;">🟢 Resting (< 60)</span>
                                <span id="zoneResting" style="font-weight: 700; color: #22c55e;">0%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: rgba(59,130,246,0.1); border-radius: 6px;">
                                <span style="font-weight: 600; color: #3b82f6;">🔵 Light (60-100)</span>
                                <span id="zoneLight" style="font-weight: 700; color: #3b82f6;">0%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: rgba(245,158,11,0.1); border-radius: 6px;">
                                <span style="font-weight: 600; color: #f59e0b;">🟠 Moderate (100-140)</span>
                                <span id="zoneModerate" style="font-weight: 700; color: #f59e0b;">0%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(239,68,68,0.1); border-radius: 6px;">
                                <span style="font-weight: 600; color: #ef4444;">🔴 High (> 140)</span>
                                <span id="zoneHigh" style="font-weight: 700; color: #ef4444;">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ECG DATA (Samsung Watch Only) -->
                <div id="ecgSection" style="display: block; background: var(--card-bg); border: 2px solid rgba(167,139,250,0.2); border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: var(--purple); font-size: 1.3rem; margin-bottom: 20px; font-weight: 700;">🫀 Samsung Watch - Advanced ECG Dashboard</h3>

                    <!-- ECG Metrics Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <div style="padding: 15px; background: rgba(167,139,250,0.1); border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">Rhythm</div>
                            <div id="ecgRhythm" style="font-size: 1.3rem; font-weight: 700; color: var(--purple);">--</div>
                        </div>
                        <div style="padding: 15px; background: rgba(167,139,250,0.1); border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">QRS Duration</div>
                            <div id="ecgQRS" style="font-size: 1.3rem; font-weight: 700; color: var(--purple);">-- ms</div>
                        </div>
                        <div style="padding: 15px; background: rgba(167,139,250,0.1); border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">R-R Interval</div>
                            <div id="ecgRR" style="font-size: 1.3rem; font-weight: 700; color: var(--purple);">-- ms</div>
                        </div>
                        <div style="padding: 15px; background: rgba(167,139,250,0.1); border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">HRV (SDNN)</div>
                            <div id="ecgHRV" style="font-size: 1.3rem; font-weight: 700; color: var(--purple);">-- ms</div>
                        </div>
                        <div style="padding: 15px; background: rgba(167,139,250,0.1); border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">RMSSD</div>
                            <div id="ecgRMSSD" style="font-size: 1.3rem; font-weight: 700; color: var(--purple);">-- ms</div>
                        </div>
                        <div style="padding: 15px; background: rgba(167,139,250,0.1); border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;">pNN50</div>
                            <div id="ecgPNN50" style="font-size: 1.3rem; font-weight: 700; color: var(--purple);">-- %</div>
                        </div>
                    </div>

                    <!-- Additional Samsung Watch Metrics -->
                    <div style="background: rgba(59,130,246,0.05); border-radius: 8px; padding: 20px; margin-top: 20px;">
                        <h4 style="color: #3b82f6; font-size: 1.1rem; margin-bottom: 15px; font-weight: 700;">📊 Detailed Watch Metrics</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 5px;">SpO2 Level</div>
                                <div id="watchSpO2" style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">-- %</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 5px;">Stress Level</div>
                                <div id="watchStress" style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 5px;">Resp. Rate</div>
                                <div id="watchRespRate" style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">-- bpm</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 5px;">VO2 Max Est.</div>
                                <div id="watchVO2" style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DATA OVERRIDE SECTION -->
                <div id="overrideSection" style="display: none; background: rgba(239,68,68,0.05); border: 2px solid rgba(239,68,68,0.2); border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: #ef4444; font-size: 1.3rem; margin-bottom: 15px; font-weight: 700;">⚠️ Override Therapy Session Data</h3>
                    <p style="color: var(--muted); line-height: 1.6; margin-bottom: 20px;">
                        Click the button below to transfer the current monitoring session data to the Data Entry tab.
                        This will <strong>override</strong> any existing therapy session data with the real-time measurements from your connected device.
                    </p>

                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button onclick="overrideTherapyData()" style="padding: 15px 30px; background: #ef4444; color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(239,68,68,0.3); transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                            🔄 Override Therapy Session Data
                        </button>
                        <div style="padding: 10px 15px; background: rgba(96,165,250,0.1); border-radius: 8px; font-size: 0.9rem; color: var(--muted);">
                            <strong>Current Session:</strong> <span id="overrideSessionInfo">No active session</span>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: rgba(96,165,250,0.1); border-left: 4px solid var(--cyan); border-radius: 6px;">
                        <strong style="color: var(--cyan);">ℹ️ What gets transferred:</strong>
                        <ul style="margin: 10px 0 0 20px; color: var(--muted); line-height: 1.8;">
                            <li><strong>Resting HR:</strong> Average heart rate from session</li>
                            <li><strong>Max HR:</strong> Maximum recorded heart rate</li>
                            <li><strong>HR Recovery:</strong> Calculated from session end</li>
                            <li><strong>HRV Metrics:</strong> SDNN, RMSSD, pNN50 (if available)</li>
                            <li><strong>Samsung Watch Only:</strong> SpO2, Respiratory Rate, VO2 Max estimate</li>
                        </ul>
                    </div>
                </div>

                <!-- INSTRUCTIONS -->
                <div style="margin-top: 30px; padding: 20px; background: rgba(96,165,250,0.05); border-left: 4px solid var(--cyan); border-radius: 8px;">
                    <h3 style="color: var(--cyan); font-size: 1.1rem; margin-bottom: 12px; font-weight: 700;">💡 Device Setup Instructions</h3>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #ef4444; font-weight: 700; margin-bottom: 10px;">❤️ Polar H10 Setup:</h4>
                        <ol style="color: var(--muted); line-height: 1.8; margin-left: 20px;">
                            <li>Moisten the electrode pads on the chest strap</li>
                            <li>Wear the strap directly on skin, just below chest muscles</li>
                            <li>Make sure the Polar H10 sensor is securely clipped to the strap</li>
                            <li>The sensor will automatically turn on when worn</li>
                            <li>Click "Connect Polar H10" above and select your device (shows as "Polar H10 XXXXXXXX")</li>
                            <li>Once connected, press "Start Monitoring" to begin tracking</li>
                        </ol>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #3b82f6; font-weight: 700; margin-bottom: 10px;">⌚ Samsung Galaxy Watch Setup:</h4>
                        <ol style="color: var(--muted); line-height: 1.8; margin-left: 20px;">
                            <li>Ensure your Galaxy Watch is charged and worn securely on your wrist</li>
                            <li>On your watch: Settings → Connections → Bluetooth → Advanced → Bluetooth Sharing → Enable</li>
                            <li>Make sure the watch is not currently paired with Samsung Health on your phone (temporarily disconnect if needed)</li>
                            <li>Click "Connect Samsung Watch" above and select your watch from the list</li>
                            <li>Grant permission for heart rate monitoring when prompted</li>
                            <li>For ECG readings: Follow the on-watch prompts to place your finger on the button</li>
                        </ol>
                    </div>

                    <div style="padding: 15px; background: rgba(239,68,68,0.1); border-left: 4px solid #ef4444; border-radius: 6px; margin-top: 20px;">
                        <h4 style="color: #ef4444; font-weight: 700; margin-bottom: 8px;">⚠️ Important Medical Note:</h4>
                        <p style="color: var(--muted); line-height: 1.6; margin: 0;">
                            <strong>This app is for health monitoring only and should not replace professional medical advice.</strong>
                            If your wife experiences chest pain, shortness of breath, irregular heartbeat, dizziness, or any concerning symptoms,
                            seek immediate medical attention. Always consult with your healthcare provider before starting any new exercise program.
                            The ECG feature on Samsung Watch can detect AFib but is not a substitute for professional ECG interpretation.
                        </p>
                    </div>

                    <div style="padding: 15px; background: rgba(96,165,250,0.1); border-left: 4px solid var(--cyan); border-radius: 6px; margin-top: 15px;">
                        <h4 style="color: var(--cyan); font-weight: 700; margin-bottom: 8px;">🔋 Battery Tips:</h4>
                        <ul style="color: var(--muted); line-height: 1.6; margin: 8px 0 0 20px;">
                            <li><strong>Polar H10:</strong> Replaceable CR2025 battery lasts ~400 hours. Low battery warning will appear when below 10%</li>
                            <li><strong>Samsung Watch:</strong> Continuous HR monitoring drains battery faster. Charge daily for reliable readings</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDUCATION TAB -->
        <div class="tab-content" id="education" role="tabpanel" aria-labelledby="tab-education">
            <div class="section">
                <h2 style="color: var(--accent); text-align: center; font-size: 2rem; margin-bottom: 10px;">📚 Understanding Your Cardiac Health Metrics</h2>
                <p style="text-align: center; color: var(--muted); font-size: 1.1rem; margin-bottom: 40px;">A comprehensive guide to all the medical terms and measurements used in this app</p>

                <!-- CARDIOVASCULAR FITNESS METRICS -->
                <div style="margin-bottom: 50px;">
                    <h3 style="color: var(--purple); font-size: 1.8rem; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 3px solid var(--purple);">💪 Cardiovascular Fitness Metrics</h3>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">VO2 Max (Maximal Oxygen Consumption)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> VO2 Max stands for "Volume of Oxygen Maximum" - the maximum amount of oxygen your body can use during intense exercise.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> How efficiently your heart, lungs, and muscles work together to deliver and use oxygen during physical activity. Measured in milliliters of oxygen per kilogram of body weight per minute (ml/kg/min).</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Higher VO2 Max = better cardiovascular fitness and endurance. It's the gold standard for measuring aerobic fitness and heart recovery after surgery.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">How it's tested:</strong> Usually measured during a cardiopulmonary exercise test (CPET) where you exercise on a treadmill or bike while wearing a mask that measures oxygen and CO2.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Excellent: >28 ml/kg/min | Good: 24-28 | Fair: 20-24 | Poor: <20</p>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 8px;">
                            <p style="margin: 0; font-style: italic; color: #1a1a1a; font-weight: 700;"><strong>Note:</strong> "Expected VO2 (Generic)" in the app refers to the average expected VO2 Max for someone at your recovery stage, based on general cardiac rehab population data rather than your personal baseline.</p>
                        </div>
                    </div>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">METs (Metabolic Equivalents of Task)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> A way to measure the energy cost of physical activities relative to rest.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> How much oxygen your body uses during activity compared to sitting quietly. 1 MET = resting oxygen consumption (about 3.5 ml/kg/min).</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Helps determine safe exercise intensity levels. After cardiac surgery, you'll gradually increase from low METs (2-3) to higher levels (7-10+).</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Excellent: >10 METs | Good: 7-10 | Fair: 5-7 | Poor: <5<br>
                        <span style="color: var(--muted); font-size: 0.95rem;">Examples: Walking slowly = 2-3 METs | Brisk walking = 4-5 METs | Jogging = 7-8 METs | Running = 10+ METs</span></p>
                    </div>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">6-Minute Walk Distance (6MWD)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> The maximum distance you can walk in 6 minutes at your own pace.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Functional exercise capacity and endurance - a practical measure of how well you can perform daily activities.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Simple, safe test that correlates well with quality of life and recovery progress. Easy to perform at home or in rehab.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Excellent: >500 meters | Good: 400-500m | Fair: 300-400m | Poor: <300m</p>
                    </div>
                </div>

                <!-- HEART RATE METRICS -->
                <div style="margin-bottom: 50px;">
                    <h3 style="color: var(--purple); font-size: 1.8rem; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 3px solid var(--purple);">❤️ Heart Rate Metrics</h3>

                    <div style="background: rgba(167,139,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--purple);">
                        <h4 style="color: var(--purple); font-size: 1.4rem; margin-bottom: 15px;">Resting Heart Rate (RHR)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> Your heart rate when completely at rest, typically measured first thing in the morning or after 5 minutes of quiet sitting.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> How many times your heart beats per minute (bpm) at rest. A lower RHR generally indicates better cardiovascular fitness.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Tracks heart recovery and efficiency. As your heart gets stronger, it pumps more blood per beat, so it doesn't need to beat as often.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Excellent: 50-60 bpm | Good: 60-70 bpm | Average: 70-80 bpm | Concerning: >100 bpm</p>
                    </div>

                    <div style="background: rgba(167,139,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--purple);">
                        <h4 style="color: var(--purple); font-size: 1.4rem; margin-bottom: 15px;">Maximum Heart Rate (Max HR)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> The highest heart rate you achieve during maximum physical effort.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Your heart's upper limit during intense exercise. Used to calculate safe exercise target zones.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Helps determine personalized exercise intensity zones. After cardiac surgery, you'll exercise at controlled percentages of max HR (usually 60-80%).</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Estimation formula:</strong> 220 - your age = estimated max HR<br>
                        <span style="color: var(--muted); font-size: 0.95rem;">Example: 65 years old = 220 - 65 = 155 max HR</span></p>
                    </div>

                    <div style="background: rgba(167,139,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--purple);">
                        <h4 style="color: var(--purple); font-size: 1.4rem; margin-bottom: 15px;">Heart Rate Recovery (HRR)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> How much your heart rate drops in the first minute after stopping exercise.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> The difference between your peak exercise heart rate and your heart rate 1 minute after stopping. Measured in beats per minute (bpm).</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Strong predictor of cardiovascular health and mortality risk. A faster recovery indicates better autonomic nervous system function and heart health.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Excellent: >25 bpm drop | Good: 20-25 bpm | Fair: 15-20 bpm | Concerning: <12 bpm</p>
                    </div>
                </div>

                <!-- HRV METRICS -->
                <div style="margin-bottom: 50px;">
                    <h3 style="color: var(--purple); font-size: 1.8rem; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 3px solid var(--purple);">📊 Heart Rate Variability (HRV) Metrics</h3>

                    <div style="background: rgba(250,204,21,0.1); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid rgba(250,204,21,0.3);">
                        <p style="margin: 0; line-height: 1.8;"><strong style="color: var(--accent);">What is HRV?</strong> Heart Rate Variability measures the variation in time between heartbeats. A healthy heart doesn't beat like a metronome - there are tiny variations that reflect your autonomic nervous system's balance. Higher HRV generally indicates better stress resilience and cardiovascular health.</p>
                    </div>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">SDNN (Standard Deviation of NN Intervals)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> The standard deviation of the time between consecutive heartbeats over a recording period.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Overall heart rate variability and autonomic nervous system function. Measured in milliseconds (ms).</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Reflects your body's ability to adapt to stress. Low SDNN is linked to higher cardiovascular risk; improving SDNN shows better recovery and adaptation.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Excellent: >50 ms | Good: 35-50 ms | Fair: 25-35 ms | Poor: <25 ms</p>
                    </div>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">RMSSD (Root Mean Square of Successive Differences)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> The square root of the mean of the squared differences between consecutive heartbeats.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Short-term heart rate variability, specifically parasympathetic (rest-and-digest) nervous system activity. Measured in milliseconds (ms).</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Indicates recovery readiness and stress levels. Higher RMSSD means better recovery capacity and stress resilience.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Excellent: >40 ms | Good: 30-40 ms | Fair: 20-30 ms | Poor: <20 ms</p>
                    </div>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">pNN50 (Percentage of Successive Intervals >50ms)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> The percentage of consecutive heartbeat intervals that differ by more than 50 milliseconds.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Parasympathetic nervous system activity and vagal tone (the calming part of your nervous system).</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Higher values indicate better parasympathetic control and recovery capacity. Important for stress management and cardiovascular health.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Excellent: >20% | Good: 10-20% | Fair: 5-10% | Poor: <5%</p>
                    </div>
                </div>

                <!-- CARDIAC FUNCTION -->
                <div style="margin-bottom: 50px;">
                    <h3 style="color: var(--purple); font-size: 1.8rem; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 3px solid var(--purple);">🫀 Cardiac Function Metrics</h3>

                    <div style="background: rgba(220,38,38,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--bad);">
                        <h4 style="color: var(--bad); font-size: 1.4rem; margin-bottom: 15px;">Ejection Fraction (EF)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> The percentage of blood pumped out of your heart's left ventricle with each beat.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> How efficiently your heart pumps blood. If your EF is 60%, your heart pumps out 60% of the blood in the left ventricle with each beat.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Key indicator of heart muscle strength and pump function. Often affected by heart attacks, heart failure, or valve disease.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">How it's tested:</strong> Measured via echocardiogram (ultrasound of heart), cardiac MRI, or nuclear stress test.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Normal: 50-70% | Borderline: 41-49% | Reduced: 40% or below | Severely Reduced: <30%</p>
                    </div>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">Blood Pressure (BP)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> The force of blood pushing against artery walls as your heart pumps.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Two numbers - Systolic (top number): pressure when heart beats | Diastolic (bottom number): pressure when heart rests between beats. Measured in mmHg (millimeters of mercury).</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> High blood pressure strains your heart and blood vessels, increasing risk of heart attack, stroke, and heart failure. Critical to monitor after cardiac surgery.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Optimal: <120/80 | Elevated: 120-129/<80 | Stage 1 Hypertension: 130-139/80-89 | Stage 2: ≥140/90<br>
                        <span style="color: var(--bad); font-weight: 600;">⚠️ Seek immediate care if >180/120</span></p>
                    </div>
                </div>

                <!-- RESPIRATORY METRICS -->
                <div style="margin-bottom: 50px;">
                    <h3 style="color: var(--purple); font-size: 1.8rem; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 3px solid var(--purple);">🫁 Respiratory Metrics</h3>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">Oxygen Saturation (SpO2)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> The percentage of oxygen-carrying hemoglobin in your blood.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> How well oxygen is being delivered to your body's tissues. Measured with a pulse oximeter (finger clip device).</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Ensures your heart and lungs are effectively delivering oxygen. Important to monitor during exercise and recovery.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Normal: 95-100% | Concerning: <95% | Seek care: <90%</p>
                    </div>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">Respiratory Rate</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> The number of breaths you take per minute while at rest.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Breathing frequency. Count breaths for 60 seconds while sitting quietly.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Elevated respiratory rate can indicate heart failure, lung problems, or infection. Should be monitored during recovery.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Healthy targets:</strong> Normal: 12-20 breaths/min | Concerning: >20 | Seek care: >24 or <10</p>
                    </div>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">Dyspnea (Shortness of Breath)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> The medical term for difficulty breathing or shortness of breath.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Your subjective rating of breathing difficulty on a 0-10 scale. Often uses the Borg Scale or similar rating systems.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Common after cardiac surgery; tracking changes helps identify improvement or potential complications. Sudden worsening requires immediate medical attention.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Score guide:</strong> 0 = No breathlessness | 1-3 = Mild | 4-6 = Moderate | 7-9 = Severe | 10 = Maximum/Unable to breathe<br>
                        <span style="color: var(--bad); font-weight: 600;">⚠️ Seek immediate care if dyspnea is sudden, severe, or accompanied by chest pain</span></p>
                    </div>
                </div>

                <!-- SYMPTOM METRICS -->
                <div style="margin-bottom: 50px;">
                    <h3 style="color: var(--purple); font-size: 1.8rem; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 3px solid var(--purple);">🩺 Symptom Assessment Metrics</h3>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">Edema (Swelling)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> Swelling caused by excess fluid trapped in body tissues, especially in feet, ankles, and legs.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Severity of fluid retention, rated 0-4. Press on swollen area for 5 seconds - if indent remains, that's "pitting edema."</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Can indicate heart failure, medication effects, or circulation problems. Important warning sign to monitor after cardiac surgery.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Score guide:</strong> 0 = No swelling | 1 = Mild (<2mm indent) | 2 = Moderate (2-4mm) | 3 = Severe (4-6mm) | 4 = Very severe (6-8mm)</p>
                    </div>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">RPE (Rate of Perceived Exertion)</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> How hard you feel your body is working during exercise. Also called the Borg Scale.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Your subjective feeling of effort, fatigue, and strain on a 1-10 scale (or sometimes 6-20 scale).</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Simple way to monitor exercise intensity without equipment. During cardiac rehab, you'll typically aim for RPE 3-6 (moderate intensity).</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Score guide (0-10):</strong> 0 = No effort | 1-2 = Very light | 3-4 = Light | 5-6 = Moderate | 7-8 = Vigorous | 9-10 = Maximum effort</p>
                    </div>
                </div>

                <!-- QUALITY OF LIFE -->
                <div style="margin-bottom: 50px;">
                    <h3 style="color: var(--purple); font-size: 1.8rem; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 3px solid var(--purple);">😊 Quality of Life Metrics</h3>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">Quality of Life Score</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> An overall rating of your well-being, life satisfaction, and ability to do daily activities.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Combines physical, mental, emotional, and social aspects of health on a 0-100 scale.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Recovery isn't just about physical metrics - mental and emotional health are equally important. Tracking QOL helps ensure holistic recovery.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Score guide:</strong> Excellent: 80-100 | Good: 60-79 | Fair: 40-59 | Poor: 20-39 | Very Poor: 0-19</p>
                    </div>

                    <div style="background: rgba(96,165,250,0.08); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--cyan);">
                        <h4 style="color: var(--cyan); font-size: 1.4rem; margin-bottom: 15px;">Sleep Quality</h4>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it means:</strong> How well you slept the previous night, including sleep duration and restfulness.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">What it measures:</strong> Subjective sleep quality on a 0-10 scale, considering factors like sleep latency (time to fall asleep), awakenings, and feeling rested.</p>
                        <p style="margin-bottom: 12px; line-height: 1.8;"><strong style="color: var(--accent);">Why it matters:</strong> Poor sleep impairs recovery, increases stress, affects heart health, and reduces exercise performance. Essential for healing after surgery.</p>
                        <p style="margin-bottom: 0; line-height: 1.8;"><strong style="color: var(--good);">Score guide:</strong> Excellent: 8-10 | Good: 6-7 | Fair: 4-5 | Poor: 0-3<br>
                        <span style="color: var(--muted); font-size: 0.95rem;">💡 Tip: Aim for 7-9 hours of sleep per night for optimal heart recovery</span></p>
                    </div>
                </div>

                <!-- QUICK REFERENCE -->
                <div style="background: linear-gradient(135deg, rgba(96,165,250,0.15), rgba(167,139,250,0.15)); padding: 30px; border-radius: 16px; border: 3px solid var(--accent);">
                    <h3 style="color: var(--accent); font-size: 1.6rem; margin-bottom: 20px; text-align: center;">📋 Quick Reference: When to Contact Your Doctor</h3>
                    <div style="display: grid; gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 5px solid var(--bad);">
                            <strong style="color: var(--bad);">🚨 IMMEDIATE (Call 911):</strong> <span style="color: #1a1a1a; font-weight: 600;">Chest pain, severe shortness of breath, fainting, heart rate >150 or <40, blood pressure >180/120</span>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 5px solid orange;">
                            <strong style="color: orange;">⚠️ URGENT (Contact doctor same day):</strong> <span style="color: #1a1a1a; font-weight: 600;">Sudden weight gain >3 lbs in 24h, worsening edema, chest pain score >3, dyspnea at rest, irregular heartbeat</span>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 5px solid var(--cyan);">
                            <strong style="color: var(--cyan);">💡 ROUTINE (Discuss at next visit):</strong> <span style="color: #1a1a1a; font-weight: 600;">Gradual trends in metrics, questions about exercise progression, medication adjustments, quality of life concerns</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 40px; padding: 25px; background: rgba(167,139,250,0.1); border-radius: 12px; text-align: center;">
                    <p style="font-size: 1.1rem; line-height: 1.8; color: var(--text); margin: 0;">
                        <strong style="color: var(--purple);">Remember:</strong> These metrics are tools to track your progress and communicate with your healthcare team.
                        Always follow your doctor's specific recommendations for your individual recovery plan. Every person's recovery journey is unique! 💜
                    </p>
                </div>
            </div>
        </div>
        </main>
    </div>

    <div class="notification" id="notification" role="status" aria-live="polite" aria-atomic="true"></div>

    <!-- CLINICAL ALERT MODAL -->
    <div class="alert-modal" id="alertModal">
        <div class="alert-modal-content">
            <div class="alert-icon">🚨</div>
            <div class="alert-title">Medical Alert</div>
            <div class="alert-message" id="alertMessage"></div>
            <div class="alert-details" id="alertDetails"></div>
            <div class="alert-buttons">
                <button class="alert-btn-danger" onclick="acknowledgeAlert()">I Understand - Save Anyway</button>
                <button class="alert-btn-secondary" onclick="closeAlert()">Cancel & Review Data</button>
            </div>
        </div>
    </div>

    <!-- FOOTER WITH COPYRIGHT AND TRADEMARK -->
    <footer style="background: rgba(15, 23, 42, 0.95); border-top: 2px solid rgba(96, 165, 250, 0.2); padding: 30px 20px; margin-top: 60px; text-align: center; font-size: 0.85rem; color: var(--muted);">
        <div style="max-width: 1200px; margin: 0 auto;">
            <!-- Branding Section -->
            <div style="margin-bottom: 20px;">
                <div style="font-size: 1.1rem; font-weight: 600; color: var(--accent); margin-bottom: 8px;">
                    Cardiac Recovery Pro™
                </div>
                <div style="font-size: 0.75rem; opacity: 0.8;">
                    Complete Recovery Tracking & Analytics System
                </div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 4px;">
                    Powered by our exclusive <span style="color: var(--accent); font-weight: 600;">PULSE</span> Technology™
                </div>
                <div style="font-size: 0.7rem; opacity: 0.7; font-style: italic;">
                    Personal Universal Life Support Engine
                </div>
            </div>

            <!-- Divider -->
            <div style="height: 1px; background: rgba(96, 165, 250, 0.2); margin: 20px auto; max-width: 600px;"></div>

            <!-- Legal Links Section -->
            <div style="margin: 20px 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; font-size: 0.8rem;">
                <a href="https://heartbeat-claude-code.vercel.app/disclosures.html#privacy-policy" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Privacy Policy</a>
                <span style="color: rgba(148, 163, 184, 0.3);">|</span>
                <a href="https://heartbeat-claude-code.vercel.app/disclosures.html#terms-of-service" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Terms of Service</a>
                <span style="color: rgba(148, 163, 184, 0.3);">|</span>
                <a href="https://heartbeat-claude-code.vercel.app/disclosures.html#contact" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Contact Support</a>
            </div>

            <!-- Medical Disclaimer -->
            <div style="margin: 20px auto; padding: 15px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; max-width: 800px; font-size: 0.75rem; line-height: 1.6;">
                <div style="font-weight: 600; color: #fca5a5; margin-bottom: 8px;">⚕️ Medical Disclaimer</div>
                <div style="color: #fca5a5; opacity: 0.9;">
                    This application is for informational and fitness tracking purposes only. It is not intended to diagnose, treat, cure, or prevent any disease.
                    Always consult with a qualified healthcare professional regarding any medical condition or treatment. In case of a medical emergency, call 911 immediately.
                </div>
            </div>

            <!-- Copyright and Trademark -->
            <div style="margin-top: 20px; font-size: 0.75rem; line-height: 1.8;">
                <div style="margin-bottom: 8px;">
                    © 2025 <span style="font-weight: 600; color: var(--accent);">Heartbeat Health Technologies</span>. All rights reserved.
                </div>
                <div style="opacity: 0.7;">
                    Cardiac Recovery Pro™, PULSE Technology™, and associated logos are trademarks of Heartbeat Health Technologies.
                </div>
                <div style="opacity: 0.6; margin-top: 8px; font-size: 0.7rem;">
                    Patents pending. Unauthorized reproduction or distribution is prohibited.
                </div>
            </div>

            <!-- Version Info -->
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(96, 165, 250, 0.1); font-size: 0.7rem; opacity: 0.5;">
                Version 1.0.0 | Built with ❤️ for cardiac recovery patients worldwide
            </div>
        </div>
    </footer>

    <script>
        // DATA STORAGE WITH ERROR HANDLING
        let allData = {};
        let surgeryDateStr = null;
        let patientName = null; // Can be populated from master app data when unified
        let currentDate = new Date();
        let storageAvailable = true;

        // Safely load data from localStorage
        try {
            const storedData = localStorage.getItem('cardiacRecoveryData');
            allData = storedData ? JSON.parse(storedData) : {};
            surgeryDateStr = localStorage.getItem('surgeryDate');
            patientName = localStorage.getItem('patientName');
        } catch (error) {
            console.error('localStorage error on load:', error);
            storageAvailable = false;
            showNotification('⚠️ Using temporary storage - data may not persist. Check browser settings.', 'error');
        }

        // AUTOCOMPLETE DATA
        const exerciseTypes = [
            'Walking', 'Treadmill', 'Cycling', 'Stationary Bike', 'Swimming',
            'Elliptical', 'Rowing', 'Stairs', 'Resistance Training', 'Yoga'
        ];

        // INITIALIZE
        function init() {
            updateDateDisplay();
            if (surgeryDateStr) {
                document.getElementById('surgeryDate').value = surgeryDateStr;
                updateRecoveryInfo();
            }
            if (patientName) {
                document.getElementById('patientName').value = patientName;
                updateWelcomeMessage();
            }
            loadPatientDemographics(); // Load patient demographics
            updateDashboard();
            updateWeeklyMilestones();
            refreshHistoryTable();
            refreshSessionsTable();
            initializeCharts();
            attachValidationListeners();
            initSwipeGestures();
        }

        // DATE NAVIGATION
        function navigateDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateDisplay();
        }

        function updateDateDisplay() {
            const dateStr = currentDate.toISOString().split('T')[0];
            document.getElementById('currentDate').textContent =
                currentDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('entryDate').textContent = dateStr;
            document.getElementById('datePicker').value = dateStr;
            loadDataForDate(dateStr);
        }

        document.getElementById('datePicker').addEventListener('change', function(e) {
            currentDate = new Date(e.target.value + 'T00:00:00');
            updateDateDisplay();
        });

        // SWIPE GESTURES FOR MOBILE DATE NAVIGATION
        function initSwipeGestures() {
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            const minSwipeDistance = 50; // Minimum distance for swipe (px)
            const maxVerticalDistance = 100; // Max vertical movement allowed

            const container = document.querySelector('.container');

            container.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            container.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;

                const horizontalDistance = touchEndX - touchStartX;
                const verticalDistance = Math.abs(touchEndY - touchStartY);

                // Only trigger if horizontal swipe is dominant
                if (verticalDistance < maxVerticalDistance) {
                    // Swipe left = next day
                    if (horizontalDistance < -minSwipeDistance) {
                        navigateDate(1);
                    }
                    // Swipe right = previous day
                    if (horizontalDistance > minSwipeDistance) {
                        navigateDate(-1);
                    }
                }
            }, { passive: true });
        }

        // RECOVERY DAY 1
        function setRecoveryDay1() {
            const date = document.getElementById('surgeryDate').value;
            if (!date) {
                showNotification('Please select a surgery date', 'error');
                return;
            }
            surgeryDateStr = date;

            // Save with error handling
            try {
                localStorage.setItem('surgeryDate', date);
            } catch (error) {
                console.error('Error saving surgery date:', error);
                showNotification('⚠️ Could not save surgery date persistently', 'error');
            }

            updateRecoveryInfo();
            updateDashboard();
            updateWeeklyMilestones();
            showNotification('Recovery Day 1 set!', 'success');
        }

        // PATIENT NAME FUNCTIONS
        function savePatientName() {
            const name = document.getElementById('patientName').value.trim();
            patientName = name;

            // Save with error handling
            try {
                if (name) {
                    localStorage.setItem('patientName', name);
                    showNotification('✅ Patient name saved', 'success');
                } else {
                    localStorage.removeItem('patientName');
                }
            } catch (error) {
                console.error('Error saving patient name:', error);
                showNotification('⚠️ Could not save patient name persistently', 'error');
            }

            updateWelcomeMessage();
        }

        function updateWelcomeMessage() {
            const welcomeElement = document.getElementById('welcomeMessage');
            if (patientName && patientName.trim()) {
                welcomeElement.textContent = `Welcome, ${patientName}! 👋`;
            } else {
                welcomeElement.textContent = '';
            }
        }

        // PUBLIC API: Set patient name programmatically (for master app integration)
        function setPatientNameFromApp(name) {
            if (name && typeof name === 'string') {
                patientName = name.trim();
                document.getElementById('patientName').value = patientName;

                try {
                    localStorage.setItem('patientName', patientName);
                } catch (error) {
                    console.error('Error saving patient name from app:', error);
                }

                updateWelcomeMessage();
                return true;
            }
            return false;
        }

        // ============================================================================
        // PATIENT DEMOGRAPHICS FUNCTIONS (for CRPS calculation)
        // ============================================================================

        let patientDemographics = {
            age: null,
            sex: null,
            height: null,
            weight: null,
            fromMainApp: false
        };

        // Load demographics from localStorage on init
        try {
            const storedDemo = localStorage.getItem('patientDemographics');
            if (storedDemo) {
                patientDemographics = JSON.parse(storedDemo);
            }
        } catch (error) {
            console.error('Error loading patient demographics:', error);
        }

        /**
         * Save patient demographics to localStorage
         */
        function savePatientDemographics() {
            const age = document.getElementById('patientAge').value;
            const sex = document.getElementById('patientSex').value;
            const height = document.getElementById('patientHeight').value;
            const weight = document.getElementById('patientWeight').value;

            // Update demographics object
            patientDemographics = {
                age: age ? parseInt(age) : null,
                sex: sex || null,
                height: height ? parseFloat(height) : null,
                weight: weight ? parseFloat(weight) : null,
                fromMainApp: patientDemographics.fromMainApp // Preserve source
            };

            // Save to localStorage
            try {
                localStorage.setItem('patientDemographics', JSON.stringify(patientDemographics));
                showNotification('✅ Demographics saved for CRPS calculation', 'success');
            } catch (error) {
                console.error('Error saving patient demographics:', error);
                showNotification('⚠️ Could not save demographics persistently', 'error');
            }

            // Recalculate CRPS for all existing data with new demographics
            recalculateAllCRPS();
        }

        /**
         * Load patient demographics into form fields
         */
        function loadPatientDemographics() {
            if (patientDemographics.age) {
                document.getElementById('patientAge').value = patientDemographics.age;
            }
            if (patientDemographics.sex) {
                document.getElementById('patientSex').value = patientDemographics.sex;
            }
            if (patientDemographics.height) {
                document.getElementById('patientHeight').value = patientDemographics.height;
            }
            if (patientDemographics.weight) {
                document.getElementById('patientWeight').value = patientDemographics.weight;
            }

            // Show source indicator if from main app
            if (patientDemographics.fromMainApp) {
                document.getElementById('demographicsSource').style.display = 'inline-block';
            }
        }

        /**
         * Get current demographics (with defaults if not set)
         */
        function getCurrentDemographics() {
            return {
                age: patientDemographics.age || 50, // Default age
                sex: patientDemographics.sex || 'female', // Default sex
                height: patientDemographics.height || 170, // Default height in cm
                weight: patientDemographics.weight || 70 // Default weight in kg
            };
        }

        /**
         * Recalculate CRPS for all existing data when demographics change
         */
        function recalculateAllCRPS() {
            const demographics = getCurrentDemographics();
            let updated = 0;

            // Recalculate for all dates with data
            Object.keys(allData).forEach(dateStr => {
                const metrics = allData[dateStr];

                // Skip if no metrics or already has CRPS
                if (!metrics || Object.keys(metrics).length === 0) return;

                try {
                    const crpsResult = calculateCRPS(
                        metrics,
                        demographics.age,
                        demographics.height,
                        demographics.sex
                    );

                    metrics.crpsScore = crpsResult.total;
                    metrics.crpsBreakdown = crpsResult;
                    allData[dateStr] = metrics;
                    updated++;
                } catch (error) {
                    console.error(`Error recalculating CRPS for ${dateStr}:`, error);
                }
            });

            // Save updated data
            if (updated > 0) {
                try {
                    localStorage.setItem('cardiacRecoveryData', JSON.stringify(allData));
                    console.log(`Recalculated CRPS for ${updated} dates`);

                    // Update displays
                    updateDashboard();
                    updateCharts();
                } catch (error) {
                    console.error('Error saving recalculated data:', error);
                }
            }
        }

        /**
         * PUBLIC API: Set patient demographics from main Heartbeat app
         * @param {Object} demographics - { age, sex, height, weight }
         * @returns {Boolean} success
         */
        function setPatientDemographicsFromApp(demographics) {
            if (!demographics || typeof demographics !== 'object') {
                return false;
            }

            try {
                // Update demographics object
                patientDemographics = {
                    age: demographics.age ? parseInt(demographics.age) : null,
                    sex: demographics.sex || null,
                    height: demographics.height ? parseFloat(demographics.height) : null,
                    weight: demographics.weight ? parseFloat(demographics.weight) : null,
                    fromMainApp: true // Mark as from main app
                };

                // Update form fields
                if (patientDemographics.age) {
                    document.getElementById('patientAge').value = patientDemographics.age;
                }
                if (patientDemographics.sex) {
                    document.getElementById('patientSex').value = patientDemographics.sex;
                }
                if (patientDemographics.height) {
                    document.getElementById('patientHeight').value = patientDemographics.height;
                }
                if (patientDemographics.weight) {
                    document.getElementById('patientWeight').value = patientDemographics.weight;
                }

                // Show source indicator
                document.getElementById('demographicsSource').style.display = 'inline-block';

                // Save to localStorage
                localStorage.setItem('patientDemographics', JSON.stringify(patientDemographics));

                // Recalculate CRPS with new demographics
                recalculateAllCRPS();

                console.log('✅ Patient demographics set from Heartbeat app:', patientDemographics);
                return true;
            } catch (error) {
                console.error('Error setting patient demographics from app:', error);
                return false;
            }
        }

        function updateRecoveryInfo() {
            if (!surgeryDateStr) return;

            const surgeryDate = new Date(surgeryDateStr + 'T00:00:00');
            const today = new Date(currentDate.toISOString().split('T')[0] + 'T00:00:00');
            const daysDiff = Math.floor((today - surgeryDate) / (1000 * 60 * 60 * 24));
            const weeksDiff = Math.floor(daysDiff / 7);

            document.getElementById('recoveryDay').textContent = daysDiff >= 0 ? `Day ${daysDiff + 1}` : 'Before Surgery';
            document.getElementById('weeksPostOp').textContent = weeksDiff >= 0 ? weeksDiff : 0;
            document.getElementById('statsWeeks').textContent = weeksDiff >= 0 ? weeksDiff : 0;

            let phase = 'Pre-Surgery';
            if (daysDiff >= 0 && daysDiff < 14) phase = 'Phase 1: Hospital/Early';
            else if (daysDiff >= 14 && daysDiff < 28) phase = 'Phase 2: Early Mobilization';
            else if (daysDiff >= 28 && daysDiff < 56) phase = 'Phase 3: Progressive Training';
            else if (daysDiff >= 56 && daysDiff < 84) phase = 'Phase 4: Advanced Training';
            else if (daysDiff >= 84) phase = 'Phase 5: Return to Function';

            document.getElementById('recoveryPhase').textContent = phase;
        }

        // ============================================================================
        // CARDIAC RECOVERY PROBABILITY SCORE (CRPS) - EVIDENCE-BASED ALGORITHM
        // ============================================================================

        /**
         * Calculate Cardiac Recovery Probability Score (CRPS)
         * Based on clinical literature: STS Database, 6MWT norms, METs age-adjusted,
         * HRV cardiac surgery research, AHA/ACC 2024 Guidelines
         *
         * @param {Object} metrics - Patient metrics from data entry
         * @param {Number} age - Patient age for age-adjusted calculations
         * @param {Number} height - Patient height in cm (for 6MWT prediction)
         * @param {String} sex - Patient sex ('male' or 'female') for 6MWT prediction
         * @returns {Object} - Score breakdown with total, categories, and interpretation
         */
        function calculateCRPS(metrics, age = 50, height = 170, sex = 'female') {
            const breakdown = {
                total: 0,
                functionalCapacity: 0,
                cardiovascularHealth: 0,
                symptomBurden: 0,
                qualityOfLife: 0,
                riskModifiers: 0,
                details: {},
                interpretation: '',
                probability: '',
                colorCode: ''
            };

            // CATEGORY 1: FUNCTIONAL CAPACITY (35 points max)

            // METs Score (0-15 points) - Age-Adjusted
            if (metrics.mets !== undefined) {
                const expectedMETs = 18.0 - (0.15 * age);
                const metsPercentage = (metrics.mets / expectedMETs) * 100;

                let metsScore = 0;
                if (metsPercentage >= 110) metsScore = 15;
                else if (metsPercentage >= 100) metsScore = 13;
                else if (metsPercentage >= 90) metsScore = 11;
                else if (metsPercentage >= 80) metsScore = 9;
                else if (metsPercentage >= 70) metsScore = 7;
                else if (metsPercentage >= 60) metsScore = 5;
                else if (metsPercentage >= 50) metsScore = 3;
                else metsScore = 0;

                breakdown.functionalCapacity += metsScore;
                breakdown.details.mets = {
                    score: metsScore,
                    value: metrics.mets,
                    expected: expectedMETs.toFixed(1),
                    percentage: metsPercentage.toFixed(0) + '%'
                };
            }

            // 6-Minute Walk Test (0-15 points) - Age/Sex-Adjusted
            if (metrics.walkDistance !== undefined && height && sex) {
                // Enright & Sherril prediction equation
                let predictedDistance;
                const weight = metrics.weight || 70; // Default if not provided

                if (sex === 'male') {
                    predictedDistance = (7.57 * height) - (5.02 * age) - (1.76 * weight) - 309;
                } else {
                    predictedDistance = (2.11 * height) - (5.78 * age) - (2.29 * weight) + 667;
                }

                const walkPercentage = (metrics.walkDistance / predictedDistance) * 100;

                let walkScore = 0;
                if (walkPercentage >= 80) walkScore = 15;
                else if (walkPercentage >= 70) walkScore = 12;
                else if (walkPercentage >= 60) walkScore = 9;
                else if (walkPercentage >= 50) walkScore = 6;
                else if (walkPercentage >= 40) walkScore = 3;
                else walkScore = 0;

                breakdown.functionalCapacity += walkScore;
                breakdown.details.walkDistance = {
                    score: walkScore,
                    value: metrics.walkDistance,
                    predicted: Math.round(predictedDistance),
                    percentage: walkPercentage.toFixed(0) + '%'
                };
            }

            // VO2 Max (0-5 points) - Bonus Metric
            if (metrics.vo2Max !== undefined) {
                let vo2Score = 0;
                if (metrics.vo2Max >= 28) vo2Score = 5;
                else if (metrics.vo2Max >= 24) vo2Score = 4;
                else if (metrics.vo2Max >= 20) vo2Score = 3;
                else if (metrics.vo2Max >= 16) vo2Score = 2;
                else if (metrics.vo2Max >= 12) vo2Score = 1;
                else vo2Score = 0;

                breakdown.functionalCapacity += vo2Score;
                breakdown.details.vo2Max = { score: vo2Score, value: metrics.vo2Max };
            }

            // CATEGORY 2: CARDIOVASCULAR HEALTH (25 points max)

            // Heart Rate Variability - SDNN (0-8 points)
            if (metrics.sdnn !== undefined) {
                let sdnnScore = 0;
                if (metrics.sdnn >= 50) sdnnScore = 8;
                else if (metrics.sdnn >= 40) sdnnScore = 6;
                else if (metrics.sdnn >= 35) sdnnScore = 5;
                else if (metrics.sdnn >= 30) sdnnScore = 4;
                else if (metrics.sdnn >= 25) sdnnScore = 3;
                else if (metrics.sdnn >= 20) sdnnScore = 2;
                else sdnnScore = 0;

                breakdown.cardiovascularHealth += sdnnScore;
                breakdown.details.sdnn = { score: sdnnScore, value: metrics.sdnn };
            }

            // Heart Rate Recovery (0-7 points)
            if (metrics.hrRecovery !== undefined) {
                let hrrScore = 0;
                if (metrics.hrRecovery >= 25) hrrScore = 7;
                else if (metrics.hrRecovery >= 20) hrrScore = 6;
                else if (metrics.hrRecovery >= 18) hrrScore = 5;
                else if (metrics.hrRecovery >= 15) hrrScore = 4;
                else if (metrics.hrRecovery >= 13) hrrScore = 2;
                else if (metrics.hrRecovery >= 12) hrrScore = 1;
                else hrrScore = 0;

                breakdown.cardiovascularHealth += hrrScore;
                breakdown.details.hrRecovery = { score: hrrScore, value: metrics.hrRecovery };
            }

            // Resting Heart Rate (0-5 points)
            if (metrics.restingHR !== undefined) {
                let rhrScore = 0;
                if (metrics.restingHR >= 50 && metrics.restingHR <= 60) rhrScore = 5;
                else if (metrics.restingHR >= 61 && metrics.restingHR <= 70) rhrScore = 4;
                else if (metrics.restingHR >= 71 && metrics.restingHR <= 80) rhrScore = 3;
                else if (metrics.restingHR >= 81 && metrics.restingHR <= 90) rhrScore = 2;
                else if (metrics.restingHR >= 91 && metrics.restingHR <= 100) rhrScore = 1;
                else rhrScore = 0;

                breakdown.cardiovascularHealth += rhrScore;
                breakdown.details.restingHR = { score: rhrScore, value: metrics.restingHR };
            }

            // Ejection Fraction (0-5 points)
            if (metrics.ejectionFraction !== undefined) {
                let efScore = 0;
                if (metrics.ejectionFraction >= 55) efScore = 5;
                else if (metrics.ejectionFraction >= 50) efScore = 4;
                else if (metrics.ejectionFraction >= 45) efScore = 3;
                else if (metrics.ejectionFraction >= 40) efScore = 2;
                else if (metrics.ejectionFraction >= 35) efScore = 1;
                else efScore = 0;

                breakdown.cardiovascularHealth += efScore;
                breakdown.details.ejectionFraction = { score: efScore, value: metrics.ejectionFraction };
            }

            // CATEGORY 3: SYMPTOM BURDEN (20 points max) - Inverted scores

            // Dyspnea Score (0-6 points inverted)
            if (metrics.dyspnea !== undefined) {
                let dyspneaScore = 0;
                if (metrics.dyspnea === 0) dyspneaScore = 6;
                else if (metrics.dyspnea <= 2) dyspneaScore = 5;
                else if (metrics.dyspnea <= 4) dyspneaScore = 4;
                else if (metrics.dyspnea <= 6) dyspneaScore = 3;
                else if (metrics.dyspnea <= 8) dyspneaScore = 1;
                else dyspneaScore = 0;

                breakdown.symptomBurden += dyspneaScore;
                breakdown.details.dyspnea = { score: dyspneaScore, value: metrics.dyspnea };
            }

            // Chest Pain Score (0-6 points inverted)
            if (metrics.chestPain !== undefined) {
                let chestPainScore = 0;
                if (metrics.chestPain === 0) chestPainScore = 6;
                else if (metrics.chestPain === 1) chestPainScore = 5;
                else if (metrics.chestPain === 2) chestPainScore = 4;
                else if (metrics.chestPain <= 4) chestPainScore = 2;
                else if (metrics.chestPain <= 7) chestPainScore = 1;
                else chestPainScore = 0;

                breakdown.symptomBurden += chestPainScore;
                breakdown.details.chestPain = { score: chestPainScore, value: metrics.chestPain };
            }

            // Fatigue Score (0-4 points inverted)
            if (metrics.fatigue !== undefined) {
                let fatigueScore = 0;
                if (metrics.fatigue <= 1) fatigueScore = 4;
                else if (metrics.fatigue <= 3) fatigueScore = 3;
                else if (metrics.fatigue <= 5) fatigueScore = 2;
                else if (metrics.fatigue <= 8) fatigueScore = 1;
                else fatigueScore = 0;

                breakdown.symptomBurden += fatigueScore;
                breakdown.details.fatigue = { score: fatigueScore, value: metrics.fatigue };
            }

            // Edema Score (0-4 points inverted)
            if (metrics.edema !== undefined) {
                let edemaScore = 0;
                if (metrics.edema === 0) edemaScore = 4;
                else if (metrics.edema === 1) edemaScore = 3;
                else if (metrics.edema === 2) edemaScore = 2;
                else if (metrics.edema === 3) edemaScore = 1;
                else edemaScore = 0;

                breakdown.symptomBurden += edemaScore;
                breakdown.details.edema = { score: edemaScore, value: metrics.edema };
            }

            // CATEGORY 4: QUALITY OF LIFE & RECOVERY (15 points max)

            // Quality of Life (0-10 points)
            if (metrics.qualityOfLife !== undefined) {
                let qolScore = 0;
                if (metrics.qualityOfLife >= 90) qolScore = 10;
                else if (metrics.qualityOfLife >= 80) qolScore = 8;
                else if (metrics.qualityOfLife >= 70) qolScore = 6;
                else if (metrics.qualityOfLife >= 60) qolScore = 4;
                else if (metrics.qualityOfLife >= 50) qolScore = 2;
                else qolScore = 0;

                breakdown.qualityOfLife += qolScore;
                breakdown.details.qualityOfLife = { score: qolScore, value: metrics.qualityOfLife };
            }

            // Sleep Quality (0-5 points)
            if (metrics.sleepQuality !== undefined) {
                let sleepScore = 0;
                if (metrics.sleepQuality >= 9) sleepScore = 5;
                else if (metrics.sleepQuality >= 7) sleepScore = 4;
                else if (metrics.sleepQuality >= 5) sleepScore = 3;
                else if (metrics.sleepQuality >= 3) sleepScore = 2;
                else if (metrics.sleepQuality >= 1) sleepScore = 1;
                else sleepScore = 0;

                breakdown.qualityOfLife += sleepScore;
                breakdown.details.sleepQuality = { score: sleepScore, value: metrics.sleepQuality };
            }

            // CATEGORY 5: RISK MODIFIERS (5 points bonus/penalty)

            // Blood Pressure Control (±3 points)
            if (metrics.bpSystolic !== undefined && metrics.bpDiastolic !== undefined) {
                let bpScore = 0;
                if (metrics.bpSystolic < 120 && metrics.bpDiastolic < 80) bpScore = 3;
                else if (metrics.bpSystolic < 130 && metrics.bpDiastolic < 85) bpScore = 2;
                else if (metrics.bpSystolic < 140 && metrics.bpDiastolic < 90) bpScore = 1;
                else if (metrics.bpSystolic < 160 && metrics.bpDiastolic < 100) bpScore = 0;
                else bpScore = -3;

                breakdown.riskModifiers += bpScore;
                breakdown.details.bloodPressure = {
                    score: bpScore,
                    systolic: metrics.bpSystolic,
                    diastolic: metrics.bpDiastolic
                };
            }

            // SpO2 (±2 points)
            const spo2Value = metrics.spo2 || metrics.oxygenSat; // Support both field names
            if (spo2Value !== undefined) {
                let spo2Score = 0;
                if (spo2Value >= 98) spo2Score = 2;
                else if (spo2Value >= 95) spo2Score = 1;
                else if (spo2Value >= 92) spo2Score = 0;
                else spo2Score = -2;

                breakdown.riskModifiers += spo2Score;
                breakdown.details.spo2 = { score: spo2Score, value: spo2Value };
            }

            // CALCULATE TOTAL SCORE
            breakdown.total =
                breakdown.functionalCapacity +
                breakdown.cardiovascularHealth +
                breakdown.symptomBurden +
                breakdown.qualityOfLife +
                breakdown.riskModifiers;

            // Apply Age-Stratification Multiplier
            let ageMultiplier = 1.0;
            if (age < 50) ageMultiplier = 1.05;
            else if (age >= 65 && age < 75) ageMultiplier = 1.08;
            else if (age >= 75) ageMultiplier = 1.12;

            breakdown.rawTotal = breakdown.total;
            breakdown.total = Math.min(100, Math.round(breakdown.total * ageMultiplier));
            breakdown.ageMultiplier = ageMultiplier;

            // INTERPRETATION AND COLOR CODING
            if (breakdown.total >= 90) {
                breakdown.interpretation = 'SUPERIOR RECOVERY';
                breakdown.probability = '95-100% probability of full recovery';
                breakdown.colorCode = '#22c55e'; // Green
                breakdown.colorName = 'excellent';
            } else if (breakdown.total >= 80) {
                breakdown.interpretation = 'EXCELLENT RECOVERY';
                breakdown.probability = '85-94% probability of full recovery';
                breakdown.colorCode = '#22c55e'; // Green
                breakdown.colorName = 'excellent';
            } else if (breakdown.total >= 70) {
                breakdown.interpretation = 'VERY GOOD RECOVERY';
                breakdown.probability = '75-84% probability of full recovery';
                breakdown.colorCode = '#3b82f6'; // Blue
                breakdown.colorName = 'better-than-average';
            } else if (breakdown.total >= 60) {
                breakdown.interpretation = 'GOOD RECOVERY';
                breakdown.probability = '65-74% probability of full recovery';
                breakdown.colorCode = '#3b82f6'; // Blue
                breakdown.colorName = 'better-than-average';
            } else if (breakdown.total >= 50) {
                breakdown.interpretation = 'FAIR RECOVERY';
                breakdown.probability = '50-64% probability of full recovery';
                breakdown.colorCode = '#fbbf24'; // Yellow
                breakdown.colorName = 'average';
            } else if (breakdown.total >= 40) {
                breakdown.interpretation = 'BELOW AVERAGE RECOVERY';
                breakdown.probability = '35-49% probability of full recovery';
                breakdown.colorCode = '#f97316'; // Orange
                breakdown.colorName = 'below-average';
            } else if (breakdown.total >= 30) {
                breakdown.interpretation = 'POOR RECOVERY';
                breakdown.probability = '20-34% probability of full recovery';
                breakdown.colorCode = '#ef4444'; // Red
                breakdown.colorName = 'poor';
            } else {
                breakdown.interpretation = 'HIGH RISK';
                breakdown.probability = '0-19% probability - Emergency evaluation required';
                breakdown.colorCode = '#ef4444'; // Red
                breakdown.colorName = 'critical';
            }

            return breakdown;
        }

        /**
         * Update CRPS Display in real-time across Dashboard and Analytics
         * @param {Object} crpsResult - Result from calculateCRPS()
         */
        function updateCRPSDisplay(crpsResult) {
            if (!crpsResult) return;

            // Update Dashboard CRPS display
            const dashboardScore = document.getElementById('dashboardCRPSScore');
            const dashboardInterpretation = document.getElementById('dashboardCRPSInterpretation');
            const dashboardProbability = document.getElementById('dashboardCRPSProbability');
            const dashboardCard = document.getElementById('dashboardCRPSCard');

            if (dashboardScore) {
                dashboardScore.textContent = crpsResult.total;
                dashboardScore.style.color = crpsResult.colorCode;
            }

            if (dashboardInterpretation) {
                dashboardInterpretation.textContent = crpsResult.interpretation;
                dashboardInterpretation.style.color = crpsResult.colorCode;
            }

            if (dashboardProbability) {
                dashboardProbability.textContent = crpsResult.probability;
            }

            if (dashboardCard) {
                dashboardCard.style.borderColor = crpsResult.colorCode;
                dashboardCard.style.background = `linear-gradient(135deg, ${crpsResult.colorCode}15, ${crpsResult.colorCode}05)`;
            }

            // Update Analytics CRPS display
            const analyticsScore = document.getElementById('analyticsCRPSScore');
            const analyticsInterpretation = document.getElementById('analyticsCRPSInterpretation');

            if (analyticsScore) {
                analyticsScore.textContent = crpsResult.total;
                analyticsScore.style.color = crpsResult.colorCode;
            }

            if (analyticsInterpretation) {
                analyticsInterpretation.textContent = crpsResult.interpretation;
            }

            // Update category breakdown
            updateCategoryBreakdown(crpsResult);

            // Update CRPS trend chart
            updateCRPSTrendChart();
        }

        /**
         * Update category breakdown display
         * @param {Object} crpsResult - Result from calculateCRPS()
         */
        function updateCategoryBreakdown(crpsResult) {
            const categories = [
                { id: 'functionalCapacity', label: 'Functional Capacity', max: 35 },
                { id: 'cardiovascularHealth', label: 'Cardiovascular Health', max: 25 },
                { id: 'symptomBurden', label: 'Symptom Burden', max: 20 },
                { id: 'qualityOfLife', label: 'Quality of Life', max: 15 },
                { id: 'riskModifiers', label: 'Risk Modifiers', max: 5 }
            ];

            categories.forEach(cat => {
                const scoreElement = document.getElementById(`crps${cat.id}Score`);
                const barElement = document.getElementById(`crps${cat.id}Bar`);

                if (scoreElement) {
                    const score = crpsResult[cat.id] || 0;
                    scoreElement.textContent = `${score}/${cat.max}`;
                }

                if (barElement) {
                    const score = crpsResult[cat.id] || 0;
                    const percentage = (score / cat.max) * 100;
                    barElement.style.width = `${percentage}%`;

                    // Color code the bar
                    if (percentage >= 80) barElement.style.background = '#22c55e';
                    else if (percentage >= 60) barElement.style.background = '#3b82f6';
                    else if (percentage >= 40) barElement.style.background = '#fbbf24';
                    else if (percentage >= 20) barElement.style.background = '#f97316';
                    else barElement.style.background = '#ef4444';
                }
            });
        }

        /**
         * Initialize CRPS Trend Chart with 90-day data
         */
        function initializeCRPSTrendChart() {
            const ctx = document.getElementById('crpsTrendChart');
            if (!ctx) return;

            // Get CRPS scores for the last 90 days
            const today = new Date();
            const crpsData = [];
            const labels = [];

            for (let i = 90; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                const dayData = allData[dateStr];
                if (dayData && dayData.crpsScore !== undefined) {
                    crpsData.push({
                        x: dateStr,
                        y: dayData.crpsScore,
                        score: dayData.crpsScore
                    });
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
            }

            // Color code the points and segments
            const pointColors = crpsData.map(d => {
                if (d.score >= 80) return '#22c55e';
                else if (d.score >= 60) return '#3b82f6';
                else if (d.score >= 50) return '#fbbf24';
                else if (d.score >= 40) return '#f97316';
                else return '#ef4444';
            });

            // Destroy existing chart if it exists
            if (window.crpsTrendChart) {
                window.crpsTrendChart.destroy();
            }

            // Create new chart
            window.crpsTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.length > 0 ? labels : ['No data yet'],
                    datasets: [{
                        label: 'Recovery Probability Score',
                        data: crpsData.length > 0 ? crpsData.map(d => d.y) : [0],
                        backgroundColor: pointColors.length > 0 ? pointColors : ['rgba(96, 165, 250, 0.2)'],
                        borderColor: pointColors.length > 0 ? pointColors : ['rgba(96, 165, 250, 1)'],
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: pointColors.length > 0 ? pointColors : ['rgba(96, 165, 250, 1)'],
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        tension: 0.4,
                        fill: {
                            target: 'origin',
                            above: 'rgba(96, 165, 250, 0.1)'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#e5e7eb',
                                font: { size: 12, weight: 'bold' },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#60a5fa',
                            bodyColor: '#e5e7eb',
                            borderColor: '#60a5fa',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const score = context.parsed.y;
                                    let interpretation = '';
                                    let probability = '';

                                    if (score >= 90) {
                                        interpretation = 'Superior Recovery';
                                        probability = '95-100% probability';
                                    } else if (score >= 80) {
                                        interpretation = 'Excellent Recovery';
                                        probability = '85-94% probability';
                                    } else if (score >= 70) {
                                        interpretation = 'Very Good Recovery';
                                        probability = '75-84% probability';
                                    } else if (score >= 60) {
                                        interpretation = 'Good Recovery';
                                        probability = '65-74% probability';
                                    } else if (score >= 50) {
                                        interpretation = 'Fair Recovery';
                                        probability = '50-64% probability';
                                    } else if (score >= 40) {
                                        interpretation = 'Below Average';
                                        probability = '35-49% probability';
                                    } else if (score >= 30) {
                                        interpretation = 'Poor Recovery';
                                        probability = '20-34% probability';
                                    } else {
                                        interpretation = 'High Risk';
                                        probability = '0-19% probability';
                                    }

                                    return [
                                        `Score: ${score}/100`,
                                        `${interpretation}`,
                                        `${probability}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#9ca3af',
                                font: { size: 11 },
                                callback: function(value) {
                                    return value + '/100';
                                }
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)',
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Recovery Probability Score',
                                color: '#60a5fa',
                                font: { size: 13, weight: 'bold' }
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af',
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.05)',
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#60a5fa',
                                font: { size: 13, weight: 'bold' }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        /**
         * Update CRPS Trend Chart with 90-day data
         */
        function updateCRPSTrendChart() {
            // Simply re-initialize the chart with updated data
            initializeCRPSTrendChart();
        }

        // INPUT VALIDATION AND RANGE CHECKING
        const validationRules = {
            restingHR: { min: 30, max: 220, warning: { min: 40, max: 100 }, critical: { max: 120 }, unit: 'bpm' },
            bpSystolic: { min: 60, max: 250, warning: { min: 90, max: 160 }, critical: { max: 180 }, unit: 'mmHg' },
            bpDiastolic: { min: 40, max: 150, warning: { min: 60, max: 100 }, critical: { max: 110 }, unit: 'mmHg' },
            vo2Max: { min: 5, max: 80, warning: { min: 14 }, critical: { min: 10 }, unit: 'ml/kg/min' },
            maxHR: { min: 60, max: 220, warning: { min: 100 }, unit: 'bpm' },
            hrRecovery: { min: 0, max: 100, warning: { min: 12 }, unit: 'bpm' },
            sdnn: { min: 0, max: 200, warning: { min: 20 }, unit: 'ms' },
            rmssd: { min: 0, max: 200, warning: { min: 20 }, unit: 'ms' },
            pnn50: { min: 0, max: 100, warning: { min: 5 }, unit: '%' },
            walkDistance: { min: 0, max: 1000, warning: { min: 300 }, unit: 'm' },
            mets: { min: 0, max: 20, warning: { min: 5 }, unit: 'METs' },
            ejectionFraction: { min: 10, max: 90, warning: { min: 40 }, critical: { min: 30 }, unit: '%' },
            oxygenSat: { min: 70, max: 100, warning: { min: 93 }, critical: { min: 90 }, unit: '%' },
            respRate: { min: 5, max: 60, warning: { min: 12, max: 25 }, critical: { max: 30 }, unit: '/min' },
            weight: { min: 30, max: 300, unit: 'kg' },
            dyspnea: { min: 0, max: 10, warning: { max: 5 }, critical: { max: 7 }, unit: '' },
            chestPain: { min: 0, max: 10, warning: { max: 2 }, critical: { max: 3 }, unit: '' },
            fatigue: { min: 0, max: 10, warning: { max: 6 }, unit: '' },
            edema: { min: 0, max: 4, warning: { max: 2 }, critical: { max: 3 }, unit: '' },
            qualityOfLife: { min: 0, max: 100, warning: { min: 50 }, unit: '' },
            sleepQuality: { min: 0, max: 10, warning: { min: 6 }, unit: '' }
        };

        function validateMetricInput(fieldId, value) {
            const rules = validationRules[fieldId];
            if (!rules) return { valid: true };

            const numValue = parseFloat(value);

            // Check if empty or not a number
            if (value === '' || isNaN(numValue)) {
                return { valid: true, level: 'none' };
            }

            // Check absolute limits (error)
            if (numValue < rules.min || numValue > rules.max) {
                return {
                    valid: false,
                    level: 'error',
                    message: `Invalid range: must be ${rules.min}-${rules.max} ${rules.unit}`
                };
            }

            // Check critical thresholds
            if (rules.critical) {
                if (rules.critical.min !== undefined && numValue < rules.critical.min) {
                    return {
                        valid: true,
                        level: 'critical',
                        message: `⚠️ CRITICAL: ${fieldId === 'chestPain' ? 'Contact physician immediately' : 'Dangerously low - seek medical attention'}`
                    };
                }
                if (rules.critical.max !== undefined && numValue > rules.critical.max) {
                    return {
                        valid: true,
                        level: 'critical',
                        message: `⚠️ CRITICAL: ${fieldId === 'chestPain' ? 'Contact physician immediately' : 'Dangerously high - seek medical attention'}`
                    };
                }
            }

            // Check warning thresholds
            if (rules.warning) {
                if (rules.warning.min !== undefined && numValue < rules.warning.min) {
                    return {
                        valid: true,
                        level: 'warning',
                        message: `Below recommended range (${rules.warning.min}+ ${rules.unit})`
                    };
                }
                if (rules.warning.max !== undefined && numValue > rules.warning.max) {
                    return {
                        valid: true,
                        level: 'warning',
                        message: `Above recommended range (<${rules.warning.max} ${rules.unit})`
                    };
                }
            }

            return { valid: true, level: 'good' };
        }

        function attachValidationListeners() {
            Object.keys(validationRules).forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (!input) return;

                // Set min/max attributes
                const rules = validationRules[fieldId];
                input.setAttribute('min', rules.min);
                input.setAttribute('max', rules.max);

                // Add validation on input
                input.addEventListener('input', function() {
                    const result = validateMetricInput(fieldId, this.value);
                    const field = this.closest('.metric-field');

                    // Remove existing validation messages
                    const existingWarning = field.querySelector('.metric-warning');
                    const existingError = field.querySelector('.metric-error');
                    if (existingWarning) existingWarning.remove();
                    if (existingError) existingError.remove();

                    // Remove validation classes
                    this.classList.remove('warning', 'error');

                    if (result.level === 'error') {
                        this.classList.add('error');
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'metric-error show';
                        errorDiv.textContent = result.message;
                        field.appendChild(errorDiv);
                    } else if (result.level === 'critical' || result.level === 'warning') {
                        this.classList.add(result.level === 'critical' ? 'error' : 'warning');
                        const warningDiv = document.createElement('div');
                        warningDiv.className = `metric-${result.level === 'critical' ? 'error' : 'warning'} show`;
                        warningDiv.textContent = result.message;
                        field.appendChild(warningDiv);
                    }
                });
            });
        }

        // CLINICAL ALERT SYSTEM
        let pendingSaveData = null;

        function checkClinicalAlerts(metrics) {
            const alerts = [];

            // CRITICAL: Chest Pain
            if (metrics.chestPain !== undefined && metrics.chestPain > 3) {
                alerts.push({
                    severity: 'URGENT',
                    metric: 'Chest Pain',
                    value: metrics.chestPain,
                    action: 'Contact your physician IMMEDIATELY. Do not wait.',
                    icon: '🆘'
                });
            }

            // CRITICAL: Low Oxygen Saturation
            if (metrics.oxygenSat !== undefined && metrics.oxygenSat < 90) {
                alerts.push({
                    severity: 'URGENT',
                    metric: 'Oxygen Saturation',
                    value: `${metrics.oxygenSat}%`,
                    action: 'Dangerously low oxygen - seek immediate medical attention',
                    icon: '🫁'
                });
            }

            // CRITICAL: Severe Ejection Fraction
            if (metrics.ejectionFraction !== undefined && metrics.ejectionFraction < 30) {
                alerts.push({
                    severity: 'URGENT',
                    metric: 'Ejection Fraction',
                    value: `${metrics.ejectionFraction}%`,
                    action: 'Severely reduced heart function - notify cardiologist',
                    icon: '💔'
                });
            }

            // CRITICAL: Very High Blood Pressure
            if (metrics.bpSystolic !== undefined && metrics.bpSystolic > 180) {
                alerts.push({
                    severity: 'URGENT',
                    metric: 'Blood Pressure (Systolic)',
                    value: `${metrics.bpSystolic} mmHg`,
                    action: 'Hypertensive crisis - seek emergency care',
                    icon: '⚠️'
                });
            }

            // WARNING: High Resting HR
            if (metrics.restingHR !== undefined && metrics.restingHR > 100) {
                alerts.push({
                    severity: 'WARNING',
                    metric: 'Resting Heart Rate',
                    value: `${metrics.restingHR} bpm`,
                    action: 'Elevated heart rate - monitor closely and discuss with provider',
                    icon: '💓'
                });
            }

            // WARNING: Severe Dyspnea
            if (metrics.dyspnea !== undefined && metrics.dyspnea > 7) {
                alerts.push({
                    severity: 'WARNING',
                    metric: 'Shortness of Breath',
                    value: `${metrics.dyspnea}/10`,
                    action: 'Severe breathing difficulty - contact medical team',
                    icon: '🫁'
                });
            }

            // WARNING: Severe Edema
            if (metrics.edema !== undefined && metrics.edema >= 3) {
                alerts.push({
                    severity: 'WARNING',
                    metric: 'Swelling (Edema)',
                    value: `${metrics.edema}/4`,
                    action: 'Significant fluid retention - may indicate heart failure',
                    icon: '💧'
                });
            }

            // WARNING: Rapid Weight Gain (check last entry)
            const dates = Object.keys(allData).sort();
            if (dates.length > 0 && metrics.weight !== undefined) {
                const lastDate = dates[dates.length - 1];
                const lastWeight = allData[lastDate].weight;
                if (lastWeight && (metrics.weight - lastWeight) > 2) {
                    alerts.push({
                        severity: 'WARNING',
                        metric: 'Weight Gain',
                        value: `+${(metrics.weight - lastWeight).toFixed(1)} kg`,
                        action: 'Rapid weight gain may indicate fluid retention',
                        icon: '⚖️'
                    });
                }
            }

            return alerts;
        }

        function showClinicalAlert(alerts) {
            const modal = document.getElementById('alertModal');
            const message = document.getElementById('alertMessage');
            const details = document.getElementById('alertDetails');

            const urgentAlerts = alerts.filter(a => a.severity === 'URGENT');
            const warningAlerts = alerts.filter(a => a.severity === 'WARNING');

            if (urgentAlerts.length > 0) {
                message.textContent = `${urgentAlerts.length} URGENT ${urgentAlerts.length === 1 ? 'ALERT' : 'ALERTS'} detected. Immediate medical attention may be required.`;
            } else {
                message.textContent = `${warningAlerts.length} ${warningAlerts.length === 1 ? 'WARNING' : 'WARNINGS'} detected. Please review these values carefully.`;
            }

            let detailsHTML = '';
            alerts.forEach(alert => {
                detailsHTML += `
                    <div class="alert-detail-item">
                        ${alert.icon} <strong>${alert.metric}:</strong> ${alert.value}<br>
                        → ${alert.action}
                    </div>
                `;
            });
            details.innerHTML = detailsHTML;

            modal.classList.add('show');
        }

        function closeAlert() {
            document.getElementById('alertModal').classList.remove('show');
            pendingSaveData = null;
        }

        function acknowledgeAlert() {
            if (pendingSaveData) {
                const { dateStr, metrics } = pendingSaveData;
                allData[dateStr] = metrics;

                // Save with error handling
                try {
                    localStorage.setItem('cardiacRecoveryData', JSON.stringify(allData));
                    showNotification('⚠️ Data saved with clinical alerts', 'error');
                } catch (error) {
                    console.error('Error saving acknowledged alert data:', error);
                    if (error.name === 'QuotaExceededError') {
                        showNotification('⚠️ Storage limit exceeded! Data in memory only.', 'error');
                    } else {
                        showNotification('⚠️ Could not save data persistently', 'error');
                    }
                }

                // Update UI regardless of save status
                updateDashboard();
                updateWeeklyMilestones();
                refreshHistoryTable();
                updateCharts();
                updatePopulationComparison();
                closeAlert();
            }
        }

        // SAVE METRICS
        // Historical mode tracking
        let isHistoricalMode = false;
        let historicalDate = null;

        function toggleHistoricalMode() {
            const toggle = document.getElementById('historicalModeToggle');
            const picker = document.getElementById('historicalDatePicker');
            isHistoricalMode = toggle.checked;

            if (isHistoricalMode) {
                picker.style.display = 'block';
                // Set default historical date to 6 months ago
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                document.getElementById('historicalDate').value = sixMonthsAgo.toISOString().split('T')[0];
                updateHistoricalDate();
            } else {
                picker.style.display = 'none';
                historicalDate = null;
                // Reset to current date
                document.getElementById('entryDate').textContent = currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            }
        }

        function updateHistoricalDate() {
            const dateInput = document.getElementById('historicalDate');
            if (dateInput.value) {
                historicalDate = new Date(dateInput.value + 'T00:00:00');
                document.getElementById('entryDate').textContent = historicalDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) + ' (Historical)';
            }
        }

        function saveMetrics() {
            // Use historical date if in historical mode, otherwise use current date
            const dateStr = isHistoricalMode && historicalDate
                ? historicalDate.toISOString().split('T')[0]
                : currentDate.toISOString().split('T')[0];

            const metrics = {};
            let hasErrors = false;

            const fields = [
                'restingHR', 'bpSystolic', 'bpDiastolic', 'vo2Max', 'maxHR', 'hrRecovery',
                'sdnn', 'rmssd', 'pnn50', 'walkDistance', 'mets', 'ejectionFraction',
                'spo2', 'respRate', 'weight', 'dyspnea', 'chestPain', 'fatigue',
                'edema', 'qualityOfLife', 'sleepQuality',
                // Samsung Watch ECG Fields
                'qrsDuration', 'rrInterval'
            ];

            const textFields = [
                'ecgRhythmInput', 'stressLevel'
            ];

            // Process numeric fields
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (!element) return;

                const value = element.value;
                if (value !== '') {
                    const result = validateMetricInput(field, value);

                    if (!result.valid) {
                        hasErrors = true;
                        return;
                    }

                    metrics[field] = parseFloat(value);
                }
            });

            // Process text/dropdown fields (Samsung Watch ECG)
            textFields.forEach(field => {
                const element = document.getElementById(field);
                if (!element) return;

                const value = element.value;
                if (value !== '') {
                    metrics[field] = value;
                }
            });

            // Save daily notes
            const notes = document.getElementById('dailyNotes').value;
            if (notes.trim() !== '') {
                metrics.notes = notes.trim();
            }

            if (hasErrors) {
                showNotification('Please fix invalid values before saving', 'error');
                return;
            }

            if (Object.keys(metrics).length === 0) {
                showNotification('Please enter at least one metric', 'error');
                return;
            }

            // Check for clinical alerts
            const alerts = checkClinicalAlerts(metrics);

            if (alerts.length > 0) {
                pendingSaveData = { dateStr, metrics };
                showClinicalAlert(alerts);
                return;
            }

            // Mark as historical data if in historical mode
            if (isHistoricalMode) {
                metrics.isHistorical = true;
            }

            // No alerts - save normally
            allData[dateStr] = metrics;

            // Calculate CRPS (Cardiac Recovery Probability Score)
            // Get patient demographics from stored profile (or use defaults)
            const demographics = getCurrentDemographics();

            try {
                const crpsResult = calculateCRPS(metrics, demographics.age, demographics.height, demographics.sex);
                metrics.crpsScore = crpsResult.total;
                metrics.crpsBreakdown = crpsResult;
                allData[dateStr] = metrics; // Re-save with CRPS score

                // Update real-time CRPS display
                updateCRPSDisplay(crpsResult);
            } catch (error) {
                console.error('Error calculating CRPS:', error);
                // Continue without CRPS if calculation fails
            }

            // Save to localStorage with error handling
            try {
                localStorage.setItem('cardiacRecoveryData', JSON.stringify(allData));
                const message = isHistoricalMode
                    ? `Historical data saved for ${historicalDate.toLocaleDateString()}!`
                    : 'Metrics saved!';
                showNotification(message, 'success');
            } catch (error) {
                console.error('Error saving metrics:', error);
                if (error.name === 'QuotaExceededError') {
                    showNotification('⚠️ Storage limit exceeded! Consider exporting old data.', 'error');
                } else {
                    showNotification('⚠️ Could not save data persistently. Data in memory only.', 'error');
                }
            }

            // Update UI - SKIP dashboard and milestones for historical data
            if (isHistoricalMode) {
                // Only update charts and history for historical data
                refreshHistoryTable();
                updateCharts();
            } else {
                // Update everything for current data
                updateDashboard();
                updateWeeklyMilestones();
                refreshHistoryTable();
                updateCharts();
                updatePopulationComparison();
            }
        }

        // LOAD DATA FOR DATE
        function loadDataForDate(dateStr) {
            const data = allData[dateStr];
            document.querySelectorAll('.metric-field input').forEach(input => input.value = '');
            document.getElementById('dailyNotes').value = '';
            if (data) {
                Object.keys(data).forEach(key => {
                    if (key === 'notes') {
                        document.getElementById('dailyNotes').value = data[key];
                    } else {
                        const input = document.getElementById(key);
                        if (input) input.value = data[key];
                    }
                });
            }
        }

        // Helper function to calculate average
        function calcAverage(metric) {
            const dates = Object.keys(allData);
            const values = dates.map(d => allData[d][metric]).filter(v => v !== undefined && v !== null);
            if (values.length === 0) return null;
            return values.reduce((a, b) => a + b, 0) / values.length;
        }

        // UPDATE DASHBOARD STATS
        function updateDashboard() {
            try {
                const dates = Object.keys(allData).sort();
                if (dates.length === 0) return;

                const latest = allData[dates[dates.length - 1]];
                const latestDate = new Date(dates[dates.length - 1]).toLocaleDateString();

                // VO2 Max
                if (latest.vo2Max) {
                    document.getElementById('statsVO2').textContent = latest.vo2Max.toFixed(1);
                    const avg = calcAverage('vo2Max');
                    if (avg) document.getElementById('statsVO2Avg').textContent = avg.toFixed(1);
                    document.getElementById('statsVO2Date').textContent = `Last: ${latestDate}`;
                    document.getElementById('statsVO2Trend').textContent = '↑ Improving';
                }
                // Resting HR
                if (latest.restingHR) {
                    document.getElementById('statsHR').textContent = latest.restingHR;
                    const avg = calcAverage('restingHR');
                    if (avg) document.getElementById('statsHRAvg').textContent = Math.round(avg);
                    document.getElementById('statsHRDate').textContent = `Last: ${latestDate}`;
                    document.getElementById('statsHRTrend').textContent = '↓ Improving';
                }
                // SDNN
                if (latest.sdnn) {
                    document.getElementById('statsSDNN').textContent = latest.sdnn.toFixed(1);
                    const avg = calcAverage('sdnn');
                    if (avg) document.getElementById('statsSDNNAvg').textContent = avg.toFixed(1);
                    document.getElementById('statsSDNNDate').textContent = `Last: ${latestDate}`;
                    document.getElementById('statsSDNNTrend').textContent = '↑ Good HRV';
                }
                // Blood Pressure
                if (latest.bpSystolic && latest.bpDiastolic) {
                    document.getElementById('statsBP').textContent = `${latest.bpSystolic}/${latest.bpDiastolic}`;
                    const avgSys = calcAverage('bpSystolic');
                    const avgDia = calcAverage('bpDiastolic');
                    if (avgSys && avgDia) document.getElementById('statsBPAvg').textContent = `${Math.round(avgSys)}/${Math.round(avgDia)}`;
                    document.getElementById('statsBPDate').textContent = `Last: ${latestDate}`;
                    const status = latest.bpSystolic < 120 && latest.bpDiastolic < 80 ? 'Optimal' : latest.bpSystolic < 130 ? 'Good' : 'Monitor';
                    document.getElementById('statsBPTrend').textContent = status;
                }
                // Max HR
                if (latest.maxHR) {
                    document.getElementById('statsMaxHR').textContent = latest.maxHR;
                    const avg = calcAverage('maxHR');
                    if (avg) document.getElementById('statsMaxHRAvg').textContent = Math.round(avg);
                    document.getElementById('statsMaxHRDate').textContent = `Last: ${latestDate}`;
                    document.getElementById('statsMaxHRTrend').textContent = 'Recorded';
                }
                // HR Recovery
                if (latest.hrRecovery) {
                    document.getElementById('statsHRRecovery').textContent = latest.hrRecovery;
                    const avg = calcAverage('hrRecovery');
                    if (avg) document.getElementById('statsHRRecoveryAvg').textContent = Math.round(avg);
                    document.getElementById('statsHRRecoveryDate').textContent = `Last: ${latestDate}`;
                    const status = latest.hrRecovery > 25 ? 'Excellent' : latest.hrRecovery > 20 ? 'Good' : 'Improving';
                    document.getElementById('statsHRRecoveryTrend').textContent = status;
                }
                // RMSSD
                if (latest.rmssd) {
                    document.getElementById('statsRMSSD').textContent = latest.rmssd.toFixed(1);
                    const avg = calcAverage('rmssd');
                    if (avg) document.getElementById('statsRMSSDAvg').textContent = avg.toFixed(1);
                    document.getElementById('statsRMSSDDate').textContent = `Last: ${latestDate}`;
                    const status = latest.rmssd > 40 ? 'Excellent' : latest.rmssd > 30 ? 'Good' : 'Fair';
                    document.getElementById('statsRMSSDTrend').textContent = status;
                }
                // pNN50
                if (latest.pnn50) {
                    document.getElementById('statsPNN50').textContent = latest.pnn50.toFixed(1);
                    const avg = calcAverage('pnn50');
                    if (avg) document.getElementById('statsPNN50Avg').textContent = avg.toFixed(1);
                    document.getElementById('statsPNN50Date').textContent = `Last: ${latestDate}`;
                    const status = latest.pnn50 > 20 ? 'Excellent' : latest.pnn50 > 10 ? 'Good' : 'Fair';
                    document.getElementById('statsPNN50Trend').textContent = status;
                }
                // 6-Minute Walk
                if (latest.walkDistance) {
                    document.getElementById('stats6MWD').textContent = latest.walkDistance;
                    const avg = calcAverage('walkDistance');
                    if (avg) document.getElementById('stats6MWDAvg').textContent = Math.round(avg);
                    document.getElementById('stats6MWDDate').textContent = `Last: ${latestDate}`;
                    const status = latest.walkDistance > 500 ? 'Excellent' : latest.walkDistance > 400 ? 'Good' : 'Improving';
                    document.getElementById('stats6MWDTrend').textContent = status;
                }
                // METs
                if (latest.mets) {
                    document.getElementById('statsMETs').textContent = latest.mets.toFixed(1);
                    const avg = calcAverage('mets');
                    if (avg) document.getElementById('statsMETsAvg').textContent = avg.toFixed(1);
                    document.getElementById('statsMETsDate').textContent = `Last: ${latestDate}`;
                    const status = latest.mets > 10 ? 'Excellent' : latest.mets > 7 ? 'Good' : 'Fair';
                    document.getElementById('statsMETsTrend').textContent = status;
                }
                // Ejection Fraction
                if (latest.ejectionFraction) {
                    document.getElementById('statsEF').textContent = latest.ejectionFraction;
                    const avg = calcAverage('ejectionFraction');
                    if (avg) document.getElementById('statsEFAvg').textContent = Math.round(avg);
                    document.getElementById('statsEFDate').textContent = `Last: ${latestDate}`;
                    const status = latest.ejectionFraction >= 50 ? 'Normal' : latest.ejectionFraction >= 40 ? 'Borderline' : 'Reduced';
                    document.getElementById('statsEFTrend').textContent = status;
                }
                // Oxygen Saturation
                if (latest.oxygenSat) {
                    document.getElementById('statsSpO2').textContent = latest.oxygenSat;
                    const avg = calcAverage('oxygenSat');
                    if (avg) document.getElementById('statsSpO2Avg').textContent = Math.round(avg);
                    document.getElementById('statsSpO2Date').textContent = `Last: ${latestDate}`;
                    const status = latest.oxygenSat >= 95 ? 'Normal' : latest.oxygenSat >= 90 ? 'Monitor' : 'Low';
                    document.getElementById('statsSpO2Trend').textContent = status;
                }
                // Respiratory Rate
                if (latest.respRate) {
                    document.getElementById('statsRespRate').textContent = latest.respRate;
                    const avg = calcAverage('respRate');
                    if (avg) document.getElementById('statsRespRateAvg').textContent = Math.round(avg);
                    document.getElementById('statsRespRateDate').textContent = `Last: ${latestDate}`;
                    const status = latest.respRate >= 12 && latest.respRate <= 20 ? 'Normal' : 'Monitor';
                    document.getElementById('statsRespRateTrend').textContent = status;
                }
                // Weight
                if (latest.weight) {
                    document.getElementById('statsWeight').textContent = latest.weight.toFixed(1);
                    const avg = calcAverage('weight');
                    if (avg) document.getElementById('statsWeightAvg').textContent = avg.toFixed(1);
                    document.getElementById('statsWeightDate').textContent = `Last: ${latestDate}`;
                    document.getElementById('statsWeightTrend').textContent = 'Tracked';
                }
                // Dyspnea
                if (latest.dyspnea !== undefined) {
                    document.getElementById('statsDyspnea').textContent = latest.dyspnea;
                    const avg = calcAverage('dyspnea');
                    if (avg !== null) document.getElementById('statsDyspneaAvg').textContent = avg.toFixed(1);
                    document.getElementById('statsDyspneaDate').textContent = `Last: ${latestDate}`;
                    const status = latest.dyspnea <= 3 ? 'Mild' : latest.dyspnea <= 6 ? 'Moderate' : 'Severe';
                    document.getElementById('statsDyspneaTrend').textContent = status;
                }
                // Chest Pain
                if (latest.chestPain !== undefined) {
                    document.getElementById('statsChestPain').textContent = latest.chestPain;
                    const avg = calcAverage('chestPain');
                    if (avg !== null) document.getElementById('statsChestPainAvg').textContent = avg.toFixed(1);
                    document.getElementById('statsChestPainDate').textContent = `Last: ${latestDate}`;
                    const status = latest.chestPain === 0 ? 'None' : latest.chestPain <= 3 ? 'Mild' : 'Contact MD';
                    document.getElementById('statsChestPainTrend').textContent = status;
                }
                // Fatigue
                if (latest.fatigue !== undefined) {
                    document.getElementById('statsFatigue').textContent = latest.fatigue;
                    const avg = calcAverage('fatigue');
                    if (avg !== null) document.getElementById('statsFatigueAvg').textContent = avg.toFixed(1);
                    document.getElementById('statsFatigueDate').textContent = `Last: ${latestDate}`;
                    const status = latest.fatigue <= 3 ? 'Low' : latest.fatigue <= 6 ? 'Moderate' : 'High';
                    document.getElementById('statsFatigueTrend').textContent = status;
                }
                // Edema
                if (latest.edema !== undefined) {
                    document.getElementById('statsEdema').textContent = latest.edema;
                    const avg = calcAverage('edema');
                    if (avg !== null) document.getElementById('statsEdemaAvg').textContent = avg.toFixed(1);
                    document.getElementById('statsEdemaDate').textContent = `Last: ${latestDate}`;
                    const status = latest.edema === 0 ? 'None' : latest.edema <= 2 ? 'Mild' : 'Monitor';
                    document.getElementById('statsEdemaTrend').textContent = status;
                }
                // Quality of Life
                if (latest.qualityOfLife) {
                    document.getElementById('statsQOL').textContent = latest.qualityOfLife;
                    const avg = calcAverage('qualityOfLife');
                    if (avg) document.getElementById('statsQOLAvg').textContent = Math.round(avg);
                    document.getElementById('statsQOLDate').textContent = `Last: ${latestDate}`;
                    const status = latest.qualityOfLife >= 80 ? 'Excellent' : latest.qualityOfLife >= 60 ? 'Good' : 'Fair';
                    document.getElementById('statsQOLTrend').textContent = status;
                }
                // Sleep Quality
                if (latest.sleepQuality !== undefined) {
                    document.getElementById('statsSleep').textContent = latest.sleepQuality;
                    const avg = calcAverage('sleepQuality');
                    if (avg !== null) document.getElementById('statsSleepAvg').textContent = avg.toFixed(1);
                    document.getElementById('statsSleepDate').textContent = `Last: ${latestDate}`;
                    const status = latest.sleepQuality >= 8 ? 'Excellent' : latest.sleepQuality >= 6 ? 'Good' : 'Poor';
                    document.getElementById('statsSleepTrend').textContent = status;
                }
            } catch (error) {
                console.error('Dashboard update error:', error);
                // Fail silently for dashboard - non-critical display issue
            }
        }

        // WEEKLY MILESTONES FUNCTIONS
        function updateWeeklyMilestones() {
            try {
                if (!surgeryDateStr) {
                    document.getElementById('milestonesTitle').textContent = '🎯 Weekly Milestones';
                    document.getElementById('currentWeekTitle').textContent = 'Current Week Achievements';
                    document.getElementById('nextWeekTitle').innerHTML = 'Next Week Goals <button onclick="toggleEditGoals()" style="margin-left: 10px; padding: 4px 12px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">✏️ Edit</button>';
                    return;
                }

                const dates = Object.keys(allData).sort();
                if (dates.length === 0) return;

                // Calculate current week number
                const currentWeekNum = Math.floor((new Date() - new Date(surgeryDateStr)) / (7 * 24 * 60 * 60 * 1000));

                // Update titles
                document.getElementById('milestonesTitle').textContent = `🎯 Week ${currentWeekNum + 1} Milestones`;
                document.getElementById('currentWeekTitle').textContent = `Week ${currentWeekNum + 1} Achievements`;
                document.getElementById('nextWeekTitle').innerHTML = `Week ${currentWeekNum + 2} Goals <button onclick="toggleEditGoals()" style="margin-left: 10px; padding: 4px 12px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">✏️ Edit</button>`;

                // Calculate top milestones
                const topMilestones = calculateTopMilestones(currentWeekNum);

                // Display top 3 milestones
                const milestonesContainer = document.getElementById('topMilestones');
                if (topMilestones.length === 0) {
                    milestonesContainer.innerHTML = '<div style="color: var(--muted); font-size: 0.9rem;">Enter more data to track week-over-week improvements...</div>';
                } else {
                    let milestonesHTML = '';
                    topMilestones.slice(0, 3).forEach((milestone, idx) => {
                        const medalIcon = idx === 0 ? '🥇' : idx === 1 ? '🥈' : '🥉';
                        milestonesHTML += `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2rem;">${medalIcon}</span>
                                    <span style="font-weight: 600; color: var(--text);">${milestone.name}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; color: var(--accent); font-size: 1.1rem;">${milestone.improvement}</div>
                                    <div style="font-size: 0.75rem; color: var(--muted);">${milestone.comparison}</div>
                                </div>
                            </div>
                        `;
                    });
                    milestonesContainer.innerHTML = milestonesHTML;
                }

                // Load and display custom goals
                loadCustomGoals();

            } catch (error) {
                console.error('Weekly milestones update error:', error);
            }
        }

        function calculateTopMilestones(currentWeekNum) {
            const dates = Object.keys(allData).sort();
            if (dates.length < 2) return [];

            // Get current week data and previous week data
            const currentWeekDates = dates.filter(date => {
                const weekNum = Math.floor((new Date(date) - new Date(surgeryDateStr)) / (7 * 24 * 60 * 60 * 1000));
                return weekNum === currentWeekNum;
            });

            const previousWeekDates = dates.filter(date => {
                const weekNum = Math.floor((new Date(date) - new Date(surgeryDateStr)) / (7 * 24 * 60 * 60 * 1000));
                return weekNum === currentWeekNum - 1;
            });

            if (currentWeekDates.length === 0 || previousWeekDates.length === 0) return [];

            // Calculate averages for both weeks
            const metrics = [
                { key: 'vo2Max', name: 'VO2 Max', unit: 'ml/kg/min', higherBetter: true },
                { key: 'restingHR', name: 'Resting HR', unit: 'bpm', higherBetter: false },
                { key: 'hrRecovery', name: 'HR Recovery', unit: 'bpm drop', higherBetter: true },
                { key: 'sdnn', name: 'SDNN (HRV)', unit: 'ms', higherBetter: true },
                { key: 'rmssd', name: 'RMSSD (HRV)', unit: 'ms', higherBetter: true },
                { key: 'walkDistance', name: '6MWD', unit: 'm', higherBetter: true },
                { key: 'mets', name: 'METs', unit: '', higherBetter: true },
                { key: 'ejectionFraction', name: 'Ejection Fraction', unit: '%', higherBetter: true },
                { key: 'oxygenSat', name: 'Oxygen Saturation', unit: '%', higherBetter: true },
                { key: 'bpSystolic', name: 'Systolic BP', unit: 'mmHg', higherBetter: false },
                { key: 'bpDiastolic', name: 'Diastolic BP', unit: 'mmHg', higherBetter: false },
                { key: 'qualityOfLife', name: 'Quality of Life', unit: '/100', higherBetter: true }
            ];

            const improvements = [];

            metrics.forEach(metric => {
                // Calculate current week average
                const currentValues = currentWeekDates.map(d => allData[d][metric.key]).filter(v => v !== undefined && v !== null);
                const previousValues = previousWeekDates.map(d => allData[d][metric.key]).filter(v => v !== undefined && v !== null);

                if (currentValues.length > 0 && previousValues.length > 0) {
                    const currentAvg = currentValues.reduce((a, b) => a + b, 0) / currentValues.length;
                    const previousAvg = previousValues.reduce((a, b) => a + b, 0) / previousValues.length;

                    const diff = currentAvg - previousAvg;
                    const percentChange = ((diff / previousAvg) * 100);

                    // Determine if this is an improvement
                    const isImprovement = metric.higherBetter ? diff > 0 : diff < 0;

                    if (isImprovement) {
                        improvements.push({
                            name: metric.name,
                            improvement: metric.higherBetter
                                ? `+${diff.toFixed(1)} ${metric.unit}`
                                : `${diff.toFixed(1)} ${metric.unit}`,
                            comparison: `${previousAvg.toFixed(1)} → ${currentAvg.toFixed(1)} (${Math.abs(percentChange).toFixed(1)}%)`,
                            percentChange: Math.abs(percentChange)
                        });
                    }
                }
            });

            // Sort by percent improvement and return top 3
            return improvements.sort((a, b) => b.percentChange - a.percentChange);
        }

        function toggleEditGoals() {
            const display = document.getElementById('goalsDisplay');
            const edit = document.getElementById('goalsEdit');

            if (display.style.display === 'none') {
                // Cancel editing
                display.style.display = 'block';
                edit.style.display = 'none';
            } else {
                // Start editing - populate fields with current values
                document.getElementById('editGoal1Name').value = document.getElementById('goal1Name').textContent.replace(':', '');
                document.getElementById('editGoal1Value').value = document.getElementById('goal1Value').textContent;
                document.getElementById('editGoal2Name').value = document.getElementById('goal2Name').textContent.replace(':', '');
                document.getElementById('editGoal2Value').value = document.getElementById('goal2Value').textContent;
                document.getElementById('editGoal3Name').value = document.getElementById('goal3Name').textContent.replace(':', '');
                document.getElementById('editGoal3Value').value = document.getElementById('goal3Value').textContent;

                display.style.display = 'none';
                edit.style.display = 'block';
            }
        }

        function saveCustomGoals() {
            const goals = {
                goal1: {
                    name: document.getElementById('editGoal1Name').value || 'VO2 Max',
                    value: document.getElementById('editGoal1Value').value || 'Improve 5%'
                },
                goal2: {
                    name: document.getElementById('editGoal2Name').value || 'Resting HR',
                    value: document.getElementById('editGoal2Value').value || 'Reduce 2-3 bpm'
                },
                goal3: {
                    name: document.getElementById('editGoal3Name').value || '6MWD',
                    value: document.getElementById('editGoal3Value').value || 'Increase 20m'
                }
            };

            // Save to localStorage
            try {
                localStorage.setItem('customGoals', JSON.stringify(goals));
                showNotification('✅ Goals saved successfully', 'success');
            } catch (error) {
                console.error('Error saving goals:', error);
                showNotification('⚠️ Could not save goals', 'error');
            }

            // Update display
            document.getElementById('goal1Name').textContent = goals.goal1.name + ':';
            document.getElementById('goal1Value').textContent = goals.goal1.value;
            document.getElementById('goal2Name').textContent = goals.goal2.name + ':';
            document.getElementById('goal2Value').textContent = goals.goal2.value;
            document.getElementById('goal3Name').textContent = goals.goal3.name + ':';
            document.getElementById('goal3Value').textContent = goals.goal3.value;

            // Hide edit mode
            document.getElementById('goalsDisplay').style.display = 'block';
            document.getElementById('goalsEdit').style.display = 'none';
        }

        function cancelEditGoals() {
            document.getElementById('goalsDisplay').style.display = 'block';
            document.getElementById('goalsEdit').style.display = 'none';
        }

        function loadCustomGoals() {
            try {
                const savedGoals = localStorage.getItem('customGoals');
                if (savedGoals) {
                    const goals = JSON.parse(savedGoals);
                    document.getElementById('goal1Name').textContent = goals.goal1.name + ':';
                    document.getElementById('goal1Value').textContent = goals.goal1.value;
                    document.getElementById('goal2Name').textContent = goals.goal2.name + ':';
                    document.getElementById('goal2Value').textContent = goals.goal2.value;
                    document.getElementById('goal3Name').textContent = goals.goal3.name + ':';
                    document.getElementById('goal3Value').textContent = goals.goal3.value;
                }
            } catch (error) {
                console.error('Error loading custom goals:', error);
            }
        }

        // DELETE DATA
        function deleteEntry(dateStr) {
            if (confirm(`Delete all data for ${dateStr}?`)) {
                delete allData[dateStr];

                // Save deletion with error handling
                try {
                    localStorage.setItem('cardiacRecoveryData', JSON.stringify(allData));
                    showNotification('Data deleted', 'success');
                } catch (error) {
                    console.error('Error saving after deletion:', error);
                    showNotification('⚠️ Deleted from memory but could not persist', 'error');
                }

                // Update UI regardless of save status
                refreshHistoryTable();
                updateDashboard();
                updateWeeklyMilestones();
                updateCharts();
            }
        }

        function clearForm() {
            if (confirm('Clear the current form?')) {
                document.querySelectorAll('.metric-field input').forEach(input => input.value = '');
                document.getElementById('dailyNotes').value = '';
            }
        }

        // CLEAR ALL PATIENT DATA
        function clearAllPatientData() {
            const confirmation = confirm(
                '⚠️ WARNING: This will permanently delete ALL patient data including:\n\n' +
                '• All recorded metrics and measurements\n' +
                '• All therapy sessions\n' +
                '• All historical data\n' +
                '• All goals and milestones\n' +
                '• Surgery date and patient information\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Are you absolutely sure you want to continue?'
            );

            if (!confirmation) {
                return;
            }

            // Second confirmation for safety
            const finalConfirmation = confirm(
                'FINAL CONFIRMATION:\n\n' +
                'Type YES in your mind if you really want to delete everything.\n\n' +
                'Click OK to proceed with deletion, or Cancel to keep your data.'
            );

            if (!finalConfirmation) {
                return;
            }

            try {
                // Clear all localStorage data
                localStorage.removeItem('cardiacRecoveryData');
                localStorage.removeItem('surgeryDate');
                localStorage.removeItem('sessionHistory');
                localStorage.removeItem('weeklyGoals');

                // Reset in-memory data
                allData = {};
                surgeryDate = null;

                // Reset UI elements
                document.getElementById('statsWeeks').textContent = '0';
                document.getElementById('statsVO2').textContent = '--';
                document.getElementById('statsVO2Avg').textContent = '--';
                document.getElementById('statsVO2Trend').textContent = 'No data yet';
                document.getElementById('statsVO2Date').textContent = '--';
                document.getElementById('statsHR').textContent = '--';
                document.getElementById('statsHRAvg').textContent = '--';
                document.getElementById('statsHRTrend').textContent = 'No data yet';
                document.getElementById('statsHRDate').textContent = '--';
                document.getElementById('statsSDNN').textContent = '--';
                document.getElementById('statsSDNNAvg').textContent = '--';
                document.getElementById('statsSDNNTrend').textContent = 'No data yet';
                document.getElementById('statsSDNNDate').textContent = '--';

                // Clear all input fields
                document.querySelectorAll('.metric-field input').forEach(input => input.value = '');
                if (document.getElementById('dailyNotes')) {
                    document.getElementById('dailyNotes').value = '';
                }

                // Reset charts
                updateCharts();

                // Refresh history table
                refreshHistoryTable();

                // Clear milestones
                if (document.getElementById('topMilestones')) {
                    document.getElementById('topMilestones').innerHTML =
                        '<div style="color: var(--muted); font-size: 0.9rem;">Enter data to see your progress...</div>';
                }

                // Show success notification
                showNotification('✅ All patient data has been cleared successfully', 'success');

                // Switch to Dashboard tab
                switchTab('dashboard');
            } catch (error) {
                console.error('Error clearing data:', error);
                showNotification('❌ Error clearing data: ' + error.message, 'error');
            }
        }

        // HISTORY TABLE
        function refreshHistoryTable() {
            try {
                const tbody = document.getElementById('historyBody');
                const dates = Object.keys(allData).sort().reverse();

                if (dates.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="24" style="text-align: center; color: var(--muted);">No data yet</td></tr>';
                    return;
                }

                tbody.innerHTML = dates.map(date => {
                    const data = allData[date];
                    const dayNum = surgeryDateStr ?
                        Math.floor((new Date(date) - new Date(surgeryDateStr)) / (1000 * 60 * 60 * 24)) + 1 : '?';

                    return `
                        <tr>
                            <td>${date}</td>
                            <td>Day ${dayNum}</td>
                            <td>${data.restingHR || '-'}</td>
                            <td>${data.bpSystolic || '-'}</td>
                            <td>${data.bpDiastolic || '-'}</td>
                            <td>${data.vo2Max || '-'}</td>
                            <td>${data.maxHR || '-'}</td>
                            <td>${data.hrRecovery || '-'}</td>
                            <td>${data.sdnn || '-'}</td>
                            <td>${data.rmssd || '-'}</td>
                            <td>${data.pnn50 !== undefined ? data.pnn50 : '-'}</td>
                            <td>${data.walkDistance || '-'}</td>
                            <td>${data.mets || '-'}</td>
                            <td>${data.ejectionFraction || '-'}</td>
                            <td>${data.oxygenSat || '-'}</td>
                            <td>${data.respRate || '-'}</td>
                            <td>${data.weight || '-'}</td>
                            <td>${data.dyspnea !== undefined ? data.dyspnea : '-'}</td>
                            <td>${data.chestPain !== undefined ? data.chestPain : '-'}</td>
                            <td>${data.fatigue !== undefined ? data.fatigue : '-'}</td>
                            <td>${data.edema !== undefined ? data.edema : '-'}</td>
                            <td>${data.qualityOfLife || '-'}</td>
                            <td>${data.sleepQuality !== undefined ? data.sleepQuality : '-'}</td>
                            <td><button class="delete-entry-btn" onclick="deleteEntry('${date}')">🗑️</button></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('History table error:', error);
                const tbody = document.getElementById('historyBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="24" style="text-align: center; color: var(--bad);">⚠️ Error loading history table</td></tr>';
                }
            }
        }

        // THERAPY SESSION MANAGEMENT
        let therapySessions = [];

        // Load sessions from localStorage
        try {
            const storedSessions = localStorage.getItem('therapySessions');
            therapySessions = storedSessions ? JSON.parse(storedSessions) : [];
        } catch (error) {
            console.error('Error loading therapy sessions:', error);
            therapySessions = [];
        }

        function saveTherapySession() {
            const session = {
                id: Date.now().toString(),
                sessionDate: document.getElementById('sessionDate').value,
                sessionTime: document.getElementById('sessionTime').value,
                duration: document.getElementById('sessionDuration').value,
                therapistName: document.getElementById('therapistName').value,
                therapyCompany: document.getElementById('therapyCompany').value,
                therapistCredentials: document.getElementById('therapistCredentials').value,
                exerciseType: document.getElementById('exerciseType').value,
                exerciseIntensity: document.getElementById('exerciseIntensity').value,
                targetHeartRate: document.getElementById('targetHeartRate').value,
                treatmentGoal: document.getElementById('treatmentGoal').value,
                therapistNotes: document.getElementById('therapistNotes').value,
                redFlags: document.getElementById('redFlags').value,
                homeExerciseInstructions: document.getElementById('homeExerciseInstructions').value,
                createdAt: new Date().toISOString()
            };

            // Validation
            if (!session.sessionDate) {
                showNotification('⚠️ Session date is required', 'error');
                return;
            }

            // Check for red flags and trigger notification
            if (session.redFlags && session.redFlags.trim()) {
                const confirmSave = confirm(
                    '⚠️ RED FLAG ALERT ⚠️\n\n' +
                    'This session contains red flags that will trigger an immediate notification to the care team.\n\n' +
                    'Red Flag:\n' + session.redFlags + '\n\n' +
                    'Do you want to save this session and notify the care team?'
                );

                if (!confirmSave) {
                    return;
                }

                // Trigger care team notification
                triggerCareTeamNotification(session);
            }

            // Add to sessions array
            therapySessions.push(session);

            // Save to localStorage
            try {
                localStorage.setItem('therapySessions', JSON.stringify(therapySessions));
                showNotification('✅ Therapy session saved successfully', 'success');
            } catch (error) {
                console.error('Error saving session:', error);
                showNotification('⚠️ Could not save session persistently', 'error');
            }

            // Clear form and refresh history
            clearSessionForm();
            refreshSessionsTable();
        }

        function clearSessionForm() {
            document.getElementById('sessionDate').value = '';
            document.getElementById('sessionTime').value = '';
            document.getElementById('sessionDuration').value = '';
            document.getElementById('therapistName').value = '';
            document.getElementById('therapyCompany').value = '';
            document.getElementById('therapistCredentials').value = '';
            document.getElementById('exerciseType').value = '';
            document.getElementById('exerciseIntensity').value = '';
            document.getElementById('targetHeartRate').value = '';
            document.getElementById('treatmentGoal').value = '';
            document.getElementById('therapistNotes').value = '';
            document.getElementById('redFlags').value = '';
            document.getElementById('homeExerciseInstructions').value = '';
        }

        function refreshSessionsTable() {
            try {
                const tbody = document.getElementById('sessionsBody');

                if (therapySessions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--muted);">No sessions recorded yet</td></tr>';
                    return;
                }

                // Sort by date descending
                const sortedSessions = [...therapySessions].sort((a, b) => {
                    return new Date(b.sessionDate + ' ' + (b.sessionTime || '00:00')) -
                           new Date(a.sessionDate + ' ' + (a.sessionTime || '00:00'));
                });

                tbody.innerHTML = sortedSessions.map(session => {
                    const hasRedFlags = session.redFlags && session.redFlags.trim();
                    const redFlagIcon = hasRedFlags ? '🚨' : '-';
                    const redFlagStyle = hasRedFlags ? 'color: var(--bad); font-weight: 700;' : '';

                    return `
                        <tr onclick="viewSessionDetails('${session.id}')" style="cursor: pointer;" title="Click to view full details">
                            <td>${session.sessionDate || '-'}</td>
                            <td>${session.sessionTime || '-'}</td>
                            <td>${session.therapistName || '-'}</td>
                            <td>${session.therapyCompany || '-'}</td>
                            <td>${session.duration ? session.duration + ' min' : '-'}</td>
                            <td>${session.exerciseType || '-'}</td>
                            <td style="${redFlagStyle}">${redFlagIcon}</td>
                            <td>
                                <button class="delete-entry-btn" onclick="event.stopPropagation(); deleteSession('${session.id}')" title="Delete session">🗑️</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Sessions table error:', error);
                const tbody = document.getElementById('sessionsBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--bad);">⚠️ Error loading sessions table</td></tr>';
                }
            }
        }

        function viewSessionDetails(sessionId) {
            const session = therapySessions.find(s => s.id === sessionId);
            if (!session) return;

            const details = `
📅 Session Date: ${session.sessionDate || 'Not specified'}
🕐 Time: ${session.sessionTime || 'Not specified'}
⏱️ Duration: ${session.duration ? session.duration + ' minutes' : 'Not specified'}

👨‍⚕️ THERAPIST INFORMATION
Name: ${session.therapistName || 'Not specified'}
Credentials: ${session.therapistCredentials || 'Not specified'}
Facility: ${session.therapyCompany || 'Not specified'}

🏃 EXERCISE DETAILS
Type: ${session.exerciseType || 'Not specified'}
Intensity: ${session.exerciseIntensity || 'Not specified'}
Target HR: ${session.targetHeartRate ? session.targetHeartRate + ' bpm' : 'Not specified'}

🎯 TREATMENT GOAL
${session.treatmentGoal || 'Not specified'}

📝 THERAPIST SESSION NOTES
${session.therapistNotes || 'No notes recorded'}

${session.redFlags ? '⚠️ RED FLAGS / CARE TEAM ALERTS\n' + session.redFlags + '\n\n' : ''}📋 AT-HOME EXERCISE PLAN
${session.homeExerciseInstructions || 'No at-home instructions provided'}
            `.trim();

            alert(details);
        }

        function deleteSession(sessionId) {
            if (confirm('Delete this therapy session?')) {
                therapySessions = therapySessions.filter(s => s.id !== sessionId);

                try {
                    localStorage.setItem('therapySessions', JSON.stringify(therapySessions));
                    showNotification('Session deleted', 'success');
                } catch (error) {
                    console.error('Error deleting session:', error);
                }

                refreshSessionsTable();
            }
        }

        function triggerCareTeamNotification(session) {
            // This function will be wired to the main application's notification system
            // For now, it logs the notification that would be sent
            const notification = {
                type: 'RED_FLAG_ALERT',
                priority: 'URGENT',
                patientName: patientName || 'Unknown Patient',
                sessionDate: session.sessionDate,
                therapist: session.therapistName,
                redFlags: session.redFlags,
                therapistNotes: session.therapistNotes,
                timestamp: new Date().toISOString()
            };

            console.warn('🚨 CARE TEAM NOTIFICATION TRIGGERED:', notification);

            // When integrated with master app, this will call:
            // window.parent.postMessage({ type: 'CARE_TEAM_ALERT', data: notification }, '*');
            // or use the main app's notification API

            showNotification('🚨 Care team has been notified of red flags', 'error');
        }

        // AUTOCOMPLETE
        function showExerciseSuggestions(value) {
            const suggestions = document.getElementById('exerciseSuggestions');
            if (value.length === 0) {
                suggestions.classList.remove('show');
                return;
            }

            const filtered = exerciseTypes.filter(type =>
                type.toLowerCase().includes(value.toLowerCase())
            );

            if (filtered.length === 0) {
                suggestions.classList.remove('show');
                return;
            }

            suggestions.innerHTML = filtered.map(type =>
                `<div class="autocomplete-item" onclick="selectExercise('${type}')">${type}</div>`
            ).join('');
            suggestions.classList.add('show');
        }

        function selectExercise(type) {
            document.getElementById('exerciseType').value = type;
            document.getElementById('exerciseSuggestions').classList.remove('show');
        }

        // POPULATION COMPARISON CALCULATIONS
        function calculatePopulationComparison() {
            const dates = Object.keys(allData).sort();
            if (dates.length === 0) {
                return {
                    hasData: false
                };
            }

            const latest = allData[dates[dates.length - 1]];

            // Age-stratified VO2 Max norms for cardiac patients (ACSM Guidelines)
            // Using 50-year-old male baseline (adjust based on age/gender in full version)
            const populationNorms = {
                poor: 14,      // <14 ml/kg/min
                fair: 20,      // 14-20 ml/kg/min
                good: 24,      // 20-24 ml/kg/min
                excellent: 28  // >28 ml/kg/min
            };

            const userVO2 = latest.vo2Max || null;
            let percentile = null;
            let riskLevel = 'UNKNOWN';
            let position = 'No data';

            if (userVO2) {
                // Calculate percentile based on VO2 Max
                if (userVO2 >= populationNorms.excellent) {
                    percentile = 90 + Math.min(10, (userVO2 - populationNorms.excellent) / 2);
                } else if (userVO2 >= populationNorms.good) {
                    percentile = 75 + ((userVO2 - populationNorms.good) / (populationNorms.excellent - populationNorms.good)) * 15;
                } else if (userVO2 >= populationNorms.fair) {
                    percentile = 50 + ((userVO2 - populationNorms.fair) / (populationNorms.good - populationNorms.fair)) * 25;
                } else if (userVO2 >= populationNorms.poor) {
                    percentile = 25 + ((userVO2 - populationNorms.poor) / (populationNorms.fair - populationNorms.poor)) * 25;
                } else {
                    percentile = (userVO2 / populationNorms.poor) * 25;
                }

                // Determine position
                if (percentile >= 75) position = 'Excellent';
                else if (percentile >= 50) position = 'Above Average';
                else if (percentile >= 25) position = 'Average';
                else position = 'Below Average';
            }

            // Calculate risk level based on multiple factors
            let riskScore = 0;

            // VO2 Max risk factor
            if (userVO2) {
                if (userVO2 < 14) riskScore += 3;
                else if (userVO2 < 20) riskScore += 2;
                else if (userVO2 < 24) riskScore += 1;
            }

            // HR Recovery risk factor
            if (latest.hrRecovery) {
                if (latest.hrRecovery < 12) riskScore += 3;
                else if (latest.hrRecovery < 18) riskScore += 2;
                else if (latest.hrRecovery < 22) riskScore += 1;
            }

            // Ejection Fraction risk factor
            if (latest.ejectionFraction) {
                if (latest.ejectionFraction < 30) riskScore += 3;
                else if (latest.ejectionFraction < 40) riskScore += 2;
                else if (latest.ejectionFraction < 50) riskScore += 1;
            }

            // Resting HR risk factor
            if (latest.restingHR) {
                if (latest.restingHR > 90) riskScore += 2;
                else if (latest.restingHR > 80) riskScore += 1;
            }

            // Determine overall risk
            if (riskScore >= 6) riskLevel = 'HIGH';
            else if (riskScore >= 3) riskLevel = 'MODERATE';
            else if (riskScore >= 0) riskLevel = 'LOW';

            return {
                hasData: true,
                userVO2: userVO2,
                percentile: percentile,
                position: position,
                riskLevel: riskLevel,
                avgVO2: populationNorms.fair,
                goodThreshold: populationNorms.good
            };
        }

        function updatePopulationComparison() {
            try {
                const comparison = calculatePopulationComparison();

                if (!comparison.hasData) {
                    document.getElementById('yourVO2').textContent = '--';
                    document.getElementById('yourPercentile').textContent = 'No data yet';
                    document.getElementById('yourRiskLevel').textContent = '--';
                    document.getElementById('yourPosition').textContent = 'No data';
                    return;
                }

            // Update "Your Metrics" card
            if (comparison.userVO2) {
                document.getElementById('yourVO2').textContent = `${comparison.userVO2.toFixed(1)} ml/kg/min`;
            } else {
                document.getElementById('yourVO2').textContent = '--';
            }

            if (comparison.percentile) {
                const percentileStr = `${Math.round(comparison.percentile)}th percentile`;
                document.getElementById('yourPercentile').textContent = percentileStr;

                // Color code based on percentile
                const percentileEl = document.getElementById('yourPercentile');
                if (comparison.percentile >= 75) {
                    percentileEl.className = 'metric-value good';
                } else if (comparison.percentile >= 50) {
                    percentileEl.className = 'metric-value';
                    percentileEl.style.color = 'var(--cyan)';
                } else {
                    percentileEl.className = 'metric-value';
                    percentileEl.style.color = 'var(--warn)';
                }
            }

            document.getElementById('yourRiskLevel').textContent = comparison.riskLevel;
            const riskEl = document.getElementById('yourRiskLevel');
            if (comparison.riskLevel === 'LOW') {
                riskEl.className = 'metric-value good';
            } else if (comparison.riskLevel === 'MODERATE') {
                riskEl.className = 'metric-value';
                riskEl.style.color = 'var(--warn)';
            } else if (comparison.riskLevel === 'HIGH') {
                riskEl.className = 'metric-value';
                riskEl.style.color = 'var(--bad)';
            }

            // Update "Age/Gender Baseline" card
            document.getElementById('avgVO2').textContent = `${comparison.avgVO2.toFixed(1)} ml/kg/min`;
            document.getElementById('goodThreshold').textContent = `${comparison.goodThreshold.toFixed(1)} ml/kg/min`;
            document.getElementById('yourPosition').textContent = comparison.position;

            const positionEl = document.getElementById('yourPosition');
            if (comparison.position === 'Excellent' || comparison.position === 'Above Average') {
                positionEl.className = 'metric-value good';
            } else if (comparison.position === 'Average') {
                positionEl.className = 'metric-value';
                positionEl.style.color = 'var(--cyan)';
            } else {
                positionEl.className = 'metric-value';
                positionEl.style.color = 'var(--warn)';
            }
            } catch (error) {
                console.error('Population comparison error:', error);
                // Fail silently - non-critical display feature
            }
        }

        // CHARTS
        let charts = {};

        function initializeCharts() {
            updateCharts();
            updatePopulationComparison();
        }

        function updateCharts() {
            // Wrap each chart update in try-catch for graceful degradation
            try {
                updateProgressChart();
            } catch (error) {
                console.error('Progress chart error:', error);
                displayChartError('progressChart', 'Progress Chart');
            }

            try {
                updateMetricsChart();
            } catch (error) {
                console.error('Metrics chart error:', error);
                displayChartError('metricsChart', 'Metrics Chart');
            }

            try {
                updateHRVChart();
            } catch (error) {
                console.error('HRV chart error:', error);
                displayChartError('hrvChart', 'HRV Chart');
            }

            try {
                updateRadarChart();
            } catch (error) {
                console.error('Radar chart error:', error);
                displayChartError('radarChart', 'Radar Chart');
            }

            try {
                updateRiskChart();
            } catch (error) {
                console.error('Risk chart error:', error);
                displayChartError('riskChart', 'Risk Chart');
            }

            try {
                updateRecoveryProgressChart();
            } catch (error) {
                console.error('Recovery Progress chart error:', error);
                displayChartError('recoveryProgressChart', 'Recovery Progress Chart');
            }

            try {
                initializeCRPSTrendChart();
            } catch (error) {
                console.error('CRPS Trend chart error:', error);
                displayChartError('crpsTrendChart', 'CRPS Trend Chart');
            }
        }

        // Display friendly error message when chart fails
        function displayChartError(canvasId, chartName) {
            const canvas = document.getElementById(canvasId);
            if (canvas && canvas.parentElement) {
                canvas.style.display = 'none';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chart-error';
                errorDiv.style.cssText = 'padding: 40px; text-align: center; color: var(--bad); background: rgba(220, 38, 38, 0.1); border-radius: 8px; margin: 20px 0;';
                errorDiv.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 10px;">⚠️</div>
                    <div style="font-weight: 600; margin-bottom: 5px;">${chartName} Unavailable</div>
                    <div style="font-size: 0.9rem; color: var(--muted);">Unable to load chart. Check console for details.</div>
                `;
                canvas.parentElement.appendChild(errorDiv);
            }
        }

        // CALCULATE PERSONALIZED RECOVERY TRAJECTORY
        function calculatePersonalizedRecovery() {
            const dates = Object.keys(allData).sort();

            // Default generic curve if no baseline data
            let baselineVO2 = 12; // Typical post-cardiac surgery baseline
            let hasBaseline = false;

            if (surgeryDateStr && dates.length > 0) {
                // Look for earliest VO2 data (within first 2 weeks)
                const surgeryDate = new Date(surgeryDateStr);
                const twoWeeksOut = new Date(surgeryDate);
                twoWeeksOut.setDate(twoWeeksOut.getDate() + 14);

                for (const dateStr of dates) {
                    const date = new Date(dateStr);
                    if (date >= surgeryDate && date <= twoWeeksOut) {
                        if (allData[dateStr].vo2Max !== undefined) {
                            baselineVO2 = allData[dateStr].vo2Max;
                            hasBaseline = true;
                            break; // Use first available baseline
                        }
                    }
                }
            }

            // Target VO2 based on age-adjusted norms (using 50-year-old standard)
            // In full version, this would be personalized by actual age/gender
            const targetVO2 = 28; // Good recovery target

            // Calculate personalized week-by-week expected recovery
            // Using exponential recovery curve: faster gains early, plateau later
            const personalizedCurve = [];
            for (let week = 0; week < 12; week++) {
                // Recovery follows an exponential curve: y = baseline + (target - baseline) * (1 - e^(-k*t))
                // Simplified to power function for readability
                const progressFactor = Math.pow(week / 12, 0.6); // 0.6 exponent = faster early gains
                const expectedVO2 = baselineVO2 + (targetVO2 - baselineVO2) * progressFactor;
                personalizedCurve.push(parseFloat(expectedVO2.toFixed(1)));
            }

            return {
                curve: personalizedCurve,
                baseline: baselineVO2,
                target: targetVO2,
                isPersonalized: hasBaseline
            };
        }

        function updateProgressChart() {
            const canvas = document.getElementById('progressChart');
            const weeks = Array.from({length: 12}, (_, i) => `Week ${i + 1}`);
            const dates = Object.keys(allData).sort();

            // Initialize data arrays for all metrics
            const vo2Data = new Array(12).fill(null);
            const hrData = new Array(12).fill(null);
            const sdnnData = new Array(12).fill(null);
            const bpSystolicData = new Array(12).fill(null);
            const maxHRData = new Array(12).fill(null);
            const hrRecoveryData = new Array(12).fill(null);
            const rmssdData = new Array(12).fill(null);
            const pnn50Data = new Array(12).fill(null);
            const walkDistanceData = new Array(12).fill(null);
            const metsData = new Array(12).fill(null);
            const ejectionFractionData = new Array(12).fill(null);
            const oxygenSatData = new Array(12).fill(null);
            const respRateData = new Array(12).fill(null);
            const weightData = new Array(12).fill(null);
            const dyspneaData = new Array(12).fill(null);
            const chestPainData = new Array(12).fill(null);
            const fatigueData = new Array(12).fill(null);
            const edemaData = new Array(12).fill(null);
            const qolData = new Array(12).fill(null);
            const sleepData = new Array(12).fill(null);

            dates.forEach(date => {
                if (!surgeryDateStr) return;
                const weekNum = Math.floor((new Date(date) - new Date(surgeryDateStr)) / (7 * 24 * 60 * 60 * 1000));
                if (weekNum >= 0 && weekNum < 12) {
                    const data = allData[date];
                    if (data.vo2Max) vo2Data[weekNum] = data.vo2Max;
                    if (data.restingHR) hrData[weekNum] = data.restingHR;
                    if (data.sdnn) sdnnData[weekNum] = data.sdnn;
                    if (data.bpSystolic) bpSystolicData[weekNum] = data.bpSystolic;
                    if (data.maxHR) maxHRData[weekNum] = data.maxHR;
                    if (data.hrRecovery) hrRecoveryData[weekNum] = data.hrRecovery;
                    if (data.rmssd) rmssdData[weekNum] = data.rmssd;
                    if (data.pnn50) pnn50Data[weekNum] = data.pnn50;
                    if (data.walkDistance) walkDistanceData[weekNum] = data.walkDistance;
                    if (data.mets) metsData[weekNum] = data.mets;
                    if (data.ejectionFraction) ejectionFractionData[weekNum] = data.ejectionFraction;
                    if (data.oxygenSat) oxygenSatData[weekNum] = data.oxygenSat;
                    if (data.respRate) respRateData[weekNum] = data.respRate;
                    if (data.weight) weightData[weekNum] = data.weight;
                    if (data.dyspnea !== undefined) dyspneaData[weekNum] = data.dyspnea;
                    if (data.chestPain !== undefined) chestPainData[weekNum] = data.chestPain;
                    if (data.fatigue !== undefined) fatigueData[weekNum] = data.fatigue;
                    if (data.edema !== undefined) edemaData[weekNum] = data.edema;
                    if (data.qualityOfLife) qolData[weekNum] = data.qualityOfLife;
                    if (data.sleepQuality !== undefined) sleepData[weekNum] = data.sleepQuality;
                }
            });

            // Get personalized recovery curve
            const recoveryPlan = calculatePersonalizedRecovery();
            const expectedLabel = recoveryPlan.isPersonalized ?
                'Your Expected Recovery' :
                'Expected VO2 (Generic)';

            // Update existing chart or create new one
            if (charts.progress) {
                charts.progress.data.datasets[0].data = vo2Data;
                charts.progress.data.datasets[1].data = hrData;
                charts.progress.data.datasets[2].data = sdnnData;
                charts.progress.data.datasets[3].data = bpSystolicData;
                charts.progress.data.datasets[4].data = maxHRData;
                charts.progress.data.datasets[5].data = hrRecoveryData;
                charts.progress.data.datasets[6].data = rmssdData;
                charts.progress.data.datasets[7].data = pnn50Data;
                charts.progress.data.datasets[8].data = walkDistanceData;
                charts.progress.data.datasets[9].data = metsData;
                charts.progress.data.datasets[10].data = ejectionFractionData;
                charts.progress.data.datasets[11].data = oxygenSatData;
                charts.progress.data.datasets[12].data = respRateData;
                charts.progress.data.datasets[13].data = weightData;
                charts.progress.data.datasets[14].data = dyspneaData;
                charts.progress.data.datasets[15].data = chestPainData;
                charts.progress.data.datasets[16].data = fatigueData;
                charts.progress.data.datasets[17].data = edemaData;
                charts.progress.data.datasets[18].data = qolData;
                charts.progress.data.datasets[19].data = sleepData;
                charts.progress.data.datasets[20].data = recoveryPlan.curve;
                charts.progress.data.datasets[20].label = expectedLabel;
                charts.progress.data.datasets[20].borderColor = recoveryPlan.isPersonalized ? '#a78bfa' : '#9ca3af';
                charts.progress.update('none');
            } else {
                charts.progress = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: weeks,
                        datasets: [
                            {
                                label: 'VO2 Max',
                                data: vo2Data,
                                borderColor: '#60a5fa',
                                backgroundColor: 'rgba(96,165,250,0.2)',
                                borderWidth: 3,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Resting HR',
                                data: hrData,
                                borderColor: '#ef4444',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'SDNN',
                                data: sdnnData,
                                borderColor: '#06b6d4',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'BP Systolic',
                                data: bpSystolicData,
                                borderColor: '#f59e0b',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Max HR',
                                data: maxHRData,
                                borderColor: '#ec4899',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'HR Recovery',
                                data: hrRecoveryData,
                                borderColor: '#8b5cf6',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'RMSSD',
                                data: rmssdData,
                                borderColor: '#14b8a6',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'pNN50',
                                data: pnn50Data,
                                borderColor: '#84cc16',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: '6-Min Walk (m)',
                                data: walkDistanceData,
                                borderColor: '#22c55e',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'METs',
                                data: metsData,
                                borderColor: '#10b981',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Ejection Fraction',
                                data: ejectionFractionData,
                                borderColor: '#f97316',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Oxygen Saturation',
                                data: oxygenSatData,
                                borderColor: '#3b82f6',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Respiratory Rate',
                                data: respRateData,
                                borderColor: '#0ea5e9',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Weight (kg)',
                                data: weightData,
                                borderColor: '#6366f1',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Dyspnea Score',
                                data: dyspneaData,
                                borderColor: '#d946ef',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Chest Pain',
                                data: chestPainData,
                                borderColor: '#dc2626',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Fatigue',
                                data: fatigueData,
                                borderColor: '#ca8a04',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Edema',
                                data: edemaData,
                                borderColor: '#0891b2',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Quality of Life',
                                data: qolData,
                                borderColor: '#16a34a',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Sleep Quality',
                                data: sleepData,
                                borderColor: '#4f46e5',
                                borderWidth: 2,
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: expectedLabel,
                                data: recoveryPlan.curve,
                                borderColor: recoveryPlan.isPersonalized ? '#a78bfa' : '#9ca3af',
                                borderWidth: recoveryPlan.isPersonalized ? 3 : 2,
                                borderDash: [5, 5],
                                tension: 0.4,
                                pointRadius: 0,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Population Average VO2',
                                data: new Array(12).fill(20),
                                borderColor: '#22c55e',
                                borderWidth: 2,
                                borderDash: [10, 5],
                                tension: 0,
                                pointRadius: 0,
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        ...getChartOptions(),
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            }
        }

        function updateMetricsChart() {
            const canvas = document.getElementById('metricsChart');
            const dates = Object.keys(allData).sort().map(d => new Date(d).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
            const vo2 = Object.keys(allData).sort().map(d => allData[d].vo2Max || null);
            const hr = Object.keys(allData).sort().map(d => allData[d].restingHR || null);
            const sdnn = Object.keys(allData).sort().map(d => allData[d].sdnn || null);

            if (charts.metrics) {
                charts.metrics.data.labels = dates;
                charts.metrics.data.datasets[0].data = vo2;
                charts.metrics.data.datasets[1].data = hr;
                charts.metrics.data.datasets[2].data = sdnn;
                charts.metrics.update('none');
            } else {
                charts.metrics = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            { label: 'VO2 Max', data: vo2, borderColor: '#60a5fa', borderWidth: 3, tension: 0.4, spanGaps: true },
                            { label: 'Resting HR', data: hr, borderColor: '#ef4444', borderWidth: 3, tension: 0.4, spanGaps: true },
                            { label: 'SDNN', data: sdnn, borderColor: '#06b6d4', borderWidth: 3, tension: 0.4, spanGaps: true }
                        ]
                    },
                    options: getChartOptions()
                });
            }
        }

        function updateHRVChart() {
            const canvas = document.getElementById('hrvChart');
            const dates = Object.keys(allData).sort().map(d => new Date(d).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
            const sdnn = Object.keys(allData).sort().map(d => allData[d].sdnn || null);
            const rmssd = Object.keys(allData).sort().map(d => allData[d].rmssd || null);
            const pnn50 = Object.keys(allData).sort().map(d => allData[d].pnn50 || null);

            if (charts.hrv) {
                charts.hrv.data.labels = dates;
                charts.hrv.data.datasets[0].data = sdnn;
                charts.hrv.data.datasets[1].data = rmssd;
                charts.hrv.data.datasets[2].data = pnn50;
                charts.hrv.update('none');
            } else {
                charts.hrv = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            { label: 'SDNN', data: sdnn, borderColor: '#06b6d4', borderWidth: 3, tension: 0.4, spanGaps: true },
                            { label: 'RMSSD', data: rmssd, borderColor: '#a78bfa', borderWidth: 3, tension: 0.4, spanGaps: true },
                            { label: 'pNN50', data: pnn50, borderColor: '#22c55e', borderWidth: 3, tension: 0.4, spanGaps: true }
                        ]
                    },
                    options: getChartOptions()
                });
            }
        }

        // CALCULATE NORMALIZED RADAR SCORES FROM REAL USER DATA
        function calculateRadarScores() {
            const dates = Object.keys(allData).sort();
            if (dates.length === 0) {
                return {
                    userScores: [0, 0, 0, 0, 0, 0],
                    hasData: false
                };
            }

            const latest = allData[dates[dates.length - 1]];

            // Normalize each metric to 0-100 scale based on medical standards
            const scores = [];

            // 1. VO2 Max (ml/kg/min): Poor <14, Fair 14-20, Good 20-28, Excellent >28
            if (latest.vo2Max) {
                if (latest.vo2Max >= 28) scores.push(100);
                else if (latest.vo2Max >= 20) scores.push(50 + ((latest.vo2Max - 20) / 8) * 50);
                else if (latest.vo2Max >= 14) scores.push(25 + ((latest.vo2Max - 14) / 6) * 25);
                else scores.push((latest.vo2Max / 14) * 25);
            } else {
                scores.push(0);
            }

            // 2. HR Recovery (bpm drop in 1 min): Poor <12, Fair 12-20, Good 20-25, Excellent >25
            if (latest.hrRecovery) {
                if (latest.hrRecovery >= 25) scores.push(100);
                else if (latest.hrRecovery >= 20) scores.push(75 + ((latest.hrRecovery - 20) / 5) * 25);
                else if (latest.hrRecovery >= 12) scores.push(50 + ((latest.hrRecovery - 12) / 8) * 25);
                else scores.push((latest.hrRecovery / 12) * 50);
            } else {
                scores.push(0);
            }

            // 3. Resting HR (bpm): Excellent <60, Good 60-70, Fair 70-80, Poor >80 (INVERTED - lower is better)
            if (latest.restingHR) {
                if (latest.restingHR <= 60) scores.push(100);
                else if (latest.restingHR <= 70) scores.push(75 + ((70 - latest.restingHR) / 10) * 25);
                else if (latest.restingHR <= 80) scores.push(50 + ((80 - latest.restingHR) / 10) * 25);
                else scores.push(Math.max(0, 50 - ((latest.restingHR - 80) / 20) * 50));
            } else {
                scores.push(0);
            }

            // 4. HRV (SDNN in ms): Poor <20, Fair 20-35, Good 35-50, Excellent >50
            if (latest.sdnn) {
                if (latest.sdnn >= 50) scores.push(100);
                else if (latest.sdnn >= 35) scores.push(75 + ((latest.sdnn - 35) / 15) * 25);
                else if (latest.sdnn >= 20) scores.push(50 + ((latest.sdnn - 20) / 15) * 25);
                else scores.push((latest.sdnn / 20) * 50);
            } else {
                scores.push(0);
            }

            // 5. Exercise Capacity (METs): Poor <5, Fair 5-7, Good 7-10, Excellent >10
            if (latest.mets) {
                if (latest.mets >= 10) scores.push(100);
                else if (latest.mets >= 7) scores.push(75 + ((latest.mets - 7) / 3) * 25);
                else if (latest.mets >= 5) scores.push(50 + ((latest.mets - 5) / 2) * 25);
                else scores.push((latest.mets / 5) * 50);
            } else {
                scores.push(0);
            }

            // 6. Recovery Speed (based on weeks post-op vs VO2 improvement)
            let recoveryScore = 0;
            if (surgeryDateStr && latest.vo2Max) {
                const weeksSurgery = Math.floor((new Date(dates[dates.length - 1]) - new Date(surgeryDateStr)) / (7 * 24 * 60 * 60 * 1000));
                if (weeksSurgery > 0) {
                    // Compare to expected recovery (should gain ~1.3 ml/kg/min per week)
                    const expectedGain = weeksSurgery * 1.3;
                    const baselineVO2 = 12; // Typical post-surgery baseline
                    const expectedVO2 = baselineVO2 + expectedGain;
                    const percentOfExpected = (latest.vo2Max / expectedVO2) * 100;
                    recoveryScore = Math.min(100, Math.max(0, percentOfExpected));
                } else {
                    recoveryScore = 50; // Default if no time elapsed
                }
            }
            scores.push(recoveryScore);

            return {
                userScores: scores,
                hasData: true
            };
        }

        function updateRadarChart() {
            const canvas = document.getElementById('radarChart');
            const radarData = calculateRadarScores();

            // Calculate average score to determine overall performance color
            const avgScore = radarData.userScores.reduce((a, b) => a + b, 0) / radarData.userScores.length;

            // Determine color based on performance level
            let performanceColor, performanceColorRGBA, performanceLabel;
            if (avgScore >= 75) {
                performanceColor = '#22c55e'; // Green - Excellent
                performanceColorRGBA = 'rgba(34,197,94,0.3)';
                performanceLabel = 'Excellent';
            } else if (avgScore >= 50) {
                performanceColor = '#3b82f6'; // Blue - Good
                performanceColorRGBA = 'rgba(59,130,246,0.3)';
                performanceLabel = 'Good';
            } else if (avgScore >= 25) {
                performanceColor = '#f59e0b'; // Orange - Fair
                performanceColorRGBA = 'rgba(245,158,11,0.3)';
                performanceLabel = 'Fair';
            } else {
                performanceColor = '#ef4444'; // Red - Poor
                performanceColorRGBA = 'rgba(239,68,68,0.3)';
                performanceLabel = 'Needs Attention';
            }

            if (charts.radar) {
                charts.radar.data.datasets[0].data = radarData.userScores;
                charts.radar.data.datasets[0].backgroundColor = performanceColorRGBA;
                charts.radar.data.datasets[0].borderColor = performanceColor;
                charts.radar.data.datasets[0].label = `Your Performance (${performanceLabel})`;
                charts.radar.update('none');
            } else {
                charts.radar = new Chart(canvas, {
                    type: 'radar',
                    data: {
                        labels: ['VO2 Max', 'HR Recovery', 'Resting HR', 'HRV (SDNN)', 'Exercise Capacity', 'Recovery Speed'],
                        datasets: [{
                            label: `Your Performance (${performanceLabel})`,
                            data: radarData.userScores,
                            backgroundColor: performanceColorRGBA,
                            borderColor: performanceColor,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: performanceColor,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }, {
                            label: 'Population Average',
                            data: [50, 50, 50, 50, 50, 50],
                            backgroundColor: 'rgba(156,163,175,0.15)',
                            borderColor: '#9ca3af',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 3,
                            pointBackgroundColor: '#9ca3af'
                        }]
                    },
                    options: {
                        ...getChartOptions(),
                        scales: {
                            r: {
                                min: 0,
                                max: 100,
                                ticks: {
                                    color: '#9ca3af',
                                    backdropColor: 'transparent',
                                    stepSize: 25,
                                    callback: function(value) {
                                        if (value === 0) return '0';
                                        if (value === 25) return '25 (Poor)';
                                        if (value === 50) return '50 (Fair)';
                                        if (value === 75) return '75 (Good)';
                                        if (value === 100) return '100 (Excellent)';
                                        return value;
                                    }
                                },
                                grid: {
                                    color: function(context) {
                                        // Color code the grid rings
                                        const value = context.tick.value;
                                        if (value === 25) return 'rgba(239,68,68,0.3)'; // Red ring
                                        if (value === 50) return 'rgba(245,158,11,0.3)'; // Orange ring
                                        if (value === 75) return 'rgba(59,130,246,0.3)'; // Blue ring
                                        if (value === 100) return 'rgba(34,197,94,0.3)'; // Green ring
                                        return 'rgba(96,165,250,0.1)';
                                    }
                                },
                                pointLabels: {
                                    color: '#e5e7eb',
                                    font: { weight: 'bold', size: 12 }
                                }
                            }
                        }
                    }
                });
            }
        }

        // CALCULATE RISK STRATIFICATION FROM ACTUAL METRICS (5-LEVEL SYSTEM)
        function calculateRiskByDate() {
            const dates = Object.keys(allData).sort();
            const riskLevels = [];

            if (dates.length === 0) {
                return { dates: [], riskLevels: [] };
            }

            dates.forEach(dateStr => {
                const entry = allData[dateStr];
                let riskScore = 0;
                let hasRelevantData = false;

                // VO2 Max risk factor (most important)
                if (entry.vo2Max !== undefined) {
                    hasRelevantData = true;
                    if (entry.vo2Max < 12) riskScore += 4;
                    else if (entry.vo2Max < 16) riskScore += 3;
                    else if (entry.vo2Max < 20) riskScore += 2;
                    else if (entry.vo2Max < 24) riskScore += 1;
                    // else 0 (excellent)
                }

                // HR Recovery risk factor
                if (entry.hrRecovery !== undefined) {
                    hasRelevantData = true;
                    if (entry.hrRecovery < 10) riskScore += 4;
                    else if (entry.hrRecovery < 14) riskScore += 3;
                    else if (entry.hrRecovery < 18) riskScore += 2;
                    else if (entry.hrRecovery < 22) riskScore += 1;
                }

                // Ejection Fraction risk factor (critical)
                if (entry.ejectionFraction !== undefined) {
                    hasRelevantData = true;
                    if (entry.ejectionFraction < 30) riskScore += 5; // Severe
                    else if (entry.ejectionFraction < 35) riskScore += 4;
                    else if (entry.ejectionFraction < 40) riskScore += 3;
                    else if (entry.ejectionFraction < 50) riskScore += 2;
                    else if (entry.ejectionFraction < 55) riskScore += 1;
                }

                // Resting HR risk factor
                if (entry.restingHR !== undefined) {
                    hasRelevantData = true;
                    if (entry.restingHR > 100) riskScore += 4;
                    else if (entry.restingHR > 90) riskScore += 3;
                    else if (entry.restingHR > 80) riskScore += 2;
                    else if (entry.restingHR > 70) riskScore += 1;
                }

                // 6-Minute Walk Distance risk factor
                if (entry.walkDistance !== undefined) {
                    hasRelevantData = true;
                    if (entry.walkDistance < 250) riskScore += 4;
                    else if (entry.walkDistance < 350) riskScore += 3;
                    else if (entry.walkDistance < 400) riskScore += 2;
                    else if (entry.walkDistance < 450) riskScore += 1;
                }

                // Symptom risk factors
                if (entry.chestPain !== undefined && entry.chestPain > 5) {
                    riskScore += 3;
                    hasRelevantData = true;
                } else if (entry.chestPain !== undefined && entry.chestPain > 3) {
                    riskScore += 2;
                    hasRelevantData = true;
                }

                if (entry.dyspnea !== undefined && entry.dyspnea > 6) {
                    riskScore += 3;
                    hasRelevantData = true;
                } else if (entry.dyspnea !== undefined && entry.dyspnea > 4) {
                    riskScore += 2;
                    hasRelevantData = true;
                }

                if (!hasRelevantData) {
                    riskLevels.push(null);
                    return;
                }

                // Determine risk level: 1=Low, 2=Below Average, 3=Average, 4=Above Average, 5=High
                if (riskScore >= 10) riskLevels.push(5); // High
                else if (riskScore >= 7) riskLevels.push(4); // Above Average
                else if (riskScore >= 4) riskLevels.push(3); // Average
                else if (riskScore >= 2) riskLevels.push(2); // Below Average
                else riskLevels.push(1); // Low
            });

            return { dates, riskLevels };
        }

        function updateRiskChart() {
            const canvas = document.getElementById('riskChart');
            if (!canvas) return;

            const riskData = calculateRiskByDate();

            if (riskData.dates.length === 0) {
                if (!charts.risk) {
                    charts.risk = new Chart(canvas, {
                        type: 'bar',
                        data: { labels: [], datasets: [] },
                        options: getRiskChartOptions()
                    });
                }
                return;
            }

            // Calculate date range with 3-month padding
            const firstDate = new Date(riskData.dates[0]);
            const lastDate = new Date(riskData.dates[riskData.dates.length - 1]);

            const startDate = new Date(firstDate);
            startDate.setMonth(startDate.getMonth() - 3);

            const endDate = new Date(lastDate);
            endDate.setMonth(endDate.getMonth() + 3);

            // Combine padding dates (weekly intervals) with actual data dates
            const allDates = [];
            const allRiskValues = [];

            // Add weekly padding BEFORE first data point
            let currentDate = new Date(startDate);
            while (currentDate < firstDate) {
                allDates.push(new Date(currentDate));
                allRiskValues.push(null); // No data in padding
                currentDate.setDate(currentDate.getDate() + 7);
            }

            // Add ALL actual data points
            for (let i = 0; i < riskData.dates.length; i++) {
                allDates.push(new Date(riskData.dates[i]));
                allRiskValues.push(riskData.riskLevels[i]);
            }

            // Add weekly padding AFTER last data point
            currentDate = new Date(lastDate);
            currentDate.setDate(currentDate.getDate() + 7); // Start one week after last data
            while (currentDate <= endDate) {
                allDates.push(new Date(currentDate));
                allRiskValues.push(null); // No data in padding
                currentDate.setDate(currentDate.getDate() + 7);
            }

            // Sort by date (should already be sorted, but ensure it)
            const sortedIndices = allDates.map((date, idx) => idx).sort((a, b) => allDates[a] - allDates[b]);
            const sortedDates = sortedIndices.map(idx => allDates[idx]);
            const sortedRiskValues = sortedIndices.map(idx => allRiskValues[idx]);

            // Format labels for display
            const displayLabels = sortedDates.map(date => {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
            });

            // Create color array for each bar based on risk level
            const barColors = sortedRiskValues.map(risk => {
                if (risk === null) return 'rgba(156,163,175,0.15)'; // Light gray for no data
                if (risk === 5) return '#ef4444'; // High - Red
                if (risk === 4) return '#f97316'; // Above Average - Dark Orange
                if (risk === 3) return '#f59e0b'; // Average - Orange
                if (risk === 2) return '#84cc16'; // Below Average - Lime Green
                return '#22c55e'; // Low - Green
            });

            if (charts.risk) {
                charts.risk.data.labels = displayLabels;
                charts.risk.data.datasets[0].data = sortedRiskValues;
                charts.risk.data.datasets[0].backgroundColor = barColors;
                charts.risk.data.datasets[0].borderColor = barColors;
                charts.risk.update('none');
            } else {
                charts.risk = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: displayLabels,
                        datasets: [{
                            label: 'Cardiovascular Risk Level',
                            data: sortedRiskValues,
                            backgroundColor: barColors,
                            borderColor: barColors,
                            borderWidth: 1,
                            barThickness: 'flex',
                            maxBarThickness: 30
                        }]
                    },
                    options: getRiskChartOptions()
                });
            }
        }

        function getRiskChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                if (value === null) return 'No Data';
                                const labels = ['', 'Low Risk', 'Below Average Risk', 'Average Risk', 'Above Average Risk', 'High Risk'];
                                return labels[value] || 'Unknown';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 6,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                const labels = ['', 'Low', 'Below Avg', 'Average', 'Above Avg', 'High', ''];
                                return labels[value] || '';
                            },
                            color: '#9ca3af',
                            font: { weight: 'bold', size: 11 }
                        },
                        grid: {
                            color: function(context) {
                                const value = context.tick.value;
                                if (value === 1) return 'rgba(34,197,94,0.2)'; // Low
                                if (value === 2) return 'rgba(132,204,22,0.2)'; // Below Average
                                if (value === 3) return 'rgba(245,158,11,0.2)'; // Average
                                if (value === 4) return 'rgba(249,115,22,0.2)'; // Above Average
                                if (value === 5) return 'rgba(239,68,68,0.2)'; // High
                                return 'rgba(96,165,250,0.1)';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Risk Level',
                            color: '#e5e7eb',
                            font: { weight: 'bold', size: 13 }
                        }
                    },
                    x: {
                        ticks: {
                            color: '#9ca3af',
                            font: { weight: 'bold', size: 10 },
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(96,165,250,0.05)' },
                        title: {
                            display: true,
                            text: 'Date',
                            color: '#e5e7eb',
                            font: { weight: 'bold', size: 13 }
                        }
                    }
                }
            };
        }

        // ================================================================
        // RECOVERY PROGRESS CHART - ALL METRICS WITH DATE-BASED X-AXIS
        // ================================================================

        function updateRecoveryProgressChart() {
            const canvas = document.getElementById('recoveryProgressChart');
            if (!canvas) return;

            const sortedDates = Object.keys(allData).sort();

            // If no data, show empty chart
            if (sortedDates.length === 0) {
                if (!charts.recoveryProgress) {
                    charts.recoveryProgress = new Chart(canvas, {
                        type: 'line',
                        data: { labels: [], datasets: [] },
                        options: getRecoveryProgressChartOptions()
                    });
                }
                return;
            }

            // Calculate date range with 3-month padding
            const firstDate = new Date(sortedDates[0]);
            const lastDate = new Date(sortedDates[sortedDates.length - 1]);

            const startDate = new Date(firstDate);
            startDate.setMonth(startDate.getMonth() - 3);

            const endDate = new Date(lastDate);
            endDate.setMonth(endDate.getMonth() + 3);

            // Generate all dates in range (weekly intervals for reasonable display)
            const allLabels = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                allLabels.push(new Date(currentDate).toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 7); // Weekly intervals
            }

            // Create data maps for each metric
            const metricsData = {
                vo2Max: {},
                restingHR: {},
                bpSystolic: {},
                bpDiastolic: {},
                maxHR: {},
                hrRecovery: {},
                sdnn: {},
                rmssd: {},
                pnn50: {},
                walkDistance: {},
                mets: {},
                ejectionFraction: {},
                oxygenSat: {},
                respRate: {},
                weight: {},
                dyspnea: {},
                chestPain: {},
                fatigue: {},
                edema: {},
                qualityOfLife: {},
                sleepQuality: {}
            };

            // Populate data from actual entries
            sortedDates.forEach(date => {
                const entry = allData[date];
                if (entry.vo2Max !== undefined) metricsData.vo2Max[date] = entry.vo2Max;
                if (entry.restingHR !== undefined) metricsData.restingHR[date] = entry.restingHR;
                if (entry.bpSystolic !== undefined) metricsData.bpSystolic[date] = entry.bpSystolic;
                if (entry.bpDiastolic !== undefined) metricsData.bpDiastolic[date] = entry.bpDiastolic;
                if (entry.maxHR !== undefined) metricsData.maxHR[date] = entry.maxHR;
                if (entry.hrRecovery !== undefined) metricsData.hrRecovery[date] = entry.hrRecovery;
                if (entry.sdnn !== undefined) metricsData.sdnn[date] = entry.sdnn;
                if (entry.rmssd !== undefined) metricsData.rmssd[date] = entry.rmssd;
                if (entry.pnn50 !== undefined) metricsData.pnn50[date] = entry.pnn50;
                if (entry.walkDistance !== undefined) metricsData.walkDistance[date] = entry.walkDistance;
                if (entry.mets !== undefined) metricsData.mets[date] = entry.mets;
                if (entry.ejectionFraction !== undefined) metricsData.ejectionFraction[date] = entry.ejectionFraction;
                if (entry.oxygenSat !== undefined) metricsData.oxygenSat[date] = entry.oxygenSat;
                if (entry.respRate !== undefined) metricsData.respRate[date] = entry.respRate;
                if (entry.weight !== undefined) metricsData.weight[date] = entry.weight;
                if (entry.dyspnea !== undefined) metricsData.dyspnea[date] = entry.dyspnea;
                if (entry.chestPain !== undefined) metricsData.chestPain[date] = entry.chestPain;
                if (entry.fatigue !== undefined) metricsData.fatigue[date] = entry.fatigue;
                if (entry.edema !== undefined) metricsData.edema[date] = entry.edema;
                if (entry.qualityOfLife !== undefined) metricsData.qualityOfLife[date] = entry.qualityOfLife;
                if (entry.sleepQuality !== undefined) metricsData.sleepQuality[date] = entry.sleepQuality;
            });

            // Map data to chart labels
            const mapDataToLabels = (dataMap) => {
                return allLabels.map(label => {
                    // Find closest actual data point within 7 days
                    if (dataMap[label] !== undefined) return dataMap[label];

                    const labelDate = new Date(label);
                    for (let i = 0; i <= 7; i++) {
                        const checkDate = new Date(labelDate);
                        checkDate.setDate(checkDate.getDate() - i);
                        const checkDateStr = checkDate.toISOString().split('T')[0];
                        if (dataMap[checkDateStr] !== undefined) return dataMap[checkDateStr];
                    }
                    return null;
                });
            };

            // Create datasets with all metrics
            const datasets = [
                {
                    label: 'VO2 Max',
                    data: mapDataToLabels(metricsData.vo2Max),
                    borderColor: '#60a5fa',
                    backgroundColor: 'rgba(96,165,250,0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                    hidden: false
                },
                {
                    label: 'Resting HR',
                    data: mapDataToLabels(metricsData.restingHR),
                    borderColor: '#ef4444',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'BP Systolic',
                    data: mapDataToLabels(metricsData.bpSystolic),
                    borderColor: '#f59e0b',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'BP Diastolic',
                    data: mapDataToLabels(metricsData.bpDiastolic),
                    borderColor: '#fb923c',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Max HR',
                    data: mapDataToLabels(metricsData.maxHR),
                    borderColor: '#ec4899',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'HR Recovery',
                    data: mapDataToLabels(metricsData.hrRecovery),
                    borderColor: '#8b5cf6',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'SDNN (HRV)',
                    data: mapDataToLabels(metricsData.sdnn),
                    borderColor: '#06b6d4',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'RMSSD (HRV)',
                    data: mapDataToLabels(metricsData.rmssd),
                    borderColor: '#14b8a6',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'pNN50',
                    data: mapDataToLabels(metricsData.pnn50),
                    borderColor: '#84cc16',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: '6-Min Walk (m)',
                    data: mapDataToLabels(metricsData.walkDistance),
                    borderColor: '#22c55e',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'METs',
                    data: mapDataToLabels(metricsData.mets),
                    borderColor: '#10b981',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Ejection Fraction',
                    data: mapDataToLabels(metricsData.ejectionFraction),
                    borderColor: '#f97316',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Oxygen Saturation',
                    data: mapDataToLabels(metricsData.oxygenSat),
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Respiratory Rate',
                    data: mapDataToLabels(metricsData.respRate),
                    borderColor: '#0ea5e9',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Weight (kg)',
                    data: mapDataToLabels(metricsData.weight),
                    borderColor: '#6366f1',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Dyspnea Score',
                    data: mapDataToLabels(metricsData.dyspnea),
                    borderColor: '#d946ef',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Chest Pain',
                    data: mapDataToLabels(metricsData.chestPain),
                    borderColor: '#dc2626',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Fatigue',
                    data: mapDataToLabels(metricsData.fatigue),
                    borderColor: '#ca8a04',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Edema',
                    data: mapDataToLabels(metricsData.edema),
                    borderColor: '#0891b2',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Quality of Life',
                    data: mapDataToLabels(metricsData.qualityOfLife),
                    borderColor: '#16a34a',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                },
                {
                    label: 'Sleep Quality',
                    data: mapDataToLabels(metricsData.sleepQuality),
                    borderColor: '#4f46e5',
                    borderWidth: 2,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    hidden: false
                }
            ];

            // Format labels for display
            const displayLabels = allLabels.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
            });

            if (charts.recoveryProgress) {
                charts.recoveryProgress.data.labels = displayLabels;
                charts.recoveryProgress.data.datasets = datasets;
                charts.recoveryProgress.update('none');
            } else {
                charts.recoveryProgress = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: displayLabels,
                        datasets: datasets
                    },
                    options: getRecoveryProgressChartOptions()
                });
            }
        }

        function getRecoveryProgressChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 12,
                            font: {
                                size: 13,
                                weight: 'bold'  // Bold legend text
                            },
                            color: '#e5e7eb',
                            boxWidth: 15,
                            boxHeight: 15
                        },
                        onClick: function(e, legendItem, legend) {
                            // Custom legend click behavior
                            const index = legendItem.datasetIndex;
                            const chart = legend.chart;
                            const clickedDataset = chart.data.datasets[index];

                            // Check how many datasets are currently visible
                            const visibleCount = chart.data.datasets.filter(ds => !ds.hidden).length;

                            // If only one is visible and it's the one being clicked, show all
                            if (visibleCount === 1 && !clickedDataset.hidden) {
                                chart.data.datasets.forEach(dataset => {
                                    dataset.hidden = false;
                                });
                            } else {
                                // Hide all others, show only this one
                                chart.data.datasets.forEach((dataset, i) => {
                                    dataset.hidden = (i !== index);
                                });
                            }

                            chart.update();
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            color: '#9ca3af',
                            font: { weight: 'bold' }
                        },
                        grid: { color: 'rgba(96,165,250,0.1)' },
                        title: {
                            display: true,
                            text: 'Measurement Value',
                            color: '#e5e7eb',
                            font: { weight: 'bold', size: 14 }
                        }
                    },
                    x: {
                        ticks: {
                            color: '#9ca3af',
                            font: { weight: 'bold' },
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(96,165,250,0.1)' },
                        title: {
                            display: true,
                            text: 'Date',
                            color: '#e5e7eb',
                            font: { weight: 'bold', size: 14 }
                        }
                    }
                }
            };
        }

        function toggleAllMetrics() {
            const chart = charts.recoveryProgress;
            if (!chart) return;

            // Check if all are visible
            const allVisible = chart.data.datasets.every(ds => !ds.hidden);

            if (allVisible) {
                // If all visible, keep all visible (do nothing)
                return;
            } else {
                // Show all
                chart.data.datasets.forEach(dataset => {
                    dataset.hidden = false;
                });
                chart.update();
            }
        }

        function getChartOptions() {
            return {
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: '#e5e7eb',
                            font: { size: 14, weight: 'bold' }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: { color: '#9ca3af', font: { weight: 'bold' } },
                        grid: { color: 'rgba(96,165,250,0.1)' }
                    },
                    x: {
                        ticks: { color: '#9ca3af', font: { weight: 'bold' } },
                        grid: { color: 'rgba(96,165,250,0.1)' }
                    }
                }
            };
        }

        // TABS
        function switchTab(tabId) {
            // Update tab panel visibility
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });

            const activePanel = document.getElementById(tabId);
            if (activePanel) {
                activePanel.style.display = 'block';
                activePanel.classList.add('active');
            }

            // Update tab button states and ARIA attributes
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });

            // Set active tab button and ARIA
            const activeBtn = document.getElementById('tab-' + tabId);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.setAttribute('aria-selected', 'true');
            }

            // Update bottom nav for mobile
            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
            bottomNavItems.forEach(item => item.classList.remove('active'));
            const activeBottomNav = document.getElementById('bottomNav-' + tabId);
            if (activeBottomNav) {
                activeBottomNav.classList.add('active');
            }

            // Smooth scroll to top
            if (window.pageYOffset > 0) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Update charts if needed
            if (tabId === 'dashboard' || tabId === 'analytics') {
                setTimeout(() => {
                    updateCharts();
                    updatePopulationComparison();
                }, 100);
            }
        }

        // NOTIFICATIONS
        function showNotification(message, type) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type} show`;
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        // ============================================================================
        // HEART RATE MONITOR - REAL BLUETOOTH CONNECTIVITY
        // ============================================================================

        // Bluetooth device state
        let connectedDevice = null;
        let deviceType = null; // 'polar' or 'samsung'
        let hrCharacteristic = null;
        let batteryCharacteristic = null;
        let hrMonitorActive = false;
        let hrData = [];
        let hrLabels = [];
        let hrStartTime = null;
        let hrChart = null;
        let rrIntervals = []; // For HRV calculation
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 3;

        // Standard Bluetooth UUIDs
        const HEART_RATE_SERVICE = 0x180D;
        const HEART_RATE_MEASUREMENT = 0x2A37;
        const BATTERY_SERVICE = 0x180F;
        const BATTERY_LEVEL = 0x2A19;

        // ============================================================================
        // POLAR H10 CONNECTION
        // ============================================================================
        async function connectPolarH10() {
            try {
                if (!navigator.bluetooth) {
                    showNotification('❌ Web Bluetooth is not supported in this browser. Please use Chrome, Edge, or Opera.', 'error');
                    return;
                }

                showNotification('🔍 Searching for Polar H10...', 'info');

                // Request Polar H10 device
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'Polar H10' },
                        { services: [HEART_RATE_SERVICE] }
                    ],
                    optionalServices: [BATTERY_SERVICE]
                });

                device.addEventListener('gattserverdisconnected', onDisconnected);

                showNotification('🔗 Connecting to ' + device.name + '...', 'info');

                const server = await device.gatt.connect();
                const hrService = await server.getPrimaryService(HEART_RATE_SERVICE);
                hrCharacteristic = await hrService.getCharacteristic(HEART_RATE_MEASUREMENT);

                // Try to get battery service
                try {
                    const batteryService = await server.getPrimaryService(BATTERY_SERVICE);
                    batteryCharacteristic = await batteryService.getCharacteristic(BATTERY_LEVEL);
                    const batteryValue = await batteryCharacteristic.readValue();
                    const batteryLevel = batteryValue.getUint8(0);
                    document.getElementById('deviceBattery').textContent = batteryLevel;
                } catch (e) {
                    console.log('Battery service not available:', e);
                    document.getElementById('deviceBattery').textContent = '--';
                }

                // Save connection
                connectedDevice = device;
                deviceType = 'polar';

                // Update UI
                document.getElementById('polarStatus').innerHTML = '🟢 Connected';
                document.getElementById('polarStatus').style.color = '#22c55e';
                document.getElementById('polarConnectBtn').textContent = 'Connected ✓';
                document.getElementById('polarConnectBtn').disabled = true;
                document.getElementById('connectedDeviceName').textContent = device.name;
                document.getElementById('deviceInfo').style.display = 'block';
                document.getElementById('hrStatus').textContent = 'Device ready - press Start';
                document.getElementById('hrStatus').style.color = '#22c55e';
                document.getElementById('startHRBtn').disabled = false;
                document.getElementById('startHRBtn').style.opacity = '1';

                showNotification('✅ Connected to ' + device.name, 'success');

            } catch (error) {
                console.error('Polar H10 connection error:', error);
                showNotification('❌ Connection failed: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // SAMSUNG WATCH CONNECTION
        // ============================================================================
        async function connectSamsungWatch() {
            try {
                if (!navigator.bluetooth) {
                    showNotification('❌ Web Bluetooth is not supported in this browser. Please use Chrome, Edge, or Opera.', 'error');
                    return;
                }

                showNotification('🔍 Searching for Samsung Galaxy Watch...', 'info');

                // Request Samsung Watch - they use standard Heart Rate Service
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'Galaxy Watch' },
                        { namePrefix: 'SM-' }, // Samsung model numbers
                        { services: [HEART_RATE_SERVICE] }
                    ],
                    optionalServices: [BATTERY_SERVICE]
                });

                device.addEventListener('gattserverdisconnected', onDisconnected);

                showNotification('🔗 Connecting to ' + device.name + '...', 'info');

                const server = await device.gatt.connect();
                const hrService = await server.getPrimaryService(HEART_RATE_SERVICE);
                hrCharacteristic = await hrService.getCharacteristic(HEART_RATE_MEASUREMENT);

                // Try to get battery service
                try {
                    const batteryService = await server.getPrimaryService(BATTERY_SERVICE);
                    batteryCharacteristic = await batteryService.getCharacteristic(BATTERY_LEVEL);
                    const batteryValue = await batteryCharacteristic.readValue();
                    const batteryLevel = batteryValue.getUint8(0);
                    document.getElementById('deviceBattery').textContent = batteryLevel;
                } catch (e) {
                    console.log('Battery service not available:', e);
                    document.getElementById('deviceBattery').textContent = '--';
                }

                // Save connection
                connectedDevice = device;
                deviceType = 'samsung';

                // Update UI
                document.getElementById('samsungStatus').innerHTML = '🟢 Connected';
                document.getElementById('samsungStatus').style.color = '#22c55e';
                document.getElementById('samsungConnectBtn').textContent = 'Connected ✓';
                document.getElementById('samsungConnectBtn').disabled = true;
                document.getElementById('connectedDeviceName').textContent = device.name;
                document.getElementById('deviceInfo').style.display = 'block';
                document.getElementById('hrStatus').textContent = 'Device ready - press Start';
                document.getElementById('hrStatus').style.color = '#22c55e';
                document.getElementById('startHRBtn').disabled = false;
                document.getElementById('startHRBtn').style.opacity = '1';

                // Show ECG section for Samsung Watch
                document.getElementById('ecgSection').style.display = 'block';

                showNotification('✅ Connected to ' + device.name, 'success');

            } catch (error) {
                console.error('Samsung Watch connection error:', error);
                showNotification('❌ Connection failed: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // DISCONNECT DEVICE
        // ============================================================================
        function disconnectDevice() {
            if (hrMonitorActive) {
                stopHRMonitoring();
            }

            if (connectedDevice && connectedDevice.gatt.connected) {
                connectedDevice.gatt.disconnect();
            }

            connectedDevice = null;
            deviceType = null;
            hrCharacteristic = null;
            batteryCharacteristic = null;

            // Reset UI
            document.getElementById('polarStatus').innerHTML = '🔴 Not Connected';
            document.getElementById('polarStatus').style.color = '#6b7280';
            document.getElementById('polarConnectBtn').textContent = 'Connect Polar H10';
            document.getElementById('polarConnectBtn').disabled = false;

            document.getElementById('samsungStatus').innerHTML = '🔴 Not Connected';
            document.getElementById('samsungStatus').style.color = '#6b7280';
            document.getElementById('samsungConnectBtn').textContent = 'Connect Samsung Watch';
            document.getElementById('samsungConnectBtn').disabled = false;

            document.getElementById('deviceInfo').style.display = 'none';
            document.getElementById('hrStatus').textContent = 'No sensor connected';
            document.getElementById('hrStatus').style.color = '#6b7280';
            document.getElementById('currentHR').textContent = '--';
            document.getElementById('startHRBtn').disabled = true;
            document.getElementById('startHRBtn').style.opacity = '0.5';
            document.getElementById('ecgSection').style.display = 'none';

            showNotification('🔌 Device disconnected', 'info');
        }

        // ============================================================================
        // HANDLE DISCONNECTION
        // ============================================================================
        function onDisconnected(event) {
            const device = event.target;
            console.log('Device disconnected:', device.name);

            showNotification('⚠️ Device disconnected. Attempting to reconnect...', 'error');

            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                setTimeout(() => {
                    if (deviceType === 'polar') {
                        connectPolarH10();
                    } else if (deviceType === 'samsung') {
                        connectSamsungWatch();
                    }
                }, 2000);
            } else {
                disconnectDevice();
                showNotification('❌ Could not reconnect. Please connect manually.', 'error');
                reconnectAttempts = 0;
            }
        }

        // ============================================================================
        // START/STOP MONITORING
        // ============================================================================
        async function startHRMonitoring() {
            if (!hrCharacteristic) {
                showNotification('❌ No device connected', 'error');
                return;
            }

            try {
                hrMonitorActive = true;
                hrData = [];
                hrLabels = [];
                rrIntervals = [];
                hrStartTime = Date.now();

                // Start notifications
                await hrCharacteristic.startNotifications();
                hrCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateChanged);

                // Update UI
                document.getElementById('hrStatus').textContent = 'Monitoring active...';
                document.getElementById('hrStatus').style.color = '#22c55e';
                document.getElementById('startHRBtn').disabled = true;
                document.getElementById('startHRBtn').style.opacity = '0.5';
                document.getElementById('stopHRBtn').disabled = false;
                document.getElementById('stopHRBtn').style.opacity = '1';

                // Show override section
                document.getElementById('overrideSection').style.display = 'block';
                const deviceName = connectedDevice?.name || 'Device';
                document.getElementById('overrideSessionInfo').textContent = `${deviceName} - Active`;

                // Initialize chart
                initHRChart();

                showNotification('❤️ Heart rate monitoring started', 'success');

            } catch (error) {
                console.error('Start monitoring error:', error);
                showNotification('❌ Failed to start monitoring: ' + error.message, 'error');
            }
        }

        async function stopHRMonitoring() {
            if (!hrCharacteristic) return;

            try {
                hrMonitorActive = false;
                await hrCharacteristic.stopNotifications();
                hrCharacteristic.removeEventListener('characteristicvaluechanged', handleHeartRateChanged);

                // Update UI
                document.getElementById('hrStatus').textContent = 'Monitoring stopped';
                document.getElementById('hrStatus').style.color = '#f59e0b';
                document.getElementById('startHRBtn').disabled = false;
                document.getElementById('startHRBtn').style.opacity = '1';
                document.getElementById('stopHRBtn').disabled = true;
                document.getElementById('stopHRBtn').style.opacity = '0.5';

                showNotification('⏹️ Heart rate monitoring stopped', 'info');

                // Save session data to localStorage
                saveHRSession();

            } catch (error) {
                console.error('Stop monitoring error:', error);
            }
        }

        // ============================================================================
        // PARSE HEART RATE DATA
        // ============================================================================
        function handleHeartRateChanged(event) {
            const value = event.target.value;
            const flags = value.getUint8(0);
            const rate16Bits = flags & 0x1;
            let heartRate;

            if (rate16Bits) {
                heartRate = value.getUint16(1, true);
            } else {
                heartRate = value.getUint8(1);
            }

            // Check for RR intervals (for HRV calculation)
            if (flags & 0x10) {
                // RR intervals present
                let index = rate16Bits ? 3 : 2;
                while (index < value.byteLength) {
                    const rrInterval = value.getUint16(index, true);
                    rrIntervals.push(rrInterval);
                    index += 2;
                }

                // Calculate HRV from RR intervals
                if (rrIntervals.length >= 10) {
                    const hrv = calculateHRV(rrIntervals);
                    if (deviceType === 'samsung') {
                        document.getElementById('ecgHRV').textContent = Math.round(hrv);

                        // Calculate average RR interval
                        const avgRR = rrIntervals.reduce((a, b) => a + b, 0) / rrIntervals.length;
                        document.getElementById('ecgRR').textContent = Math.round(avgRR);
                    }
                }
            }

            // Add to data
            const elapsedSeconds = Math.floor((Date.now() - hrStartTime) / 1000);
            hrData.push(heartRate);
            hrLabels.push(elapsedSeconds + 's');

            // Keep only last 120 readings (2 minutes)
            if (hrData.length > 120) {
                hrData.shift();
                hrLabels.shift();
            }

            // Update display
            document.getElementById('currentHR').textContent = heartRate;
            updateHRChart();
            updateHRStatistics();

            // Update ECG rhythm detection for Samsung Watch
            if (deviceType === 'samsung') {
                detectRhythm(heartRate);
            }
        }

        // Calculate HRV (SDNN method)
        function calculateHRV(intervals) {
            if (intervals.length < 2) return 0;

            const mean = intervals.reduce((a, b) => a + b, 0) / intervals.length;
            const squaredDiffs = intervals.map(val => Math.pow(val - mean, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / intervals.length;
            return Math.sqrt(variance);
        }

        // Simple rhythm detection
        function detectRhythm(currentHR) {
            if (hrData.length < 10) {
                document.getElementById('ecgRhythm').textContent = 'Analyzing...';
                return;
            }

            // Calculate variability in last 10 readings
            const recent = hrData.slice(-10);
            const avg = recent.reduce((a, b) => a + b, 0) / recent.length;
            const variance = recent.map(hr => Math.abs(hr - avg)).reduce((a, b) => a + b, 0) / recent.length;

            if (variance > 10) {
                document.getElementById('ecgRhythm').textContent = 'Irregular';
                document.getElementById('ecgRhythm').style.color = '#ef4444';
            } else if (avg > 100) {
                document.getElementById('ecgRhythm').textContent = 'Tachycardia';
                document.getElementById('ecgRhythm').style.color = '#f59e0b';
            } else if (avg < 60) {
                document.getElementById('ecgRhythm').textContent = 'Bradycardia';
                document.getElementById('ecgRhythm').style.color = '#3b82f6';
            } else {
                document.getElementById('ecgRhythm').textContent = 'Normal Sinus';
                document.getElementById('ecgRhythm').style.color = '#22c55e';
            }

            // Estimate QRS duration (simplified)
            document.getElementById('ecgQRS').textContent = '80-100';
        }

        // Save HR session to localStorage
        function saveHRSession() {
            if (hrData.length === 0) return;

            const session = {
                date: new Date().toISOString(),
                device: connectedDevice?.name || 'Unknown',
                deviceType: deviceType,
                duration: Math.floor((Date.now() - hrStartTime) / 1000),
                avgHR: Math.round(hrData.reduce((a, b) => a + b, 0) / hrData.length),
                minHR: Math.min(...hrData),
                maxHR: Math.max(...hrData),
                data: hrData.slice(),
                rrIntervals: rrIntervals.slice()
            };

            // Get existing sessions
            let sessions = JSON.parse(localStorage.getItem('hrSessions') || '[]');
            sessions.push(session);

            // Keep only last 50 sessions
            if (sessions.length > 50) {
                sessions = sessions.slice(-50);
            }

            localStorage.setItem('hrSessions', JSON.stringify(sessions));
        }

        // ============================================================================
        // OVERRIDE THERAPY DATA FROM MONITOR
        // ============================================================================
        function overrideTherapyData() {
            if (hrData.length === 0) {
                showNotification('❌ No monitoring data available. Please start monitoring first.', 'error');
                return;
            }

            const confirmation = confirm(
                '⚠️ OVERRIDE CONFIRMATION\n\n' +
                'This will replace the current Data Entry fields with data from your monitoring session.\n\n' +
                'The following metrics will be transferred:\n' +
                '• Resting HR (average from session)\n' +
                '• Maximum HR\n' +
                '• Heart Rate Recovery\n' +
                '• HRV metrics (SDNN, RMSSD, pNN50)\n' +
                (deviceType === 'samsung' ? '• SpO2, Resp Rate, VO2 Max estimate\n' : '') +
                '\n' +
                'Do you want to continue?'
            );

            if (!confirmation) {
                return;
            }

            try {
                // Calculate metrics from monitoring session
                const avgHR = Math.round(hrData.reduce((a, b) => a + b, 0) / hrData.length);
                const maxHR = Math.max(...hrData);
                const minHR = Math.min(...hrData);

                // Calculate HR Recovery (difference between max and last 5 readings average)
                const lastFive = hrData.slice(-5);
                const recoveryHR = Math.round(lastFive.reduce((a, b) => a + b, 0) / lastFive.length);
                const hrRecovery = maxHR - recoveryHR;

                // Calculate HRV metrics from RR intervals
                let sdnn = 0, rmssd = 0, pnn50 = 0;
                if (rrIntervals.length >= 10) {
                    // SDNN
                    sdnn = Math.round(calculateHRV(rrIntervals));

                    // RMSSD (root mean square of successive differences)
                    const differences = [];
                    for (let i = 1; i < rrIntervals.length; i++) {
                        differences.push(Math.pow(rrIntervals[i] - rrIntervals[i-1], 2));
                    }
                    rmssd = Math.round(Math.sqrt(differences.reduce((a, b) => a + b, 0) / differences.length));

                    // pNN50 (percentage of successive RR intervals that differ by more than 50ms)
                    let nn50count = 0;
                    for (let i = 1; i < rrIntervals.length; i++) {
                        if (Math.abs(rrIntervals[i] - rrIntervals[i-1]) > 50) {
                            nn50count++;
                        }
                    }
                    pnn50 = ((nn50count / (rrIntervals.length - 1)) * 100).toFixed(1);
                }

                // Populate data entry fields
                document.getElementById('restingHR').value = avgHR;
                document.getElementById('maxHR').value = maxHR;
                document.getElementById('hrRecovery').value = hrRecovery;
                document.getElementById('sdnn').value = sdnn || '';
                document.getElementById('rmssd').value = rmssd || '';
                document.getElementById('pnn50').value = pnn50 || '';

                // Samsung Watch specific metrics
                if (deviceType === 'samsung') {
                    // Get values from Samsung dashboard
                    const spo2Text = document.getElementById('watchSpO2').textContent;
                    const respRateText = document.getElementById('watchRespRate').textContent;
                    const vo2Text = document.getElementById('watchVO2').textContent;

                    // Parse and populate if available
                    if (spo2Text !== '-- %') {
                        const spo2 = parseInt(spo2Text);
                        if (!isNaN(spo2)) document.getElementById('spo2').value = spo2;
                    }

                    if (respRateText !== '-- bpm') {
                        const respRate = parseInt(respRateText);
                        if (!isNaN(respRate)) document.getElementById('respRate').value = respRate;
                    }

                    if (vo2Text !== '--') {
                        const vo2 = parseFloat(vo2Text);
                        if (!isNaN(vo2)) document.getElementById('vo2Max').value = vo2;
                    }

                    // Transfer Samsung Watch ECG fields
                    const rhythmText = document.getElementById('ecgRhythm').textContent;
                    const qrsText = document.getElementById('ecgQRS').textContent;
                    const rrText = document.getElementById('ecgRR').textContent;
                    const stressText = document.getElementById('watchStress').textContent;

                    if (rhythmText && rhythmText !== '--') {
                        document.getElementById('ecgRhythmInput').value = rhythmText;
                    }

                    if (qrsText && qrsText !== '-- ms') {
                        const qrs = parseInt(qrsText.replace(/\D/g, ''));
                        if (!isNaN(qrs)) document.getElementById('qrsDuration').value = qrs;
                    }

                    if (rrText && rrText !== '-- ms') {
                        const rr = parseInt(rrText);
                        if (!isNaN(rr)) document.getElementById('rrInterval').value = rr;
                    }

                    if (stressText && stressText !== '--') {
                        document.getElementById('stressLevel').value = stressText;
                    }

                    // Update ECG metrics in dashboard
                    document.getElementById('ecgRMSSD').textContent = rmssd || '--';
                    document.getElementById('ecgPNN50').textContent = pnn50 || '--';
                }

                // Switch to Data Entry tab
                switchTab('entry');

                showNotification('✅ Monitoring data successfully transferred to Data Entry!', 'success');

                // Add a visual highlight to the updated fields
                const updatedFields = ['restingHR', 'maxHR', 'hrRecovery', 'sdnn', 'rmssd', 'pnn50', 'spo2', 'respRate', 'ecgRhythmInput', 'qrsDuration', 'rrInterval', 'stressLevel'];
                updatedFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.value) {
                        field.style.background = 'rgba(34,197,94,0.1)';
                        field.style.border = '2px solid #22c55e';
                        setTimeout(() => {
                            field.style.background = '';
                            field.style.border = '';
                        }, 3000);
                    }
                });

            } catch (error) {
                console.error('Override therapy data error:', error);
                showNotification('❌ Error transferring data: ' + error.message, 'error');
            }
        }

        // Calculate additional Samsung Watch metrics (simulated based on HR data)
        function calculateSamsungWatchMetrics() {
            if (!hrMonitorActive || deviceType !== 'samsung' || hrData.length < 10) return;

            const avgHR = hrData.reduce((a, b) => a + b, 0) / hrData.length;
            const maxHR = Math.max(...hrData);

            // Estimate SpO2 (simulated - real device would provide actual reading)
            // Healthy adults typically 95-100%
            const estimatedSpO2 = Math.min(100, Math.max(90, Math.round(100 - (avgHR - 70) * 0.1)));
            document.getElementById('watchSpO2').textContent = estimatedSpO2;

            // Estimate Stress Level based on HR variability and average
            const recentHR = hrData.slice(-20);
            const hrVariance = recentHR.map((hr, i) => i > 0 ? Math.abs(hr - recentHR[i-1]) : 0).reduce((a, b) => a + b, 0) / recentHR.length;

            let stressLevel = 'Low';
            if (avgHR > 90 && hrVariance < 3) stressLevel = 'High';
            else if (avgHR > 80 || hrVariance < 5) stressLevel = 'Moderate';
            document.getElementById('watchStress').textContent = stressLevel;

            // Estimate Respiratory Rate (typically 12-20 breaths/min)
            // Simplified correlation with HR
            const estimatedRespRate = Math.round(12 + (avgHR - 60) * 0.1);
            document.getElementById('watchRespRate').textContent = Math.max(10, Math.min(25, estimatedRespRate));

            // Estimate VO2 Max based on age and HR (simplified formula)
            // Real device uses more sophisticated algorithms
            const estimatedVO2 = Math.round(15.3 * (maxHR / avgHR));
            document.getElementById('watchVO2').textContent = Math.max(20, Math.min(60, estimatedVO2));
        }

        function initHRChart() {
            const canvas = document.getElementById('hrMonitorChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Destroy existing chart if it exists
            if (hrChart) {
                hrChart.destroy();
            }

            hrChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Heart Rate (BPM)',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239,68,68,0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text').trim(),
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#ef4444',
                            borderWidth: 2
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text').trim(),
                                font: { size: 12, weight: 'bold' }
                            },
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()
                            },
                            grid: {
                                color: 'rgba(156,163,175,0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Heart Rate (BPM)',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text').trim(),
                                font: { size: 12, weight: 'bold' }
                            },
                            beginAtZero: false,
                            min: 40,
                            max: 180,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()
                            },
                            grid: {
                                color: 'rgba(156,163,175,0.1)'
                            }
                        }
                    },
                    animation: {
                        duration: 300
                    }
                }
            });
        }

        function updateHRChart() {
            if (!hrChart) return;

            hrChart.data.labels = hrLabels;
            hrChart.data.datasets[0].data = hrData;
            hrChart.update('none'); // Update without animation for smooth real-time updates
        }

        function updateHRStatistics() {
            if (hrData.length === 0) return;

            // Calculate statistics
            const avgHR = Math.round(hrData.reduce((a, b) => a + b, 0) / hrData.length);
            const minHR = Math.min(...hrData);
            const maxHR = Math.max(...hrData);
            const duration = Math.floor((Date.now() - hrStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;

            // Update statistics display
            document.getElementById('hrAverage').textContent = avgHR + ' bpm';
            document.getElementById('hrMin').textContent = minHR + ' bpm';
            document.getElementById('hrMax').textContent = maxHR + ' bpm';
            document.getElementById('hrDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Calculate zone percentages
            let restingCount = 0;
            let lightCount = 0;
            let moderateCount = 0;
            let highCount = 0;

            hrData.forEach(hr => {
                if (hr < 60) restingCount++;
                else if (hr < 100) lightCount++;
                else if (hr < 140) moderateCount++;
                else highCount++;
            });

            const total = hrData.length;
            document.getElementById('zoneResting').textContent = Math.round((restingCount / total) * 100) + '%';
            document.getElementById('zoneLight').textContent = Math.round((lightCount / total) * 100) + '%';
            document.getElementById('zoneModerate').textContent = Math.round((moderateCount / total) * 100) + '%';
            document.getElementById('zoneHigh').textContent = Math.round((highCount / total) * 100) + '%';

            // Calculate Samsung Watch specific metrics if connected
            if (deviceType === 'samsung') {
                calculateSamsungWatchMetrics();
            }
        }

        // Initialize
        init();
        setInterval(updateRecoveryInfo, 1000);

        // ========================================================================
        // PWA INSTALLATION & OFFLINE SUPPORT
        // ========================================================================

        let deferredPrompt;
        const installPromptEl = document.getElementById('installPrompt');

        // Service Worker Registration for Offline Support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Register inline service worker
                const swCode = `
                    const CACHE_NAME = 'cardiac-recovery-pro-v1';
                    const urlsToCache = [
                        './',
                        'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                                .catch(() => caches.match('./'))
                        );
                    });

                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('✅ Service Worker registered! Offline mode enabled.');
                    })
                    .catch(error => {
                        console.log('❌ Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Save the event for later use
            deferredPrompt = e;

            // Check if user has dismissed before
            const dismissed = localStorage.getItem('installPromptDismissed');
            if (!dismissed) {
                // Show install prompt after 3 seconds
                setTimeout(() => {
                    if (installPromptEl) {
                        installPromptEl.style.display = 'flex';
                    }
                }, 3000);
            }
        });

        function installApp() {
            if (!deferredPrompt) {
                alert('Install prompt not available. Try adding to home screen manually from your browser menu.');
                return;
            }

            // Show the install prompt
            deferredPrompt.prompt();

            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('✅ User accepted the install prompt');
                } else {
                    console.log('❌ User dismissed the install prompt');
                }
                deferredPrompt = null;
                if (installPromptEl) {
                    installPromptEl.style.display = 'none';
                }
            });
        }

        function dismissInstallPrompt() {
            if (installPromptEl) {
                installPromptEl.style.display = 'none';
            }
            // Remember dismissal for 7 days
            const dismissTime = new Date().getTime() + (7 * 24 * 60 * 60 * 1000);
            localStorage.setItem('installPromptDismissed', dismissTime);
        }

        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('✅ Cardiac Recovery Pro installed successfully!');
            if (installPromptEl) {
                installPromptEl.style.display = 'none';
            }
        });

        // Display mode detection
        window.addEventListener('DOMContentLoaded', () => {
            if (window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true) {
                console.log('✅ Running in standalone mode (installed PWA)');
            }
        });

        // ========================================================================
        // OFFLINE STATUS INDICATOR
        // ========================================================================

        function updateOnlineStatus() {
            const status = navigator.onLine ? 'online' : 'offline';
            if (!navigator.onLine) {
                // Show offline banner
                const offlineBanner = document.createElement('div');
                offlineBanner.id = 'offlineBanner';
                offlineBanner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #f59e0b;
                    color: white;
                    padding: 10px;
                    text-align: center;
                    font-weight: 700;
                    z-index: 10001;
                `;
                offlineBanner.textContent = '⚠️ You are offline - Data will sync when connection is restored';
                document.body.appendChild(offlineBanner);
            } else {
                // Remove offline banner if it exists
                const banner = document.getElementById('offlineBanner');
                if (banner) {
                    banner.remove();
                }
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // ========================================================================
        // THEME TOGGLE (DARK / LIGHT MODE)
        // ========================================================================

        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');

            body.classList.toggle('light-mode');

            if (body.classList.contains('light-mode')) {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light';
                localStorage.setItem('theme', 'light');
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Load saved theme preference
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeIcon').textContent = '☀️';
                document.getElementById('themeText').textContent = 'Light';
            }
        });

        // ========================================================================
        // STICKY HEADER ON SCROLL
        // ========================================================================

        let lastScrollTop = 0;
        const header = document.querySelector('.header');
        const scrollThreshold = 150;

        window.addEventListener('scroll', () => {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            if (scrollTop > scrollThreshold) {
                if (!header.classList.contains('sticky')) {
                    header.classList.add('sticky');
                    document.body.classList.add('sticky-header-active');
                }
            } else {
                if (header.classList.contains('sticky')) {
                    header.classList.remove('sticky');
                    document.body.classList.remove('sticky-header-active');
                }
            }

            lastScrollTop = scrollTop;
        });

        // ========================================================================
        // PULL-TO-REFRESH
        // ========================================================================

        let touchStartY = 0;
        let touchEndY = 0;
        const pullThreshold = 100;
        const pullToRefreshEl = document.getElementById('pullToRefresh');
        const refreshIcon = document.getElementById('refreshIcon');

        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            touchEndY = e.touches[0].clientY;
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            // Only activate pull-to-refresh at top of page
            if (scrollTop === 0 && touchEndY > touchStartY) {
                const pullDistance = touchEndY - touchStartY;

                if (pullDistance > 20 && pullDistance < pullThreshold) {
                    pullToRefreshEl.classList.add('pulling');
                    refreshIcon.textContent = '↓';
                } else if (pullDistance >= pullThreshold) {
                    refreshIcon.textContent = '🔄';
                }
            }
        }, { passive: true });

        document.addEventListener('touchend', () => {
            const pullDistance = touchEndY - touchStartY;
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            if (scrollTop === 0 && pullDistance >= pullThreshold) {
                // Trigger refresh
                pullToRefreshEl.classList.remove('pulling');
                pullToRefreshEl.classList.add('refreshing');
                refreshIcon.textContent = '⟳';

                // Reload page after 1 second
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                pullToRefreshEl.classList.remove('pulling');
                refreshIcon.textContent = '↓';
            }

            touchStartY = 0;
            touchEndY = 0;
        }, { passive: true });

        // ========================================================================
        // PERFORMANCE OPTIMIZATION - LAZY LOADING FOR VIDEOS
        // ========================================================================

        // Intersection Observer for lazy loading video iframes
        const videoObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const iframe = entry.target;
                    const dataSrc = iframe.getAttribute('data-src');
                    if (dataSrc) {
                        iframe.setAttribute('src', dataSrc);
                        iframe.removeAttribute('data-src');
                        videoObserver.unobserve(iframe);
                    }
                }
            });
        }, {
            rootMargin: '50px', // Load 50px before entering viewport
            threshold: 0.1
        });

        // Initialize lazy loading for all video iframes
        function initLazyLoadVideos() {
            const iframes = document.querySelectorAll('iframe[data-src]');
            iframes.forEach(iframe => {
                videoObserver.observe(iframe);
            });
        }

        // Call on DOMContentLoaded
        window.addEventListener('DOMContentLoaded', initLazyLoadVideos);

        // ========================================================================
        // PERFORMANCE OPTIMIZATION - ENHANCED TOUCH GESTURES
        // ========================================================================

        // Swipe gestures for tab navigation (mobile only)
        const tabOrder = ['dashboard', 'entry', 'sessions', 'analytics', 'videos', 'history', 'hrmonitor', 'education'];
        let swipeStartX = 0;
        let swipeStartTime = 0;
        const swipeThreshold = 80;
        const swipeTimeLimit = 300;

        function getCurrentTabIndex() {
            const activeTab = document.querySelector('.tab-content.active');
            return activeTab ? tabOrder.indexOf(activeTab.id) : 0;
        }

        document.addEventListener('touchstart', (e) => {
            swipeStartX = e.touches[0].clientX;
            swipeStartTime = Date.now();
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            const swipeEndX = e.changedTouches[0].clientX;
            const swipeEndTime = Date.now();
            const swipeDistance = swipeEndX - swipeStartX;
            const swipeDuration = swipeEndTime - swipeStartTime;

            // Only process if quick swipe and not on input field
            if (swipeDuration < swipeTimeLimit && !e.target.matches('input, textarea, select')) {
                if (Math.abs(swipeDistance) > swipeThreshold) {
                    const currentIndex = getCurrentTabIndex();

                    // Swipe right - previous tab
                    if (swipeDistance > 0 && currentIndex > 0) {
                        switchTab(tabOrder[currentIndex - 1]);
                    }
                    // Swipe left - next tab
                    else if (swipeDistance < 0 && currentIndex < tabOrder.length - 1) {
                        switchTab(tabOrder[currentIndex + 1]);
                    }
                }
            }
        }, { passive: true });

        // ========================================================================
        // PERFORMANCE OPTIMIZATION - DEBOUNCED INPUT
        // ========================================================================

        // Debounce function for input fields to reduce excessive processing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Apply debouncing to all input fields for auto-save
        window.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                // Debounce input events to 500ms
                input.addEventListener('input', debounce((e) => {
                    // Original input handling here
                    console.log('Debounced input:', e.target.id);
                }, 500));
            });
        });

        console.log('✅ Performance optimizations loaded: Lazy loading, swipe gestures, debounced inputs');
    </script>

    <!-- INSTALL APP PROMPT -->
    <div id="installPrompt" class="install-prompt">
        <div class="install-prompt-content">
            <div class="install-prompt-title">📱 Install Cardiac Recovery Pro</div>
            <div class="install-prompt-text">Add to your home screen for quick access and offline use</div>
        </div>
        <div class="install-prompt-buttons">
            <button class="install-btn" onclick="installApp()">Install</button>
            <button class="dismiss-btn" onclick="dismissInstallPrompt()">Not Now</button>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION (Mobile Only) -->
    <nav class="bottom-nav" role="navigation" aria-label="Mobile bottom navigation">
        <div class="bottom-nav-item active" onclick="switchTab('dashboard')" id="bottomNav-dashboard">
            <div class="bottom-nav-icon">📊</div>
            <div class="bottom-nav-label">Dashboard</div>
        </div>
        <div class="bottom-nav-item" onclick="switchTab('entry')" id="bottomNav-entry">
            <div class="bottom-nav-icon">📝</div>
            <div class="bottom-nav-label">Entry</div>
        </div>
        <div class="bottom-nav-item" onclick="switchTab('analytics')" id="bottomNav-analytics">
            <div class="bottom-nav-icon">📈</div>
            <div class="bottom-nav-label">Analytics</div>
        </div>
        <div class="bottom-nav-item" onclick="switchTab('videos')" id="bottomNav-videos">
            <div class="bottom-nav-icon">🎥</div>
            <div class="bottom-nav-label">Videos</div>
        </div>
        <div class="bottom-nav-item" onclick="switchTab('hrmonitor')" id="bottomNav-hrmonitor">
            <div class="bottom-nav-icon">❤️</div>
            <div class="bottom-nav-label">Monitor</div>
        </div>
    </nav>
</body>
</html>
